<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#FF3D7F" />
  <title>BasketBurst</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

  <style>
    :root{
      --pink:#FF3D7F;          /* Burst Pink */
      --purple:#6C2BFF;        /* Electric Purple */
      --aqua:#00D4FF;          /* Aqua Pop */
      --mango:#FFC542;         /* Sunny Mango */
      --mint:#2EE59D;          /* Mint Lift */
      --ink:#0F172A;           /* Ink text */
      --slate:#475569;         /* Secondary text */
      --cloud:#F6F7FB;         /* Background */
      --card:#FFFFFF;          /* Surface */
      --divider:#E6E8F0;
      --shadow: 0 10px 24px rgba(15,23,42,.08);
      --radius: 18px;
      --radius-sm: 14px;
      --tabbar-h: 72px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
      --tap: 44px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(0,212,255,.18), transparent 55%),
                  radial-gradient(1200px 800px at 90% 0%, rgba(255,61,127,.18), transparent 60%),
                  var(--cloud);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{color:inherit}
    button, input, select, textarea{font:inherit}
    .app{
      min-height:100%;
      padding-bottom: calc(var(--tabbar-h) + var(--safe-b));
    }
    /* Header */
    .header{
      position: sticky;
      top:0;
      z-index: 20;
      padding: calc(14px + var(--safe-t)) 14px 12px;
      backdrop-filter: blur(10px);
      background: linear-gradient(135deg, rgba(255,61,127,.92), rgba(108,43,255,.86));
      color: #fff;
      box-shadow: 0 8px 24px rgba(15,23,42,.12);
    }
    .header-row{display:flex; align-items:center; gap:10px;}
    .brand{
      display:flex; flex-direction:row; align-items:center; gap:10px;
      line-height:1.1; min-width:0;
    }
    .brand-icon{
      width:34px; height:34px; border-radius: 12px;
      box-shadow: var(--shadow);
      background:#fff;
    }
    .brand-text{ display:flex; flex-direction:column; min-width:0; }

    .brand .name{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
    }
    .brand .tag{
      font-size: 12.5px;
      opacity: .9;
    }
    .pill{
      margin-left:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      font-size: 12px;
      white-space: nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background: rgba(255,255,255,.85)}
    .pill.good .dot{background: var(--mint)}
    .pill.warn .dot{background: var(--mango)}
    .pill.bad  .dot{background: #ff7a7a}
    .context{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .context-card{
      flex:1;
      min-width: 150px;
      padding: 10px 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
    }
    .context-card .k{font-size:11.5px;opacity:.85}
    .context-card .v{font-size:14px;font-weight:700;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    /* Main */
    .main{padding: 14px; max-width: 560px; margin: 0 auto;}
    .card{
      background: var(--card);
      border: 1px solid var(--divider);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 12px 0;
    }
    .card.flat{box-shadow:none}
    .row{display:flex; gap:10px; align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grow{flex:1; min-width:0}
    .h1{font-size:16px; font-weight:800; margin:0 0 6px}
    .muted{color:var(--slate); font-size:13px}
    .sep{height:1px; background: var(--divider); margin: 12px 0}
    .btn{
      appearance:none;
      border:none;
      border-radius: 999px;
      padding: 12px 14px;
      min-height: var(--tap);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
      transform: translateZ(0);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{background: linear-gradient(135deg, var(--pink), var(--purple)); color:#fff}
    .btn.secondary{background: rgba(108,43,255,.12); color: var(--purple); border:1px solid rgba(108,43,255,.18); box-shadow:none}
    .btn.ghost{background: transparent; color: var(--ink); border: 1px solid var(--divider); box-shadow:none}
    .btn.danger{background: rgba(255,61,127,.12); color: var(--pink); border:1px solid rgba(255,61,127,.18); box-shadow:none}
    .btn.small{padding:9px 12px; font-size: 13px}
    .input, .select{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--divider);
      padding: 12px 12px;
      min-height: var(--tap);
      outline: none;
      background:#fff;
    }
    .input:focus, .select:focus{border-color: rgba(108,43,255,.45); box-shadow: 0 0 0 4px rgba(108,43,255,.12)}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding: 8px 10px;border-radius:999px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(0,212,255,.10);
      font-weight: 700;
      font-size: 12.5px;
      color: var(--ink);
    }
    .chip .sw{width:10px;height:10px;border-radius:50%; background: var(--aqua)}
    .list{
      display:flex; flex-direction: column; gap:10px;
    }
    .item{
      display:flex; align-items:center; gap:10px;
      padding: 12px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--divider);
      background: #fff;
    }
    .item .title{font-weight:800}
    .item .sub{font-size:12.5px; color: var(--slate)}
    .badge{
      margin-left:auto;
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(46,229,157,.14);
      color: #0B3D2B;
      border: 1px solid rgba(46,229,157,.18);
      white-space: nowrap;
    }
    .badge.owner{background: rgba(255,197,66,.18); border-color: rgba(255,197,66,.22); color:#5B3A00}
    /* Panels */
    .panel{display:none}
    .panel.active{display:block}
    /* Bottom tabs */
    .tabbar{
      position: fixed;
      left:0; right:0; bottom:0;
      height: calc(var(--tabbar-h) + var(--safe-b));
      padding: 10px 12px calc(10px + var(--safe-b));
      background: rgba(246,247,251,.86);
      backdrop-filter: blur(14px);
      border-top: 1px solid rgba(15,23,42,.08);
      z-index: 30;
    }
    .tabs{
      max-width: 560px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }
    .tab{
      border:none;
      background: transparent;
      padding: 8px 6px;
      border-radius: 16px;
      min-height: 52px;
      cursor:pointer;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 4px;
      color: var(--slate);
      transition: transform .12s ease, background .12s ease, color .12s ease;
    }
    .tab:active{transform: scale(.98)}
    .tab svg{width:22px;height:22px}
    .tab.active{
      background: rgba(108,43,255,.10);
      color: var(--purple);
    }
    .tab.active svg{filter: drop-shadow(0 8px 18px rgba(108,43,255,.18))}
    .tab .lbl{font-size: 11px; font-weight: 800}
    /* Modal */
    .modal-backdrop{
      position: fixed; inset:0;
      background: rgba(15,23,42,.42);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 14px calc(18px + var(--safe-b));
      z-index: 40;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width: min(560px, 100%);
      max-height: calc(100vh - 24px);
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 24px 60px rgba(15,23,42,.22);
      overflow:hidden;
      transform: translateY(14px);
      animation: slideUp .18s ease-out forwards;
    }
    @keyframes slideUp{
      to{transform: translateY(0)}
    }
    .modal .mhead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; gap:10px;
      border-bottom: 1px solid var(--divider);
      background: radial-gradient(900px 500px at 20% -30%, rgba(0,212,255,.14), transparent 60%),
                  radial-gradient(900px 500px at 90% -20%, rgba(255,61,127,.14), transparent 60%),
                  #fff;
    }
    .modal .mhead .mtitle{font-weight: 900}
    .modal .mbody{padding: 14px; max-height: calc(100vh - 220px); overflow:auto; -webkit-overflow-scrolling: touch}
    .modal .mfoot{
      padding: 12px 14px 14px;
      display:flex; gap:10px;
      border-top: 1px solid var(--divider);
      background:#fff;
    }
    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--tabbar-h) + 12px + var(--safe-b));
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      gap:10px;
      align-items:center;
      z-index: 50;
      max-width: min(560px, calc(100% - 24px));
    }
    .toast.show{display:flex; animation: pop .16s ease-out}
    @keyframes pop{
      from{transform: translateX(-50%) scale(.98); opacity:.0}
      to{transform: translateX(-50%) scale(1); opacity:1}
    }
    .toast button{
      border:none; background: rgba(255,255,255,.14);
      color:#fff; padding: 8px 10px; border-radius: 12px; font-weight: 800;
      cursor:pointer;
    }
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; animation:none !important}
    }
  
    /* Household selection + manage */
    .hhRow{gap:10px}
    .hhRow.selected{
      outline: 2px solid var(--pink);
      box-shadow: 0 0 0 6px rgba(255,61,127,.08), var(--shadow);
    }
    .iconBtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--divider);
      background: rgba(255,255,255,.7);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
      box-shadow:none;
      padding:0;
    }
    .iconBtn:active{transform: scale(.96)}
    .iconBtn svg{width:18px;height:18px}

    /* Forms (used heavily in modals) */
    .field{display:flex; flex-direction:column; gap:6px; margin:10px 0}
    .field label{font-size:12px; font-weight:900; color: var(--text2)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 420px){ .grid2{grid-template-columns:1fr} }
    input, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--divider);
      padding: 12px 12px;
      min-height: var(--tap);
      outline: none;
      background:#fff;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(255,61,127,.55);
      box-shadow: 0 0 0 4px rgba(255,61,127,.12);
    }
    textarea{min-height: 92px; resize: vertical}

    /* Picked items */
    .item.picked{
      border-color: rgba(54, 214, 142, .55);
      box-shadow: 0 0 0 6px rgba(54,214,142,.10), var(--shadow);
      background: linear-gradient(180deg, rgba(54,214,142,.10), rgba(255,255,255,.75));
    }
    .item.picked .title{ color: #0b6b3a; }
    .item.picked .sub{ color: rgba(11,107,58,.80); }

    /* Meals planner */
    .dayRow{ display:flex; align-items:center; gap:10px; padding: 12px; border: 1px solid var(--divider); border-radius: 18px; background: rgba(255,255,255,.8); }
    .dayLabel{ width: 78px; font-weight: 900; color: var(--text); }
    .dayLabel .sub{ font-size:12px; font-weight:800; color: var(--text2); margin-top:2px }
    .select{ width:100%; border-radius: 14px; border: 1px solid var(--divider); padding: 12px 12px; min-height: var(--tap); background:#fff; }
    .select:focus{ border-color: rgba(255,61,127,.55); box-shadow: 0 0 0 4px rgba(255,61,127,.12); outline:none; }

    /* Ingredient picker + meal tags */
    .pickCheck{ width:20px; height:20px; flex:0 0 auto; }
    .mealTag{
      display:inline-flex; align-items:center;
      padding:4px 8px; border-radius:999px;
      background: rgba(255,197,66,.25);
      border: 1px solid rgba(255,197,66,.55);
      color:#5A3A00;
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }
    .mealTagWrap{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px; }

    /* Meals library layout (mobile-friendly) */
    .mealItem{ flex-wrap:wrap; align-items:flex-start; gap:10px; }
    .mealItem .grow{ min-width: 160px; }
    .mealActions{ display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .mealActions .btn, .mealActions .iconBtn{ flex:0 0 auto; }
    @media (max-width: 420px){
      .mealItem .grow{ flex: 1 1 100%; }
      .mealActions{ width:100%; justify-content:flex-start; }
    }


    /* Build prompts (room checks) */
    .promptGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 420px){ .promptGrid{grid-template-columns:1fr} }
    .promptCard{
      text-align:left;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(15,23,42,.10);
      padding: 12px 12px;
      background: linear-gradient(135deg, rgba(255,61,127,.14), rgba(0,212,255,.12));
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
      min-height: 64px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .promptCard:active{transform: scale(.98)}
    .promptCard:hover{filter: brightness(1.02)}
    .promptIcon{
      width:44px;height:44px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(255,197,66,.22);
      border: 1px solid rgba(255,197,66,.35);
      font-size: 22px;
      flex:0 0 auto;
    }
    .promptMeta .ptitle{font-weight:900; letter-spacing:-0.2px}
    .promptMeta .psub{font-size:12.5px; color: var(--slate); margin-top:2px}
    .btnIconOnly{padding: 10px 12px}

  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="header-row">
        <div class="brand">
          <img class="brand-icon" src="favicon.svg" alt="" aria-hidden="true">
          <div class="brand-text">
            <div class="name">BasketBurst</div>
            <div class="tag">A brighter way to shop.</div>
          </div>
        </div>
        <div id="syncPill" class="pill warn" title="Sync status">
          <span class="dot"></span>
          <span id="syncText">Sync • Signed out</span>
        </div>
      </div>
      <div class="context">
        <div class="context-card">
          <div class="k">Household</div>
          <div id="ctxHousehold" class="v">—</div>
        </div>
        <div class="context-card">
          <div class="k">Current list</div>
          <div id="ctxList" class="v">—</div>
        </div>
      </div>
    </header>

    <main class="main">
      <!-- LISTS -->
      <section id="panel-lists" class="panel active">
        <div class="card">
          <div class="h1">Lists</div>
          <div class="muted">Weekly shop and any one-off lists you create.</div>
          <div class="sep"></div>
          <div id="listsEmpty" class="muted">Select a household to get started.</div>
          <div id="listsWrap" class="list" style="display:none"></div>
          <div class="sep"></div>
          <div class="row wrap">
            <button class="btn primary" id="btnNewList" type="button">New list</button>
            <button class="btn secondary" id="btnOpenWeekly" type="button">Start Your Weekly shop</button>
            <button class="btn ghost" id="btnToggleArchivedLists" type="button">Show archived</button>
          </div>
        </div>
      </section>

      <!-- BUILD -->
      <section id="panel-build" class="panel">
        <div class="card">
          <div class="h1">Build</div>
          <div class="muted">Add items to your current list. Weekly template lives in Account → Setup.</div>
          <div class="sep"></div>

          <div id="buildEmpty" class="muted">Select a household and a list to start building.</div>

          <div id="buildWrap" style="display:none">
            <div class="row" style="align-items:flex-end">
              <div class="grow">
                <div class="h1" style="font-size:16px; margin:0">Current list</div>
                <div id="buildCurrentList" class="muted" style="margin-top:6px">—</div>
              </div>
              <button class="btn primary" id="btnAddItem" type="button">Add item</button>
            </div>

            <div class="sep"></div>


            <div class="card" id="buildPromptsCard" style="display:none">
              <div class="row" style="align-items:flex-start">
                <div class="grow">
                  <div class="h1" style="font-size:16px; margin:0">Quick checks</div>
                  <div class="muted" style="margin-top:6px">Tap a room and add the bits people forget — make list-building feel lighter.</div>
                </div>
              </div>
              <div class="sep"></div>
              <div id="promptGrid" class="promptGrid"></div>
            </div>

            <div class="row wrap" style="justify-content:space-between">
              <div class="muted">Items</div>
              <button class="btn ghost" id="btnTogglePicked" type="button">Show picked</button>
            </div>
            <div class="sep"></div>

            <div id="itemsEmpty" class="muted">No items yet. Add your first item.</div>
            <div id="itemsWrap" class="list" style="display:none"></div>
          </div>
        </div>
      </section>

      <!-- MEALS -->
      <section id="panel-meals" class="panel">
        <div class="card">
          <div class="row" style="align-items:flex-end">
            <div class="grow">
              <div class="h1">Next week</div>
              <div class="muted">Evening meals (Mon–Sun), planned ahead.</div>
            </div>
            <div class="row" style="gap:8px; align-items:center; justify-content:flex-end">
              <button class="btn danger small" id="btnTogglePlanner" type="button" aria-label="Minimise planner">–</button>
              <div class="badge" id="mealsWeekKey">—</div>
            </div>
          </div>
          <div class="sep"></div>

          <div id="mealsPlannerEmpty" class="muted">Select a household to plan meals.</div>

          <div id="mealsPlannerWrap" style="display:none">
            <div id="plannerBody">
            <div id="plannerDays" class="list"></div>
            <div class="sep"></div>
            <div class="row" style="gap:10px; justify-content:flex-end">
              <button class="btn secondary" id="btnClearWeek" type="button">Clear week</button>
              <button class="btn primary" id="btnAddWeekToShop" type="button">Add Weekly Shop</button>
            </div>
          
          </div>
        </div>
        </div>

        <div class="card">
          <div class="row" style="align-items:flex-end">
            <div class="grow">
              <div class="h1">Meals</div>
              <div class="muted">Store your regulars and re‑use them any time.</div>
            </div>
            <button class="btn primary" id="btnNewMeal" type="button">New meal</button>
          </div>
          <div class="sep"></div>

          <div class="field" style="margin:0">
            <input id="mealSearch" placeholder="Search meals…" />
          </div>

          <div class="sep"></div>

          <div id="mealsEmpty" class="muted">No meals yet. Add one to get started.</div>
          <div id="mealsWrap" class="list" style="display:none"></div>
        </div>
      </section>

      <!-- SHOP -->
      <section id="panel-shop" class="panel">
        <div id="shopEmpty" class="card">
          <div class="h1">Shop</div>
          <div class="muted">Start a shop session to tick items off in-store, capture costs, and build a basket total.</div>
          <div class="sep"></div>
          <div class="muted">Select a list in the Lists tab to begin.</div>
        </div>

        <div id="shopWrap" style="display:none">
          <div class="card">
            <div class="row between">
              <div>
                <div class="h1">Shopping mode</div>
                <div class="muted">List: <span id="shopCurrentList">—</span></div>
              </div>
              <div class="pill" id="shopStatusPill">Not started</div>
            </div>

            <div class="sep"></div>

            <div class="grid2">
              <div class="card" style="padding:10px">
                <div class="muted" style="font-weight:800">Basket total</div>
                <div class="h1" id="shopBasketTotal" style="margin-top:4px">£0.00</div>
                <div class="muted" id="shopUnpriced" style="margin-top:2px"></div>
              </div>
              <div class="card" style="padding:10px">
                <div class="muted" style="font-weight:800">Shop time</div>
                <div class="h1" id="shopTimer" style="margin-top:4px">00:00:00</div>
                <div class="muted" id="shopStartedAt" style="margin-top:2px"></div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row gap" style="flex-wrap:wrap">
              <button class="btn primary" id="btnStartShop" type="button">Start shop</button>
              <button class="btn primary" id="btnCompleteShop" type="button" style="display:none">Complete shop</button>
              <button class="btn danger" id="btnResetShop" type="button" style="display:none">Reset shop</button>
              <button class="btn secondary" id="btnQuickAddShop" type="button">Quick add</button>
              <button class="btn ghost" id="btnShopTogglePicked" type="button">Show picked</button>
                          <button class="btn ghost" id="btnShopHistory" type="button">Previous shops</button>
            </div>
          </div>

          <div id="shopMainView">
            <div class="card">
              <div id="shopItemsEmpty" class="muted">No items to shop. Add items in Build.</div>
              <div id="shopItemsWrap" class="list" style="display:none"></div>
            </div>
          </div>

          <div id="shopHistoryView" style="display:none">
            <div class="card">
              <div class="row between">
                <button class="btn ghost" id="btnShopHistoryBack" type="button">← Back</button>
                <div class="h1" style="margin:0">Previous shops</div>
              </div>
              <div class="sep"></div>
              <div id="shopHistoryEmpty" class="muted">No completed shops yet.</div>
              <div id="shopHistoryList" class="list" style="display:none"></div>
            </div>
          </div>

          <div id="shopDetailView" style="display:none">
            <div class="card">
              <div class="row between">
                <button class="btn ghost" id="btnShopDetailBack" type="button">← Back</button>
                <div class="h1" style="margin:0">Shop details</div>
              </div>
              <div class="sep"></div>
              <div id="shopDetailSummary"></div>
              <div class="sep"></div>
              <div class="row gap" style="flex-wrap:wrap">
                <button class="btn ghost" id="btnShopDetailToggleAll" type="button">Show all items</button>
                <button class="btn danger" id="btnDeleteShopRecord" type="button">Delete record</button>
              </div>
              <div class="sep"></div>
              <div id="shopDetailItems" class="list"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- ACCOUNT -->
      <section id="panel-account" class="panel">
        <div class="card">
          <div class="h1">Account</div>
          <div id="authState" class="muted">Sign in to sync across devices.</div>
          <div class="sep"></div>

          <div id="signedOutBlock">
            <button class="btn primary" id="btnGoogle" type="button">
              <span>Continue with Google</span>
            </button>
          </div>

          <div id="signedInBlock" style="display:none">
            <div class="row wrap">
              <div class="chip" title="Signed in user">
                <span class="sw" style="background:var(--mint)"></span>
                <span id="userLabel">Signed in</span>
              </div>
              <button class="btn danger" id="btnSignOut" type="button">Sign out</button>
            </div>

            <div class="sep"></div>

            <div class="h1" style="font-size:15px">Households</div>
            <div class="muted">These are linked to your account and available on any device.</div>
            <div class="sep"></div>

            <div id="hhEmpty" class="muted">No households yet. Create one or join with an invite code.</div>
            <div id="hhList" class="list" style="display:none"></div>

            <div class="sep"></div>
            <div class="row wrap">
              <button class="btn primary" id="btnCreateHousehold" type="button">Create household</button>
              <button class="btn secondary" id="btnJoinHousehold" type="button">Join with code</button>
            </div>


<div class="sep"></div>
            <div class="h1" style="font-size:15px">Setup</div>
            <div class="muted">Set up your shop journey (categories) and Weekly Shop template.</div>
            <div class="sep"></div>

            <div id="setupBlock" class="muted">Select a household to manage setup.</div>

            <div id="setupWrap" style="display:none">
              <div class="h1" style="font-size:15px">Categories</div>
              <div class="muted">Controls the order you’ll see items in Shopping Mode.</div>
              <div class="sep"></div>
              <div id="catsWrap" class="list"></div>
              <div class="sep"></div>
              <div class="row wrap">
                <button class="btn secondary" id="btnAddCategory" type="button">Add category</button>
              </div>

              <div class="sep"></div>
              <div class="h1" style="font-size:15px">Weekly template</div>
              <div class="muted">These items come back every week when you reset.</div>
              <div class="sep"></div>
              <div id="tplEmpty" class="muted">No template items yet. Add your regulars (e.g., milk, bread).</div>
              <div id="tplWrap" class="list" style="display:none"></div>
              <div class="sep"></div>
              <div class="row wrap">
                <button class="btn primary" id="btnAddTplItem" type="button">Add Template Item</button>
                <button class="btn secondary" id="btnResetWeeklyNow" type="button">Reset Weekly Shop</button>
                <button class="btn ghost" id="btnTestWeeklyPrompt" type="button">Test Monday Reset Prompt</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom tabs -->
  <nav class="tabbar" aria-label="Primary">
    <div class="tabs">
      <button class="tab active" data-tab="lists" type="button" aria-label="Lists">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 6h14M7 12h14M7 18h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M3.5 6h.01M3.5 12h.01M3.5 18h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
        </svg>
        <div class="lbl">Lists</div>
      </button>
      <button class="tab" data-tab="build" type="button" aria-label="Build">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <div class="lbl">Build</div>
      </button>
      <button class="tab" data-tab="meals" type="button" aria-label="Meals">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <!-- Fork -->
          <path d="M6 3v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M9 3v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7.5 3v8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 7.5h3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7.5 11v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <!-- Knife -->
          <path d="M14 3c2.5 2.2 2.5 6.2 0 8.4V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M14 11.4c2.2-.2 4-2 4-4.2 0-2.1-1.8-3.9-4-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
</svg>
        <div class="lbl">Meals</div>
      </button>
      <button class="tab" data-tab="shop" type="button" aria-label="Shop">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 7h15l-2 10H8L6 7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M6 7 5 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M9 21a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM18 21a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" stroke="currentColor" stroke-width="2"/>
        </svg>
        <div class="lbl">Shop</div>
      </button>
      <button class="tab" data-tab="account" type="button" aria-label="Account">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2"/>
          <path d="M4 20c1.6-3.2 5-5 8-5s6.4 1.8 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <div class="lbl">Account</div>
      </button>
    </div>
  </nav>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="mhead">
        <div class="mtitle" id="modalTitle">Modal</div>
        <div class="grow"></div>
        <button class="btn ghost small" id="modalClose" type="button">Close</button>
      </div>
      <div class="mbody" id="modalBody"></div>
      <div class="mfoot" id="modalFoot"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <div id="toastText" class="grow"></div>
    <button id="toastBtn" type="button" style="display:none">Undo</button>
  </div>

  <script type="module">
    // Firebase (modular SDK)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp,
      onSnapshot, query, orderBy, where, limit, getDocs, writeBatch, updateDoc, deleteDoc, deleteField, documentId, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // === Firebase config (provided by Rich) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDYuFW5jUL8JkL_RUPAz5Nv4AZ-Uui5C64",
      authDomain: "basketburst-shopping-app.firebaseapp.com",
      projectId: "basketburst-shopping-app",
      storageBucket: "basketburst-shopping-app.firebasestorage.app",
      messagingSenderId: "785037059249",
      appId: "1:785037059249:web:0a6c8e8fdb35ff8704ee90",
      measurementId: "G-35GZJSNMWN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === UI helpers ===
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const syncPill = $("#syncPill");
    const syncText = $("#syncText");
    const ctxHousehold = $("#ctxHousehold");
    const ctxList = $("#ctxList");

    // Quick switchers (header context)
    try{
      const houseCard = ctxHousehold?.closest(".context-card");
      if(houseCard){
        houseCard.style.cursor = "pointer";
        houseCard.title = "Switch household";
        houseCard.addEventListener("click", ()=> openHouseholdPicker());
      }else{
        ctxHousehold.style.cursor = "pointer";
        ctxHousehold.title = "Switch household";
        ctxHousehold.addEventListener("click", ()=> openHouseholdPicker());
      }
    }catch{}
    try{
      const listCard = ctxList?.closest(".context-card");
      if(listCard){
        listCard.style.cursor = "pointer";
        listCard.title = "Switch list";
        listCard.addEventListener("click", ()=> openListPicker());
      }else{
        ctxList.style.cursor = "pointer";
        ctxList.title = "Switch list";
        ctxList.addEventListener("click", ()=> openListPicker());
      }
    }catch{}

    function setSync(text, kind="warn"){
      syncText.textContent = text;
      syncPill.classList.remove("good","warn","bad");
      syncPill.classList.add(kind);
    }

    // Toast
    let toastTimer = null;
    function toast(msg, {actionText=null, onAction=null, ms=2600}={}){
      const el = $("#toast");
      $("#toastText").textContent = msg;
      const btn = $("#toastBtn");
      btn.style.display = actionText ? "inline-flex" : "none";
      btn.textContent = actionText || "";
      btn.onclick = null;
      if(onAction) btn.onclick = ()=>{ try{onAction()}finally{hideToast()} };
      el.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(hideToast, ms);
    }
    function hideToast(){
      $("#toast").classList.remove("show");
      $("#toastBtn").onclick = null;
    }

    // Modal
    function showModal({title, body, footerButtons=[]}){
      // Accessibility: remember focus so we can restore it when the modal closes
      state.lastFocusEl = document.activeElement;
      $("#modalTitle").textContent = title || " ";
      const bodyEl = $("#modalBody");
      bodyEl.innerHTML = "";
      if(typeof body === "string"){
        bodyEl.innerHTML = body;
      }else if(body instanceof Node){
        bodyEl.appendChild(body);
      }
      const foot = $("#modalFoot");
      foot.innerHTML = "";
      for(const b of footerButtons){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn " + (b.className || "ghost");
        btn.textContent = b.label;
        btn.onclick = async ()=>{
          try{
            const res = await (b.onClick?.());
            if(res !== false) hideModal();
          }catch(e){
            console.error(e);
            toast(e?.message || "Something went wrong", {ms: 3200});
          }
        };
        foot.appendChild(btn);
      }
      $("#modalBackdrop").classList.add("show");
      $("#modalBackdrop").setAttribute("aria-hidden","false");
    }
    function hideModal(){
      // Accessibility: move focus out of the modal before hiding it
      const root = $("#modalBackdrop");
      const active = document.activeElement;
      if(root && active && root.contains(active)){
        try{ active.blur(); }catch{}
      }

      root.classList.remove("show");
      root.setAttribute("aria-hidden","true");

      try{ stopHouseholdSettingsListeners?.(); }catch{}

      // Restore focus to what was focused before opening the modal (if still in DOM)
      const prev = state.lastFocusEl;
      state.lastFocusEl = null;
      if(prev && document.contains(prev)){
        setTimeout(()=>{ try{ prev.focus(); }catch{} }, 0);
      }
    }

    
    async function showChoiceModal({title, message, options=[], cancelLabel="Cancel"}){
      return new Promise((resolve)=>{
        showModal({
          title,
          body: `<div class="muted" style="line-height:1.35">${escapeHtml(message||"")}</div>`,
          footerButtons: [
            { label: cancelLabel, className: "ghost", onClick: ()=>{ resolve(null); } },
            ...options.map(o=>({
              label: o.label,
              className: o.className || "secondary",
              onClick: ()=>{ resolve(o.key); }
            }))
          ]
        });
      });
    }

async function confirmModal({title="Confirm", message="", confirmLabel="OK", cancelLabel="Cancel", confirmClass="primary", cancelClass="ghost"}={}){
      return new Promise((resolve)=>{
        let done = false;
        const safeResolve = (v)=>{ if(done) return; done = true; resolve(v); };
        showModal({
          title,
          body: `<div class="muted">${escapeHtml(String(message || ""))}</div>`,
          footerButtons: [
            { label: cancelLabel, className: "btn " + cancelClass, onClick: ()=> safeResolve(false) },
            { label: confirmLabel, className: "btn " + confirmClass, onClick: ()=> safeResolve(true) }
          ]
        });
      });
    }

    $("#modalClose").addEventListener("click", hideModal);$("#modalClose").addEventListener("click", hideModal);
    $("#modalBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="modalBackdrop") hideModal(); });

    // Tabs
    function setTab(name){
      $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
      $$(".panel").forEach(p=>p.classList.remove("active"));
      $("#panel-"+name).classList.add("active");
      if(name==="build") renderBuild();
        try{ renderShop(); }catch{}
      if(name==="meals"){ attachMealsListeners(); renderMeals(); }
      if(name==="shop"){ renderShop(); }
    }
    $$(".tab").forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));

    // === App state ===
    const state = {
      user: null,
      households: [], // from users/{uid}/households
      selectedHouseholdId: localStorage.getItem("bb.selectedHouseholdId") || null,
      selectedHouseholdName: null,
      selectedRole: null,
      unsubHouseholds: null,
      unsubHouseholdDoc: null,
      unsubLists: null,
      lists: []
   ,
      categories: [],
      config: null,
      unsubCategories: null,
      unsubConfig: null,
      unsubItems: null,
      unsubMeals: null,
      unsubMealPlan: null,
      meals: [],
      mealPlan: { assignments: {} },
      mealsWeekKey: null,
      items: [],
      showPicked: false,
            shopShowPicked: (localStorage.getItem("bb.shopShowPicked")==="1"),
      activeShop: null,
      shopTick: null,
      shopView: "main",
      shopHistory: [],
      shopDetail: null,
      shopDetailShowAll: false,
lastFocusEl: null,
      showArchivedLists: (localStorage.getItem("bb.showArchivedLists")==="1")
    };

    function setCtx(){
      ctxHousehold.textContent = state.selectedHouseholdName || "—";
      const currentList = state.lists.find(l=> l.id === getCurrentListId()) || null;
      ctxList.textContent = currentList ? currentList.name : "—";
    }

    function getCurrentListId(){
      return localStorage.getItem("bb.currentListId") || null;
    }
    function setCurrentListId(id){
      if(id) localStorage.setItem("bb.currentListId", id);
      else localStorage.removeItem("bb.currentListId");
      setCtx();
      try{ renderLists(); }catch{}
      try{ attachItemsListener(); }catch{}
      try{ renderBuild(); }catch{}
      try{ renderShop(); }catch{}
      try{ renderMeals(); }catch{}
    }
    function openHouseholdPicker(){
      if(!state.user) return;
      const items = (state.households || []).slice().sort((a,b)=>String(a.householdName||"").localeCompare(String(b.householdName||"")));
      const body = document.createElement("div");
      body.className = "list";
      for(const h of items){
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `<div class="grow"><div class="title">${escapeHtml(h.householdName||"Household")}</div><div class="sub">${escapeHtml(h.role||"member")}</div></div>`;
        row.addEventListener("click", ()=>{ hideModal(); selectHousehold(h.householdId); });
        body.appendChild(row);
      }
      showModal({ title:"Switch household", body, footerButtons:[{label:"Close", className:"ghost"}] });
    }

    function openListPicker(){
      const lists = (state.lists || []).filter(l=>!l.archived);
      const body = document.createElement("div");
      body.className = "list";
      for(const l of lists){
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `<div class="grow"><div class="title">${escapeHtml(l.name || (l.type==="weekly"?"Weekly shop":"List"))}</div><div class="sub">${l.type==="weekly"?"Weekly":"Custom"}</div></div>`;
        row.addEventListener("click", ()=>{ hideModal(); setCurrentListId(l.id); });
        body.appendChild(row);
      }
      showModal({ title:"Switch list", body, footerButtons:[{label:"Close", className:"ghost"}] });
    }



    // === Auth UI ===
    const signedOutBlock = $("#signedOutBlock");
    const signedInBlock = $("#signedInBlock");
    const authState = $("#authState");
    const userLabel = $("#userLabel");

    $("#btnGoogle").addEventListener("click", async ()=>{
      const provider = new GoogleAuthProvider();
      setSync("Sync • Signing in…", "warn");
      await signInWithPopup(auth, provider);
    });

    $("#btnSignOut").addEventListener("click", async ()=>{
      await signOut(auth);
      toast("Signed out");
    });

    // === Firestore: households index ===
    function renderHouseholds(){
      const list = $("#hhList");
      const empty = $("#hhEmpty");
      list.innerHTML = "";

      if(!state.households.length){
        empty.style.display = "block";
        list.style.display = "none";
        return;
      }
      empty.style.display = "none";
      list.style.display = "flex";

      for(const h of state.households){
        const isSelected = h.householdId === state.selectedHouseholdId;
const el = document.createElement("div");
        el.className = "item hhRow" + (isSelected ? " selected" : "");
                const role = h.role || "member";

        el.innerHTML = `
          <div class="grow">
            <div class="title">${escapeHtml(h.householdName || "Household")}</div>
            <div class="sub">${escapeHtml(h.householdId)} • ${escapeHtml(role)}</div>
          </div>
          
          <button class="iconBtn" type="button" data-manage aria-label="Household settings" title="Household settings">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 15.6a3.6 3.6 0 1 0 0-7.2 3.6 3.6 0 0 0 0 7.2Z" stroke="currentColor" stroke-width="2"/>
              <path d="M19.4 13.2a7.9 7.9 0 0 0 0-2.4l2-1.5-2-3.4-2.4.8a8.3 8.3 0 0 0-2.1-1.2L14.4 2h-4.8l-.5 2.5c-.7.3-1.4.7-2.1 1.2l-2.4-.8-2 3.4 2 1.5a7.9 7.9 0 0 0 0 2.4l-2 1.5 2 3.4 2.4-.8c.7.5 1.4.9 2.1 1.2l.5 2.5h4.8l.5-2.5c.7-.3 1.4-.7 2.1-1.2l2.4.8 2-3.4-2-1.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="badge ${role==="owner" ? "owner":""}">${role==="owner" ? "Owner" : "Member"}</div>
        
        `;
        el.addEventListener("click", ()=> selectHousehold(h.householdId, {silent:true}));
        el.querySelector("[data-manage]")?.addEventListener("click", (e)=>{ e.stopPropagation(); openHouseholdSettings(h.householdId); });
        list.appendChild(el);
      }
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    // Safe for inserting into HTML attribute values (e.g., value="...")
    function escapeAttr(s){
      return escapeHtml(String(s ?? ""));
    }

    async function selectHousehold(hid, opts={}){
      state.selectedHouseholdId = hid;
      localStorage.setItem("bb.selectedHouseholdId", hid);
      setSync("Sync • Loading household…", "warn");
      await loadSelectedHousehold();
      renderHouseholds();
      if(!opts.silent) toast("Household selected");
    }

    async function openHouseholdSettings(hid){
      if(!state.user){
        toast("Please sign in first");
        setTab("account");
        return;
      }
      // Ensure selection is set, but keep the user on Account
      if(state.selectedHouseholdId !== hid){
        await selectHousehold(hid, {silent:true});
      }

      const role = state.selectedRole || "member";
      const hhName = state.selectedHouseholdName || "Household";

      // Clean up any previous settings listeners (if modal was left open somehow)
      stopHouseholdSettingsListeners();

      showModal({
        title: "Household settings",
        body: `
          <div class="card flat" style="margin:0">
            <div class="h1" style="margin:0">${escapeHtml(hhName)}</div>
            <div class="muted" style="margin-top:6px">${escapeHtml(hid)} • ${escapeHtml(role==="owner" ? "Owner" : "Member")}</div>
          </div>

          <div class="sep"></div>

          <div class="h1" style="font-size:15px">Members</div>
          <div class="muted">Who has access to this household.</div>
          <div class="sep"></div>
          <div id="hsMembersEmpty" class="muted">Loading members…</div>
          <div id="hsMembersList" class="list" style="display:none"></div>

          <div class="sep"></div>

          <div class="h1" style="font-size:15px">Invites</div>
          <div class="muted">Share a code so someone can join this household.</div>
          <div class="sep"></div>
          <div id="hsInvitesGuard" class="muted">Only the household owner can create invites.</div>
          <div id="hsInvitesBlock" style="display:none">
            <div id="hsInvitesEmpty" class="muted">No active invite codes.</div>
            <div id="hsInvitesList" class="list" style="display:none"></div>
            <div class="sep"></div>
            <div class="row wrap">
              <button class="btn primary" id="hsCreateInvite" type="button">Create invite code</button>
            </div>
          </div>
        `,
        footerButtons: [
          role==="owner"
            ? { label:"Close", className:"btn ghost" }
            : { label:"Leave household", className:"btn danger", onClick: async ()=>{
                showModal({
                  title: "Leave household?",
                  body: `<div class="muted">You will lose access to its lists, meals and settings.</div>`,
                  footerButtons: [
                    {label:"Cancel", className:"btn ghost"},
                    {label:"Leave", className:"btn danger", onClick: async ()=>{
                      setSync("Sync • Leaving household…", "warn");
                      await leaveHousehold(hid);
                      toast("Left household");
                    }}
                  ]
                });
                return false;
              }}
        ]
      });

      startHouseholdSettingsListeners(hid, role);
    }

    async function loadSelectedHousehold(){
      cleanupHouseholdSubs();
      state.selectedHouseholdName = null;
      state.selectedRole = null;
      state.lists = [];
      $("#listsWrap").style.display = "none";
      $("#listsEmpty").style.display = "block";
      $("#listsEmpty").textContent = "Loading lists…";
      setCtx();

      const hid = state.selectedHouseholdId;
      if(!state.user || !hid){
        setSync(state.user ? "Sync • Choose a household" : "Sync • Signed out", state.user ? "warn" : "bad");
        $("#listsEmpty").textContent = "Select a household to get started.";
        return;
      }

      // Find role/name from the per-user index (already in state.households)
      const idx = state.households.find(x=>x.householdId===hid) || null;
      state.selectedHouseholdName = idx?.householdName || "Household";
      state.selectedRole = idx?.role || "member";
      setCtx();

      // Listen to lists
      const listsQ = query(collection(db, "households", hid, "lists"), orderBy("pinned", "desc"), orderBy("updatedAt", "desc"));
      state.unsubLists = onSnapshot(listsQ, (snap)=>{
        state.lists = snap.docs.map(d=>({id:d.id, ...d.data()}));

        // On refresh / household switch, ensure the stored current list id is valid for this household.
        const curId = getCurrentListId();
        const cur = (state.lists || []).find(l=>l.id === curId) || null;
        const weekly = (state.lists || []).find(l=>l.type === "weekly" && !l.archived) || null;
        const firstActive = (state.lists || []).find(l=>!l.archived) || null;

        let nextId = curId;
        if(!cur || cur.archived){
          nextId = weekly?.id || firstActive?.id || null;
        }
        if(nextId !== curId){
          if(nextId) localStorage.setItem("bb.currentListId", nextId);
          else localStorage.removeItem("bb.currentListId");
          setCtx();
        }

        renderLists();
        attachItemsListener();
        setSync("Sync • Up to date", "good");
      }, (err)=>{
        console.error(err);
        setSync("Sync • Permission blocked", "bad");
        $("#listsEmpty").textContent = "Couldn’t load lists (permissions).";
      });

      // Meals (library + plan)
      attachMealsListeners();

// Listen to categories (ordered)
const catsQ = query(collection(db, "households", hid, "categories"), orderBy("order", "asc"));
state.unsubCategories = onSnapshot(catsQ, (snap)=>{
  state.categories = snap.docs
    .map(d=>({id:d.id, ...d.data()}))
    .filter(c=>!c.archived);
  renderSetup();
}, (err)=>{
  console.error(err);
  // Categories are non-blocking for list viewing; show a toast only once per session if needed
});

// Listen to household config (template etc.)
state.unsubConfig = onSnapshot(doc(db, "households", hid, "settings", "config"), (snap)=>{
  state.config = snap.exists() ? snap.data() : null;
  renderSetup();
}, (err)=>{
  console.error(err);
});

// Weekly reset check (Monday morning) after initial data is available
await loadActiveShopIfAny();
  try{ renderShop(); }catch{}
  scheduleWeeklyResetCheck();
    }

    function cleanupHouseholdSubs(){
  if(state.unsubLists){ try{state.unsubLists()}catch{} state.unsubLists=null; }
  if(state.unsubCategories){ try{state.unsubCategories()}catch{} state.unsubCategories=null; }
  if(state.unsubConfig){ try{state.unsubConfig()}catch{} state.unsubConfig=null; }
  state.categories = [];
  state.config = null;
  cleanupItemsSub();
  cleanupMealsSubs();
}


    function cleanupItemsSub(){
      if(state.unsubItems){ try{state.unsubItems()}catch{} state.unsubItems=null; }
      state.items = [];
    }

    function getCurrentList(){
      const id = getCurrentListId();
      return (state.lists || []).find(l=>l.id===id) || null;
    }

    function isWeeklyShopList(list){
      if(!list) return false;
      if(list.type === "weekly") return true;
      // Fallback for older data
      if(list.pinned === true && /weekly/i.test(list.name||"")) return true;
      return false;
    }

    function attachItemsListener(){
      cleanupItemsSub();
      if(!state.selectedHouseholdId) { renderBuild(); return; }
      const cur = getCurrentList();
      if(!cur){ renderBuild(); return; }

      const itemsCol = collection(db, "households", state.selectedHouseholdId, "lists", cur.id, "items");
      const qy = query(itemsCol, orderBy("createdAt", "asc"));
      state.unsubItems = onSnapshot(qy, (snap)=>{
        state.items = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderBuild();
        try{ renderShop(); }catch{}
        try{ renderShopHeaderOnly(); }catch{}
      }, (err)=>{
        console.error(err);
        toast("Couldn’t load items (permissions)", {ms:3200});
        state.items = [];
        renderBuild();
      });
    }

    function categoryLabel(id){
      if(!id) return "Uncategorised";
      const c = (state.categories || []).find(x=>x.id===id);
      return c ? c.name : "Uncategorised";
    }

    function fmtQty(it){
      const q = it.qty;
      const u = (it.unit || "").trim();
      if(q===null || q===undefined || q==="" || Number.isNaN(Number(q))) return u ? u : "";
      const qn = Number(q);
      if(!u) return String(qn);
      return `${qn} ${u}`;
    }

    
    // === Shop tab (shopping mode) ===
    function money(n){
      const v = Number(n);
      if(!Number.isFinite(v)) return "£0.00";
      return new Intl.NumberFormat("en-GB", {style:"currency", currency:"GBP"}).format(v);
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function fmtHMS(totalSeconds){
      const s = Math.max(0, Math.floor(totalSeconds||0));
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const ss = s%60;
      return `${pad2(h)}:${pad2(m)}:${pad2(ss)}`;
    }

    function getActiveShopKey(){
      return localStorage.getItem("bb.activeShopKey") || null;
    }
    function setActiveShopKey(key){
      if(key) localStorage.setItem("bb.activeShopKey", key);
      else localStorage.removeItem("bb.activeShopKey");
    }

    function getActiveShop(){
      return state.activeShop;
    }

    async function loadActiveShopIfAny(){
      state.activeShop = null;
      const key = getActiveShopKey();
      if(!key || !state.selectedHouseholdId) return;
      // key format: {householdId}:{listId}:{shopId}:{startedAtMs}
      const parts = key.split(":");
      if(parts.length < 4) { setActiveShopKey(null); return; }
      const [hid, listId, shopId, startedMs] = parts;
      if(hid !== state.selectedHouseholdId) return;
      state.activeShop = { householdId: hid, listId, shopId, startedAtMs: Number(startedMs)||Date.now(), excludedIds: [] };
      try{
        const snap = await getDoc(doc(db, "households", hid, "shops", shopId));
        if(snap.exists()){
          const d = snap.data() || {};
          if(d.status && d.status !== "active"){
            state.activeShop = null;
            setActiveShopKey(null);
          }else{
            if(Number.isFinite(Number(d.startedAtMs))) state.activeShop.startedAtMs = Number(d.startedAtMs);
            if(Array.isArray(d.excludedIds)) state.activeShop.excludedIds = d.excludedIds.slice();
          }
        }
      }catch(e){
        console.warn("Active shop load failed", e);
      }
    }

    function computeBasket(){
      const items = state.items || [];
      let total = 0;
      let unpriced = 0;
      for(const it of items){
        if(!it.picked) continue;
        const c = Number(it.pickedCost);
        if(Number.isFinite(c)) total += c;
        else unpriced += 1;
      }
      return { total, unpriced };
    }

    function ensureShopTimer(){
      if(state.shopTick) return;
      state.shopTick = setInterval(()=>{ try{ renderShopHeaderOnly(); }catch{} }, 1000);
    }

    function clearShopTimer(){
      if(state.shopTick){ clearInterval(state.shopTick); state.shopTick = null; }
    }

    function renderShopHeaderOnly(){
      const wrap = $("#shopWrap");
      if(!wrap || wrap.style.display==="none") return;

      const cur = getCurrentList();
      const shop = getActiveShop();
      const startBtn = $("#btnStartShop");
      const completeBtn = $("#btnCompleteShop");
      const resetBtn = $("#btnResetShop");
      const pill = $("#shopStatusPill");

      if(cur) $("#shopCurrentList").textContent = cur.name || (cur.type==="weekly" ? "Weekly shop" : "List");

      const { total, unpriced } = computeBasket();
      $("#shopBasketTotal").textContent = money(total);
      $("#shopUnpriced").textContent = unpriced ? `${unpriced} picked item${unpriced===1?"":"s"} without a cost` : "";

      if(shop && cur && shop.listId === cur.id){
        const elapsed = (Date.now() - (shop.startedAtMs||Date.now()))/1000;
        $("#shopTimer").textContent = fmtHMS(elapsed);
        $("#shopStartedAt").textContent = "In progress";
        pill.textContent = "In progress";
        pill.classList.remove("good");
        pill.classList.add("warn");
        startBtn.style.display = "none";
        completeBtn.style.display = "";
        if(resetBtn) resetBtn.style.display = "";
        ensureShopTimer();
      }else{
        $("#shopTimer").textContent = "00:00:00";
        $("#shopStartedAt").textContent = "";
        pill.textContent = "Not started";
        pill.classList.remove("warn");
        startBtn.style.display = "";
        completeBtn.style.display = "none";
        if(resetBtn) resetBtn.style.display = "none";
        clearShopTimer();
      }
    }

    function renderShop(){
      const empty = $("#shopEmpty");
      const wrap = $("#shopWrap");
      const itemsEmpty = $("#shopItemsEmpty");
      const itemsWrap = $("#shopItemsWrap");
      const toggleBtn = $("#btnShopTogglePicked");

      if(!state.user || !state.selectedHouseholdId){
        empty.style.display = "block";
        wrap.style.display = "none";
        return;
      }
      const cur = getCurrentList();
      if(!cur){
        empty.style.display = "block";
        const msgEl = empty.querySelector(".muted:last-child");
        if(msgEl) msgEl.textContent = "Select a list in the Lists tab to begin.";
        wrap.style.display = "none";
        return;
      }

      empty.style.display = "none";
      wrap.style.display = "block";

      if(toggleBtn){
        toggleBtn.textContent = state.shopShowPicked ? "Hide picked" : "Show picked";
      }

      renderShopHeaderOnly();

      const shop = getActiveShop();
      const excluded = new Set((shop && Array.isArray(shop.excludedIds)) ? shop.excludedIds : []);
      const visible = (state.items || []).filter(it=>{
        if(excluded.has(it.id)) return false;
        return state.shopShowPicked ? true : !it.picked;
      });
      itemsWrap.innerHTML = "";

      if(!visible.length){
        itemsEmpty.style.display = "block";
        itemsWrap.style.display = "none";
        itemsEmpty.textContent = state.shopShowPicked ? "No items yet." : "No unpicked items — toggle to show picked, or add more.";
        return;
      }

      itemsEmpty.style.display = "none";
      itemsWrap.style.display = "flex";

      // Group by category, uncategorised last
      const groups = new Map();
      for(const it of visible){
        const key = it.categoryId || "__uncat__";
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }
      const order = (state.categories || []).map(c=>c.id).filter(id=>groups.has(id));
      if(groups.has("__uncat__")) order.push("__uncat__");

      for(const catId of order){
        const header = document.createElement("div");
        header.className = "muted";
        header.style.margin = "10px 2px 6px";
        header.style.fontWeight = "800";
        header.textContent = catId==="__uncat__" ? "Uncategorised" : categoryLabel(catId);
        itemsWrap.appendChild(header);

        for(const it of groups.get(catId)){
          const row = document.createElement("div");
          row.className = "item" + (it.picked ? " picked" : "");
          const qtyTxt = fmtQty(it);
          const costTxt = Number.isFinite(Number(it.pickedCost)) ? ` • ${money(it.pickedCost)}` : (it.picked ? " • £—" : "");
          const pickedQtyTxt = it.picked && Number.isFinite(Number(it.pickedQty)) ? ` • Qty ${Number(it.pickedQty)}` : "";
          row.innerHTML = `
            <div class="grow">
              <div class="title">${escapeHtml(it.name || "Item")}</div>
              ${renderMealTags(it)}
              <div class="sub">${qtyTxt ? escapeHtml(qtyTxt) + " • " : ""}${escapeHtml(categoryLabel(it.categoryId))}${it.notes ? " • " + escapeHtml(it.notes) : ""}${it.picked ? " • Picked" + pickedQtyTxt + costTxt : ""}</div>
            </div>
            <button class="btn secondary small" type="button" data-toggle>${it.picked ? "Unpick" : "Pick"}</button>
            ${it.picked ? `<button class="btn ghost small" type="button" data-edit title="Edit quantity/cost">✎</button>` : ``}
            <button class="btn ghost small" type="button" data-skip>Skip</button>
          `;

          row.querySelector("[data-toggle]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const cur = getCurrentList();
            if(!cur) return;

            let shop = getActiveShop();
            if(!shop || shop.listId !== cur.id){
              const ok = await confirmModal({
                title: "Start shopping session?",
                message: "You need an active shopping session to pick items. Start now and pick this item?",
                confirmLabel: "Start shop & pick",
                confirmClass: "primary",
                cancelLabel: "Cancel"
              });
              if(!ok) return;
              await startShopSession({ skipConfirm: true });
              shop = getActiveShop();
              if(!shop || shop.listId !== cur.id) return;
            }

            if(!it.picked){
              await openShopPickModal(it);
            }else{
              setSync("Sync • Saving…", "warn");
              await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", cur.id, "items", it.id), {
                picked: false,
                pickedAt: null,
                pickedQty: null,
                pickedCost: null,
                updatedAt: serverTimestamp(),
                updatedByUid: state.user.uid
              });
              try{
                const idx = (state.items||[]).findIndex(x=>x.id===it.id);
                if(idx>=0){
                  state.items[idx] = { ...state.items[idx], picked:false, pickedAt:null, pickedQty:null, pickedCost:null };
                }
              }catch{}
              setSync("Sync • Up to date", "good");
              try{ renderShop(); }catch{}
              try{ renderBuild(); }catch{}
            }
          });

          
          row.querySelector("[data-edit]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const cur = getCurrentList();
            if(!cur) return;

            let shop = getActiveShop();
            if(!shop || shop.listId !== cur.id){
              const ok = await confirmModal({
                title: "Start shopping session?",
                message: "Start a shopping session to edit picked quantity/cost for this item?",
                confirmLabel: "Start shop",
                confirmClass: "primary",
                cancelLabel: "Cancel"
              });
              if(!ok) return;
              await startShopSession({ skipConfirm: true });
              shop = getActiveShop();
              if(!shop || shop.listId !== cur.id) return;
            }
            await openShopPickModal(it, { mode: "edit" });
          });
row.querySelector("[data-skip]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const cur = getCurrentList();
            if(!cur) return;
            const shop = getActiveShop();
            if(!shop || shop.listId !== cur.id){ toast("Start shop first"); return; }

            const choice = await showChoiceModal({
              title: "Skip item",
              message: "Mark this item as not needed or unavailable for this shop. It will be removed from this shopping session, but remain on your list.",
              options: [
                { key: "not_needed", label: "Not needed", className: "secondary" },
                { key: "unavailable", label: "Unavailable", className: "danger" }
              ],
              cancelLabel: "Cancel"
            });
            if(!choice) return;

            setSync("Sync • Saving…", "warn");
            const batch = writeBatch(db);
            const shopRef = doc(db, "households", state.selectedHouseholdId, "shops", shop.shopId);
            const meta = { reason: choice, atMs: Date.now(), byUid: state.user.uid };
            batch.update(shopRef, {
              excludedIds: arrayUnion(it.id),
              [`excluded.${it.id}`]: meta,
              updatedAt: serverTimestamp()
            });

            const itemRef = doc(db, "households", state.selectedHouseholdId, "lists", cur.id, "items", it.id);
            batch.update(itemRef, {
              picked: false,
              pickedAt: null,
              pickedQty: null,
              pickedCost: null,
              updatedAt: serverTimestamp(),
              updatedByUid: state.user.uid
            });

            await batch.commit();

            if(!Array.isArray(shop.excludedIds)) shop.excludedIds = [];
            if(!shop.excludedIds.includes(it.id)) shop.excludedIds.push(it.id);

            const idx = (state.items||[]).findIndex(x=>x.id===it.id);
            if(idx>=0){
              state.items[idx] = { ...state.items[idx], picked:false, pickedAt:null, pickedQty:null, pickedCost:null };
            }

            setSync("Sync • Up to date", "good");
            renderShop();
            try{ renderBuild(); }catch{}
          });

          itemsWrap.appendChild(row);
        }
      }
    }

    
    function setShopView(view){
      state.shopView = view;
      const mainV = $("#shopMainView");
      const histV = $("#shopHistoryView");
      const detV = $("#shopDetailView");
      if(mainV) mainV.style.display = (view==="main") ? "" : "none";
      if(histV) histV.style.display = (view==="history") ? "" : "none";
      if(detV) detV.style.display = (view==="detail") ? "" : "none";
      // Keep header in place; just rerender relevant view
      if(view==="main"){
        try{ renderShop(); }catch{}
      }else if(view==="history"){
        try{ renderShopHistory(); }catch{}
      }else if(view==="detail"){
        try{ renderShopDetail(); }catch{}
      }
    }

    function tsToMs(v){
      if(!v) return null;
      if(typeof v === "number") return v;
      if(typeof v.toMillis === "function") return v.toMillis();
      if(typeof v.seconds === "number") return v.seconds*1000;
      return null;
    }
    function fmtDateTime(ms){
      if(!ms) return "—";
      const d = new Date(ms);
      return d.toLocaleString(undefined, { weekday:"short", day:"2-digit", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }

    async function loadShopHistory(){
      if(!guardHousehold()) return [];
      try{
        const qy = query(
          collection(db, "households", state.selectedHouseholdId, "shops"),
          where("status","==","completed"),
          orderBy("completedAt","desc"),
          limit(50)
        );
        const snap = await getDocs(qy);
        const out = [];
        snap.forEach(d=>{
          const data = d.data() || {};
          out.push({ id:d.id, ...data });
        });
        state.shopHistory = out;
        return out;
      }catch(err){
        console.warn("Shop history load failed", err);
        state.shopHistory = [];
        return [];
      }
    }

    function renderShopHistory(){
      const empty = $("#shopHistoryEmpty");
      const list = $("#shopHistoryList");
      if(!empty || !list) return;
      const items = Array.isArray(state.shopHistory) ? state.shopHistory : [];
      if(!items.length){
        empty.style.display = "block";
        list.style.display = "none";
        return;
      }
      empty.style.display = "none";
      list.style.display = "flex";
      list.innerHTML = "";

      for(const s of items){
        const ms = tsToMs(s.completedAt) || null;
        const when = fmtDateTime(ms);
        const total = Number.isFinite(Number(s.basketTotal)) ? money(Number(s.basketTotal)) : "£—";
        const dur = s.durationHms || (Number.isFinite(Number(s.durationSeconds)) ? fmtHMS(Number(s.durationSeconds)) : "—");
        const pickedCount = Array.isArray(s.itemsFinal) ? s.itemsFinal.filter(x=>x && x.picked).length : 0;
        const totalCount = Array.isArray(s.itemsFinal) ? s.itemsFinal.length : 0;

        const row = document.createElement("div");
        row.className = "item";
        row.style.cursor = "pointer";
        row.innerHTML = `
          <div class="grow">
            <div class="title">${escapeHtml(when)}</div>
            <div class="sub">${escapeHtml(total)} • ${escapeHtml(dur)} • ${pickedCount}/${totalCount} picked${s.unpricedCount?` • ${s.unpricedCount} unpriced`:``}</div>
          </div>
          <button class="btn ghost small" type="button" data-open>View</button>
          <button class="btn danger small" type="button" data-del>Delete</button>
        `;
        row.querySelector("[data-open]")?.addEventListener("click", (e)=>{
          e.stopPropagation();
          openShopDetail(s.id);
        });
        row.addEventListener("click", ()=> openShopDetail(s.id));
        row.querySelector("[data-del]")?.addEventListener("click", async (e)=>{
          e.stopPropagation();
          await deleteShopRecord(s.id);
        });

        list.appendChild(row);
      }
    }

    async function openShopHistory(){
      setShopView("history");
      await loadShopHistory();
      renderShopHistory();
    }

    async function openShopDetail(shopId){
      if(!guardHousehold()) return;
      let rec = (state.shopHistory||[]).find(x=>x.id===shopId) || null;
      if(!rec){
        try{
          const snap = await getDoc(doc(db, "households", state.selectedHouseholdId, "shops", shopId));
          if(snap.exists()) rec = { id:snap.id, ...(snap.data()||{}) };
        }catch{}
      }
      state.shopDetail = rec;
      state.shopDetailShowAll = false;
      setShopView("detail");
      renderShopDetail();
    }

    function renderShopDetail(){
      const wrap = $("#shopDetailItems");
      const sum = $("#shopDetailSummary");
      const btn = $("#btnShopDetailToggleAll");
      if(!wrap || !sum) return;

      const s = state.shopDetail;
      if(!s){
        sum.innerHTML = `<div class="muted">Shop not found.</div>`;
        wrap.innerHTML = "";
        return;
      }
      const ms = tsToMs(s.completedAt) || null;
      const when = fmtDateTime(ms);
      const total = Number.isFinite(Number(s.basketTotal)) ? money(Number(s.basketTotal)) : "£—";
      const dur = s.durationHms || (Number.isFinite(Number(s.durationSeconds)) ? fmtHMS(Number(s.durationSeconds)) : "—");
      const unp = s.unpricedCount ? `${s.unpricedCount} unpriced` : "All priced";
      const allItems = Array.isArray(s.itemsFinal) ? s.itemsFinal : [];
      const pickedItems = allItems.filter(x=>x && x.picked);
      const showing = state.shopDetailShowAll ? allItems : pickedItems;

      sum.innerHTML = `
        <div class="card" style="padding:10px">
          <div class="h1" style="margin:0">${escapeHtml(when)}</div>
          <div class="muted" style="margin-top:4px">${escapeHtml(total)} • ${escapeHtml(dur)} • ${pickedItems.length}/${allItems.length} picked • ${escapeHtml(unp)}</div>
        </div>
      `;

      if(btn){
        btn.textContent = state.shopDetailShowAll ? "Show picked only" : "Show all items";
      }

      wrap.innerHTML = "";
      if(!showing.length){
        wrap.innerHTML = `<div class="muted">No items to show.</div>`;
        return;
      }

      // group by category for readability
      const groups = new Map();
      for(const it of showing){
        const key = it.categoryId || "__uncat__";
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }
      const order = (state.categories || []).map(c=>c.id).filter(id=>groups.has(id));
      if(groups.has("__uncat__")) order.push("__uncat__");

      for(const catId of order){
        const h = document.createElement("div");
        h.className = "muted";
        h.style.margin = "10px 2px 6px";
        h.style.fontWeight = "800";
        h.textContent = catId==="__uncat__" ? "Uncategorised" : categoryLabel(catId);
        wrap.appendChild(h);

        for(const it of groups.get(catId)){
          const row = document.createElement("div");
          row.className = "item" + (it.picked ? " picked" : "");
          const qtyTxt = (it.qty!=null) ? `${it.qty}${it.unit?` ${it.unit}`:``}` : "";
          const costTxt = Number.isFinite(Number(it.pickedCost)) ? money(Number(it.pickedCost)) : "£—";
          const pickedQtyTxt = Number.isFinite(Number(it.pickedQty)) ? `Qty ${Number(it.pickedQty)}` : "";
          row.innerHTML = `
            <div class="grow">
              <div class="title">${escapeHtml(it.name || "Item")}</div>
              <div class="sub">${qtyTxt ? escapeHtml(qtyTxt) + " • " : ""}${escapeHtml(categoryLabel(it.categoryId))}${it.notes ? " • " + escapeHtml(it.notes) : ""}${it.picked ? " • Picked" + (pickedQtyTxt?(" • "+escapeHtml(pickedQtyTxt)):"") + " • " + escapeHtml(costTxt) : ""}</div>
            </div>
            <button class="btn ghost small" type="button" data-save title="Save to template">Save</button>
          `;
          row.querySelector("[data-save]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            await saveTemplateItemFromSnapshot(it);
          });
          wrap.appendChild(row);
        }
      }
    }

    async function saveTemplateItemFromSnapshot(it){
      if(!guardHousehold()) return;
      const name = (it?.name||"").trim();
      if(!name){ toast("Item needs a name"); return; }
      const tpl = Array.isArray(state.config?.weeklyTemplate) ? [...state.config.weeklyTemplate] : [];
      const exists = tpl.some(x=> (x?.name||"").trim().toLowerCase()===name.toLowerCase() && (x.categoryId||null)===(it.categoryId||null));
      if(exists){ toast("Already in template"); return; }

      tpl.push({
        id: crypto.randomUUID(),
        name,
        categoryId: it.categoryId || null,
        qty: it.qty ?? null,
        unit: it.unit || "",
        notes: it.notes || ""
      });

      setSync("Sync • Saving…", "warn");
      await setDoc(doc(db, "households", state.selectedHouseholdId, "settings", "config"), {
        weeklyTemplate: tpl,
        updatedAt: serverTimestamp(),
        updatedByUid: state.user.uid
      }, { merge: true });

      // update local
      state.config = { ...(state.config||{}), weeklyTemplate: tpl };
      setSync("Sync • Up to date", "good");
      toast("Saved to template");
      try{ renderSetup(); }catch{}
    }

    async function deleteShopRecord(shopId){
      if(!guardHousehold()) return;
      const ok = await confirmModal({
        title: "Delete shop record?",
        message: "This permanently deletes this completed shop record. This won't affect your current lists.",
        confirmLabel: "Delete",
        confirmClass: "danger",
        cancelLabel: "Cancel"
      });
      if(!ok) return;

      setSync("Sync • Deleting…", "warn");
      await deleteDoc(doc(db, "households", state.selectedHouseholdId, "shops", shopId));
      setSync("Sync • Up to date", "good");
      toast("Deleted");
      state.shopHistory = (state.shopHistory||[]).filter(x=>x.id!==shopId);
      if(state.shopDetail && state.shopDetail.id===shopId){
        state.shopDetail = null;
        setShopView("history");
      }else{
        renderShopHistory();
      }
    }

async function openShopPickModal(it, opts={}){
      const cur = getCurrentList();
      if(!cur) return;
      const qtyDefault = (it.picked && Number.isFinite(Number(it.pickedQty))) ? Number(it.pickedQty) : (Number.isFinite(Number(it.qty)) ? Number(it.qty) : 1);
      const costDefault = (it.picked && Number.isFinite(Number(it.pickedCost))) ? Number(it.pickedCost) : null;
      const skipDefault = it.picked && (it.pickedCost===null || it.pickedCost===undefined);

      const cats = (state.categories||[]).slice();
      const catOptions = [`<option value="">Uncategorised</option>`]
        .concat(cats.map(c=>`<option value="${c.id}" ${c.id===it.categoryId ? "selected":""}>${escapeHtml(c.name)}</option>`))
        .join("");

      showModal({
        title: (opts.mode==="edit" ? "Edit picked item" : "Pick item"),
        body: `
          <div style="max-height:70vh; overflow:auto">
          <div class="field"><label>Item</label><div style="font-weight:900">${escapeHtml(it.name||"Item")}</div></div>
          <div class="grid2">
            <div class="field"><label>Quantity picked</label><input id="spQty" type="number" inputmode="decimal" value="${escapeHtml(String(qtyDefault))}" /></div>
            <div class="field"><label>Cost (£)</label><input id="spCost" type="number" inputmode="decimal" placeholder="e.g. 2.50" value="${costDefault!=null ? escapeHtml(String(costDefault)) : ""}" /></div>
          </div>
          <div class="field"><label>Category</label><select id="spCat">${catOptions}</select></div>
          <div class="row gap" style="margin-top:6px">
            <label class="muted" style="display:flex;align-items:center;gap:8px">
              <input id="spSkip" type="checkbox" ${skipDefault ? "checked" : ""} />
              Skip cost for now
            </label>
          </div>
          </div>
        `,
        footerButtons: [
          { label: "Cancel", className: "ghost" },
          {
            label: "Save",
            className: "primary",
            onClick: async ()=>{
              const qty = Number($("#spQty").value);
              const skip = $("#spSkip").checked;
              const cost = skip ? null : Number($("#spCost").value);
              const catId = ($("#spCat").value || "") || null;

              setSync("Sync • Saving…", "warn");
              await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", cur.id, "items", it.id), {
                picked: true,
                pickedAt: serverTimestamp(),
                pickedQty: Number.isFinite(qty) ? qty : null,
                pickedCost: (!skip && Number.isFinite(cost)) ? cost : null,
                categoryId: catId,
                updatedAt: serverTimestamp(),
                updatedByUid: state.user.uid
              });
              try{
                const idx = (state.items||[]).findIndex(x=>x.id===it.id);
                if(idx>=0){
                  state.items[idx] = { ...state.items[idx], picked:true, pickedQty: Number.isFinite(qty)?qty:null, pickedCost: (!skip && Number.isFinite(cost))?cost:null, categoryId: catId };
                }
              }catch{}
              setSync("Sync • Up to date", "good");
              try{ renderShop(); }catch{}
              try{ renderBuild(); }catch{}
            }
          }
        ]
      });
      setTimeout(()=>{ try{ $("#spCost").focus(); }catch{} }, 80);
    }

    async function startShopSession(opts={}){
      if(!guardHousehold()) return;
      const cur = getCurrentList();
      if(!cur){ toast("Select a list first"); return; }

      const existing = getActiveShop();
      if(existing && existing.listId === cur.id){
        toast("Shop already in progress");
        return;
      }

      if(!opts.skipConfirm){
        const ok = await confirmModal({
          title: "Start shop?",
          message: "This begins shopping mode for this list. You can pick items, capture costs, and then complete the shop to save it for reports.",
          confirmLabel: "Start shop",
          confirmClass: "primary",
          cancelLabel: "Cancel"
        });
        if(!ok) return;
      }

      const startedAtMs = Date.now();
      const shopsCol = collection(db, "households", state.selectedHouseholdId, "shops");
      const itemsSnap = (state.items || []).map(x=>({
        id: x.id,
        name: x.name || "",
        qty: x.qty ?? null,
        unit: x.unit || "",
        notes: x.notes || "",
        categoryId: x.categoryId || null,
        mealTags: Array.isArray(x.mealTags) ? x.mealTags : [],
        picked: !!x.picked
      }));

      const shopDoc = await addDoc(shopsCol, {
        status: "active",
        listId: cur.id,
        listName: cur.name || "",
        startedAt: serverTimestamp(),
        startedAtMs,
        startedByUid: state.user.uid,
        itemsStart: itemsSnap,
        createdAt: serverTimestamp()
      });

      state.activeShop = { householdId: state.selectedHouseholdId, listId: cur.id, shopId: shopDoc.id, startedAtMs, excludedIds: [] };
      setActiveShopKey(`${state.selectedHouseholdId}:${cur.id}:${shopDoc.id}:${startedAtMs}`);
      toast("Shop started");
      renderShop();
    }

    async function completeShopSession(){
      if(!guardHousehold()) return;
      const cur = getCurrentList();
      const shop = getActiveShop();
      if(!cur || !shop || shop.listId !== cur.id){ toast("No active shop"); return; }

      const { total, unpriced } = computeBasket();
      const elapsedSec = Math.floor((Date.now() - (shop.startedAtMs||Date.now()))/1000);
      const ok = await confirmModal({
        title: "Complete shop?",
        message: `This will end shopping mode and save the shop for reports. Basket total: ${money(total)}${unpriced?` (plus ${unpriced} unpriced)`:``}.`,
        confirmLabel: "Complete shop",
        confirmClass: "primary",
        cancelLabel: "Cancel"
      });
      if(!ok) return;

      const finalItems = (state.items || []).map(x=>({
        id: x.id,
        name: x.name || "",
        qty: x.qty ?? null,
        unit: x.unit || "",
        notes: x.notes || "",
        categoryId: x.categoryId || null,
        mealTags: Array.isArray(x.mealTags) ? x.mealTags : [],
        picked: !!x.picked,
        pickedQty: x.pickedQty ?? null,
        pickedCost: x.pickedCost ?? null
      }));

      setSync("Sync • Saving…", "warn");
      await updateDoc(doc(db, "households", state.selectedHouseholdId, "shops", shop.shopId), {
        status: "completed",
        completedAt: serverTimestamp(),
        completedByUid: state.user.uid,
        durationSeconds: elapsedSec,
        durationHms: fmtHMS(elapsedSec),
        basketTotal: Number(total.toFixed(2)),
        unpricedCount: unpriced,
        itemsFinal: finalItems,
        updatedAt: serverTimestamp()
      });
      setSync("Sync • Up to date", "good");

      state.activeShop = null;
      setActiveShopKey(null);
      toast("Shop completed");
      renderShop();
    }
    async function resetShopSession(){
      if(!guardHousehold()) return;
      const cur = getCurrentList();
      const shop = getActiveShop();
      if(!cur || !shop || shop.listId !== cur.id){ toast("No active shop"); return; }

      const ok = await confirmModal({
        title: "Reset shop?",
        message: "This will reset the timer and basket, unpick all items, and clear any skipped items for this session.",
        confirmLabel: "Reset shop",
        confirmClass: "danger",
        cancelLabel: "Cancel"
      });
      if(!ok) return;

      setSync("Sync • Saving…", "warn");
      const batch = writeBatch(db);

      for(const it of (state.items||[])){
        const itemRef = doc(db, "households", state.selectedHouseholdId, "lists", cur.id, "items", it.id);
        batch.update(itemRef, {
          picked: false,
          pickedAt: null,
          pickedQty: null,
          pickedCost: null,
          updatedAt: serverTimestamp(),
          updatedByUid: state.user.uid
        });
      }

      const shopRef = doc(db, "households", state.selectedHouseholdId, "shops", shop.shopId);
      const nowMs = Date.now();
      batch.update(shopRef, {
        startedAt: serverTimestamp(),
        startedAtMs: nowMs,
        basketTotal: 0,
        unpricedCount: 0,
        excludedIds: [],
        excluded: {},
        updatedAt: serverTimestamp()
      });

      await batch.commit();

      shop.startedAtMs = nowMs;
      shop.excludedIds = [];
      for(let i=0;i<(state.items||[]).length;i++){
        state.items[i] = { ...state.items[i], picked:false, pickedAt:null, pickedQty:null, pickedCost:null };
      }

      setSync("Sync • Up to date", "good");
      toast("Shop reset");
      renderShop();
      try{ renderBuild(); }catch{}
    }



    async function openQuickAddShopModal(){
      if(!guardHousehold()) return;
      const cur = getCurrentList();
      if(!cur){ toast("Select a list first"); return; }

      const cats = (state.categories||[]).slice();
      const catOptions = [`<option value="">Uncategorised</option>`]
        .concat(cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`))
        .join("");

      showModal({
        title: "Quick add",
        body: `
          <div class="field"><label>Item name</label><input id="qaName" placeholder="e.g. Milk" /></div>
          <div class="grid2">
            <div class="field"><label>Quantity</label><input id="qaQty" type="number" inputmode="decimal" placeholder="e.g. 1" /></div>
            <div class="field"><label>Unit</label><input id="qaUnit" placeholder="e.g. bottles" /></div>
          </div>
          <div class="field"><label>Category</label><select id="qaCat">${catOptions}</select></div>
          <div class="field"><label>Notes (optional)</label><textarea id="qaNotes" placeholder="e.g. Semi-skimmed"></textarea></div>
        `,
        footerButtons: [
          { label: "Cancel", className: "ghost" },
          {
            label: "Add",
            className: "primary",
            onClick: async ()=>{
              const name = ($("#qaName").value||"").trim();
              if(!name) { toast("Enter an item name"); return false; }
              const qtyRaw = ($("#qaQty").value||"").trim();
              const qty = qtyRaw==="" ? null : Number(qtyRaw);
              const unit = ($("#qaUnit").value||"").trim();
              const catId = ($("#qaCat").value||"") || null;
              const notes = ($("#qaNotes").value||"").trim();

              setSync("Sync • Adding…", "warn");
              await addDoc(collection(db, "households", state.selectedHouseholdId, "lists", cur.id, "items"), {
                name, qty: Number.isFinite(qty) ? qty : null, unit, categoryId: catId, notes,
                picked: false,
                createdAt: serverTimestamp(),
                createdByUid: state.user.uid,
                updatedAt: serverTimestamp(),
                updatedByUid: state.user.uid
              });
              setSync("Sync • Up to date", "good");
              toast("Item added");
            }
          },
          {
            label: "Add & pick",
            className: "secondary",
            onClick: async ()=>{
              const name = ($("#qaName").value||"").trim();
              if(!name) { toast("Enter an item name"); return false; }
              const qtyRaw = ($("#qaQty").value||"").trim();
              const qty = qtyRaw==="" ? null : Number(qtyRaw);
              const unit = ($("#qaUnit").value||"").trim();
              const catId = ($("#qaCat").value||"") || null;
              const notes = ($("#qaNotes").value||"").trim();

              setSync("Sync • Adding…", "warn");
              const newRef = await addDoc(collection(db, "households", state.selectedHouseholdId, "lists", cur.id, "items"), {
                name, qty: Number.isFinite(qty) ? qty : null, unit, categoryId: catId, notes,
                picked: false,
                createdAt: serverTimestamp(),
                createdByUid: state.user.uid,
                updatedAt: serverTimestamp(),
                updatedByUid: state.user.uid
              });
              setSync("Sync • Up to date", "good");
              // Wait for snapshot to include it, then open pick modal with minimal item object
              hideModal();
              openShopPickModal({ id: newRef.id, name, qty, unit, notes, categoryId: catId, mealTags: [], picked:false });
              return false; // keep modal closed already
            }
          }
        ]
      });
      setTimeout(()=>{ try{ $("#qaName").focus(); }catch{} }, 60);
    }

function renderMealTags(it){
      const tags = Array.isArray(it?.mealTags) ? it.mealTags.filter(Boolean) : [];
      if(!tags.length) return "";
      const shown = tags.slice(0,2);
      const extra = tags.length - shown.length;
      const pills = shown.map(t=>`<span class="mealTag">${escapeHtml(t)}</span>`).join("");
      const more = extra>0 ? `<span class="mealTag">+${extra}</span>` : "";
      return `<div class="mealTagWrap">${pills}${more}</div>`;
    }


    function renderBuild(){
      const empty = $("#buildEmpty");
      const wrap = $("#buildWrap");
      const curEl = $("#buildCurrentList");
      const itemsEmpty = $("#itemsEmpty");
      const itemsWrap = $("#itemsWrap");
      const togglePickedBtn = $("#btnTogglePicked");

      if(!state.user || !state.selectedHouseholdId){
        empty.style.display = "block";
        wrap.style.display = "none";
        return;
      }

      const cur = getCurrentList();
      const promptsCard = $("#buildPromptsCard");
      if(promptsCard){
        promptsCard.style.display = isWeeklyShopList(cur) ? "" : "none";
      }
      if(!cur){
        empty.style.display = "block";
        empty.textContent = "Select a list in the Lists tab to start building.";
        wrap.style.display = "none";
        return;
      }

      empty.style.display = "none";
      wrap.style.display = "block";
      curEl.textContent = cur.name || (cur.type==="weekly" ? "Weekly shop" : "List");

      try{ renderBuildPrompts(); }catch{}

      if(togglePickedBtn){
        togglePickedBtn.textContent = state.showPicked ? "Hide picked" : "Show picked";
      }

      const visible = (state.items || []).filter(it=> state.showPicked ? true : !it.picked);
      itemsWrap.innerHTML = "";

      if(!visible.length){
        itemsEmpty.style.display = "block";
        itemsWrap.style.display = "none";
        itemsEmpty.textContent = state.showPicked ? "No items yet." : "No unpicked items — toggle to show picked, or add more.";
        return;
      }

      itemsEmpty.style.display = "none";
      itemsWrap.style.display = "flex";

      // Group by category, uncategorised last
      const groups = new Map();
      for(const it of visible){
        const key = it.categoryId || "__uncat__";
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(it);
      }
      const order = (state.categories || []).map(c=>c.id).filter(id=>groups.has(id));
      if(groups.has("__uncat__")) order.push("__uncat__");

      for(const catId of order){
        const header = document.createElement("div");
        header.className = "muted";
        header.style.margin = "10px 2px 6px";
        header.style.fontWeight = "800";
        header.textContent = catId==="__uncat__" ? "Uncategorised" : categoryLabel(catId);
        itemsWrap.appendChild(header);

        for(const it of groups.get(catId)){
          const row = document.createElement("div");
          row.className = "item" + (it.picked ? " picked" : "");
          const qtyTxt = fmtQty(it);
          row.innerHTML = `
            <div class="grow">
              <div class="title">${escapeHtml(it.name || "Item")}</div>
              ${renderMealTags(it)}
              <div class="sub">${qtyTxt ? escapeHtml(qtyTxt) + " • " : ""}${escapeHtml(categoryLabel(it.categoryId))}${it.notes ? " • " + escapeHtml(it.notes) : ""}${it.picked ? " • Picked" : ""}</div>
            </div>
            <button class="btn ghost small" type="button" data-edit title="Edit item">✎</button>
            <button class="btn secondary small" type="button" data-toggle>${it.picked ? "Unpick" : "Pick"}</button>
            <button class="btn danger small" type="button" data-del>×</button>
          `;

          row.querySelector("[data-toggle]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const cur = getCurrentList();
            if(!cur) return;
            setSync("Sync • Saving…", "warn");
            await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", cur.id, "items", it.id), {
              picked: !it.picked,
              pickedAt: !it.picked ? serverTimestamp() : null,
              updatedAt: serverTimestamp(),
              updatedByUid: state.user.uid
            });
            setSync("Sync • Up to date", "good");
          });

          row.querySelector("[data-edit]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const cur = getCurrentList();
            if(!cur) return;
            await openEditBuildItemModal(it);
          });

          row.querySelector("[data-del]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const ok = await confirmModal({
              title: "Delete item?",
              message: "This permanently deletes the item from the list.",
              confirmLabel: "Delete",
              confirmClass: "danger",
              cancelLabel: "Cancel"
            });
            if(!ok) return;
            const cur = getCurrentList();
            if(!cur) return;
            setSync("Sync • Deleting…", "warn");
            await deleteDoc(doc(db, "households", state.selectedHouseholdId, "lists", cur.id, "items", it.id));
            setSync("Sync • Up to date", "good");
          });

          itemsWrap.appendChild(row);
        }
      }
    }

    async function openAddItemModal(){
      const cur = getCurrentList();
      if(!cur){ toast("Select a list first"); setTab("lists"); return; }

      const catOptions = (state.categories || []).map(c=> `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join("");
      showModal({
        title: "Add item",
        body: `
          <div class="grid2">
            <div class="field">
              <label>Item name</label>
              <input id="aiName" placeholder="e.g. Milk" />
            </div>
            <div class="field">
              <label>Category</label>
              <select id="aiCat">
                <option value="">Uncategorised</option>
                ${catOptions}
              </select>
            </div>
            <div class="field">
              <label>Quantity</label>
              <input id="aiQty" type="number" inputmode="decimal" placeholder="e.g. 2" />
            </div>
            <div class="field">
              <label>Unit</label>
              <input id="aiUnit" placeholder="e.g. bottles" />
            </div>
            <div class="field" style="grid-column:1 / -1">
              <label>Notes (optional)</label>
              <textarea id="aiNotes" placeholder="e.g. Semi-skimmed"></textarea>
            </div>
          </div>
        `,
        footerButtons: [
          { label:"Cancel", className:"btn ghost" },
          { label:"Add", className:"btn primary", onClick: async ()=>{
              const name = ($("#aiName").value || "").trim();
              if(!name){ toast("Please enter an item name"); return false; }
              const categoryId = ($("#aiCat").value || "") || null;
              const qtyRaw = ($("#aiQty").value || "").trim();
              const qty = qtyRaw ? Number(qtyRaw) : null;
              const unit = ($("#aiUnit").value || "").trim();
              const notes = ($("#aiNotes").value || "").trim();

              setSync("Sync • Adding…", "warn");
              const itemsCol = collection(db, "households", state.selectedHouseholdId, "lists", cur.id, "items");
              await addDoc(itemsCol, {
                name,
                categoryId,
                qty: (qtyRaw && !Number.isNaN(qty)) ? qty : null,
                unit,
                notes,
                picked: false,
                pickedAt: null,
                priceEach: null,
                costTotal: null,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                addedByUid: state.user.uid,
                updatedByUid: state.user.uid
              });
              setSync("Sync • Up to date", "good");
            }}
        ]
      });
    }
    // === Lists UI (baseline) ===
    function renderLists(){
      const wrap = $("#listsWrap");
      const empty = $("#listsEmpty");
      wrap.innerHTML = "";

      if(!state.selectedHouseholdId){
        empty.style.display = "block";
        wrap.style.display = "none";
        empty.textContent = "Select a household to get started.";
        setCtx();
        return;
      }

      if(!state.lists.length){
        empty.style.display = "block";
        wrap.style.display = "none";
        empty.textContent = "No lists yet. Create one, or open Weekly shop.";
        setCtx();
        return;
      }

      empty.style.display = "none";
      wrap.style.display = "flex";

      const currentId = getCurrentListId();

      const showArchived = !!state.showArchivedLists;
      $("#btnToggleArchivedLists").textContent = showArchived ? "Hide archived" : "Show archived";
      const visible = state.lists.filter(l=> showArchived ? true : !l.archived);

      for(const l of visible){
        const isCurrent = l.id === currentId;
        const el = document.createElement("div");
        el.className = "item hhRow" + (isCurrent ? " selected" : "");
        el.innerHTML = `
          <div class="grow">
            <div class="title">${escapeHtml(l.name || "List")}</div>
            <div class="sub">${l.type==="weekly" ? "Weekly" : "Custom"}${l.archived ? " • Archived" : ""}</div>
          </div>
          
          <div class="row" style="gap:8px; justify-content:flex-end; align-items:center">
            <button class="btn secondary small" type="button" data-list-build>Build</button>
            <button class="btn primary small" type="button" data-list-shop>Shop</button>
            <button class="iconBtn" type="button" data-list-manage aria-label="List options" title="List options">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" fill="currentColor"/>
                <path d="M19 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" fill="currentColor"/>
                <path d="M5 13a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" fill="currentColor"/>
              </svg>
            </button>
          </div>

            <div class="badge">${l.type==="weekly" ? "Weekly" : "List"}</div>
        `;
        el.addEventListener("click", ()=>{
          setCurrentListId(l.id);
          renderLists();
          attachItemsListener();
          toast("Current list set");
        });
        
        el.querySelector("[data-list-build]")?.addEventListener("click", (e)=>{
          e.stopPropagation();
          setCurrentListId(l.id);
          setTab("build");
        });
        el.querySelector("[data-list-shop]")?.addEventListener("click", (e)=>{
          e.stopPropagation();
          setCurrentListId(l.id);
          setTab("shop");
        });

        el.querySelector("[data-list-manage]")?.addEventListener("click", (e)=>{ e.stopPropagation(); openListSettings(l); });
        wrap.appendChild(el);
      }

      setCtx();
    }

function renderSetup(){
  const block = $("#setupBlock");
  const wrap = $("#setupWrap");
  if(!block || !wrap) return;

  if(!state.selectedHouseholdId){
    block.style.display = "block";
    wrap.style.display = "none";
    block.textContent = "Select a household to manage setup.";
    return;
  }

  block.style.display = "none";
  wrap.style.display = "block";

  // Categories list
  const catsWrap = $("#catsWrap");
  catsWrap.innerHTML = "";
  const cats = (state.categories || []).slice();

  // Ensure Uncategorised is last (system)
  cats.sort((a,b)=> (a.name==="Uncategorised") - (b.name==="Uncategorised") || (a.order||0)-(b.order||0));

  cats.forEach((c, idx)=>{
    const isSystem = c.name === "Uncategorised";
    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <div class="grow">
        <div class="title">${escapeHtml(c.name || "Category")}${isSystem ? " • System" : ""}</div>
        <div class="sub">Order: ${idx+1}</div>
      </div>
      ${!isSystem ? `
        <button class="btn secondary small" type="button" data-up>˄</button>
        <button class="btn secondary small" type="button" data-down>˅</button>
            ${state.selectedRole==="owner" && c.id!=="uncategorised" ? `<button class="btn danger small" type="button" data-delcat>Delete</button>` : ``}
      ` : ``}
    `;
    row.querySelector("[data-up]")?.addEventListener("click", async (e)=>{
      e.stopPropagation();
      await moveCategory(c.id, -1);
    });
    row.querySelector("[data-down]")?.addEventListener("click", async (e)=>{
      e.stopPropagation();
      await moveCategory(c.id, +1);
    });
    row.querySelector("[data-delcat]")?.addEventListener("click", async (e)=>{
      e.stopPropagation();
      await deleteCategory(c.id);
    });
    catsWrap.appendChild(row);
  });

  // Template list
  const tpl = Array.isArray(state.config?.weeklyTemplate) ? state.config.weeklyTemplate : [];
  const tplWrap = $("#tplWrap");
  const tplEmpty = $("#tplEmpty");
  tplWrap.innerHTML = "";

  if(!tpl.length){
    tplEmpty.style.display = "block";
    tplWrap.style.display = "none";
  }else{
    tplEmpty.style.display = "none";
    tplWrap.style.display = "flex";

    for(const t of tpl){
      const row = document.createElement("div");
      row.className = "item";
      const catName = (state.categories || []).find(c=>c.id===t.categoryId)?.name || "Uncategorised";
      row.innerHTML = `
        <div class="grow">
          <div class="title">${escapeHtml(t.name || "Item")}</div>
          <div class="sub">${escapeHtml(catName)}${t.qty ? " • " + escapeHtml(String(t.qty)) + (t.unit ? " " + escapeHtml(t.unit) : "") : ""}${t.notes ? " • " + escapeHtml(t.notes) : ""}</div>
        </div>
        <button class="btn secondary small" type="button" data-edit>Edit</button>
        <button class="btn danger small" type="button" data-del>×</button>
      `;
      row.querySelector("[data-edit]")?.addEventListener("click", ()=> openTemplateItemModal(t));
      row.querySelector("[data-del]")?.addEventListener("click", ()=> deleteTemplateItem(t.id));
      tplWrap.appendChild(row);
    }
  }
}
    async function openEditBuildItemModal(it){
      const cur = getCurrentList();
      if(!cur) return;

      const cats = (state.categories||[]).slice();
      const catOptions = [`<option value="">Uncategorised</option>`]
        .concat(cats.map(c=>`<option value="${escapeHtml(c.id)}" ${c.id===it.categoryId ? "selected":""}>${escapeHtml(c.name)}</option>`))
        .join("");

      showModal({
        title: "Edit item",
        body: `
          <div class="grid2">
            <div class="field">
              <label>Item name</label>
              <input id="eiName" placeholder="e.g. Milk" value="${escapeAttr(it.name||"")}" />
            </div>
            <div class="field">
              <label>Category</label>
              <select id="eiCat">
                ${catOptions}
              </select>
            </div>
            <div class="field">
              <label>Quantity</label>
              <input id="eiQty" type="number" inputmode="decimal" placeholder="e.g. 2" value="${it.qty===null || it.qty===undefined ? "" : escapeAttr(String(it.qty))}" />
            </div>
            <div class="field">
              <label>Unit</label>
              <input id="eiUnit" placeholder="e.g. bottles" value="${escapeAttr(it.unit||"")}" />
            </div>
            <div class="field" style="grid-column:1 / -1">
              <label>Notes (optional)</label>
              <textarea id="eiNotes" placeholder="e.g. Semi-skimmed">${escapeHtml(it.notes||"")}</textarea>
            </div>
          </div>
        `,
        footerButtons: [
          { label:"Cancel", className:"btn ghost" },
          { label:"Save", className:"btn primary", onClick: async ()=>{
              const name = ($("#eiName").value || "").trim();
              if(!name){ toast("Please enter an item name"); return false; }
              const categoryId = ($("#eiCat").value || "") || null;
              const qtyRaw = ($("#eiQty").value || "").trim();
              const qty = qtyRaw ? Number(qtyRaw) : null;
              const unit = ($("#eiUnit").value || "").trim();
              const notes = ($("#eiNotes").value || "").trim();

              setSync("Sync • Saving…", "warn");
              await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", cur.id, "items", it.id), {
                name,
                categoryId,
                qty,
                unit,
                notes,
                updatedAt: serverTimestamp(),
                updatedByUid: state.user.uid
              });

              try{
                const idx = (state.items||[]).findIndex(x=>x.id===it.id);
                if(idx>=0){
                  state.items[idx] = { ...state.items[idx], name, categoryId, qty, unit, notes };
                }
              }catch{}

              setSync("Sync • Up to date", "good");
              try{ renderBuild(); }catch{}
              try{ renderShop(); }catch{}
              return true;
            }
          }
        ]
      });
    }




async function deleteCategory(catId){
  if(!guardHousehold()) return;
  if(state.selectedRole !== "owner"){
    toast("Only the household owner can delete categories");
    return;
  }
  if(catId === "uncategorised"){
    toast("Uncategorised can’t be deleted");
    return;
  }

  const cat = (state.categories || []).find(c=>c.id===catId);
  const ok = await confirmModal({
    title: "Delete category?",
    message: `This will remove "${(cat?.name || "Category")}" and any template items using it will become Uncategorised.`,
    confirmLabel: "Delete",
    confirmClass: "danger",
    cancelLabel: "Cancel"
  });
  if(!ok) return;

  setSync("Sync • Deleting category…", "warn");

  await deleteDoc(doc(db, "households", state.selectedHouseholdId, "categories", catId));

  const t = Array.isArray(state.config?.weeklyTemplate) ? state.config.weeklyTemplate : [];
  const t2 = t.map(it => (it.categoryId === catId ? { ...it, categoryId: null } : it));

  // Re-number remaining categories (ensure uncategorised last)
  const remaining = (state.categories || []).filter(c=>c.id !== catId);
  const sorted = [...remaining].sort((a,b)=> (a.order ?? 9999) - (b.order ?? 9999));
  const uncat = sorted.find(c=>c.id==="uncategorised");
  const others = sorted.filter(c=>c.id!=="uncategorised");
  const final = [...others, ...(uncat ? [uncat] : [])];

  const batch = writeBatch(db);
  final.forEach((c, i)=>{
    batch.update(doc(db, "households", state.selectedHouseholdId, "categories", c.id), { order: i });
  });
  batch.set(doc(db, "households", state.selectedHouseholdId, "config", "current"), { weeklyTemplate: t2 }, { merge:true });
  await batch.commit();

  toast("Category deleted");
  setSync("Sync • Up to date", "good");
}

async function moveCategory(categoryId, delta){
  if(!guardHousehold()) return;
  const cats = (state.categories || []).slice().filter(c=>c.name!=="Uncategorised");
  cats.sort((a,b)=> (a.order||0)-(b.order||0));
  const idx = cats.findIndex(c=>c.id===categoryId);
  if(idx < 0) return;
  const j = idx + delta;
  if(j < 0 || j >= cats.length) return;

  const a = cats[idx], b = cats[j];
  setSync("Sync • Updating categories…", "warn");
  const batch = writeBatch(db);
  batch.update(doc(db, "households", state.selectedHouseholdId, "categories", a.id), { order: b.order ?? j, });
  batch.update(doc(db, "households", state.selectedHouseholdId, "categories", b.id), { order: a.order ?? idx, });
  await batch.commit();
  toast("Category order updated");
}

async function addCategory(){
  if(!guardHousehold()) return;
  const body = document.createElement("div");
  body.innerHTML = `
    <div class="muted" style="margin-bottom:10px">Add a new category for your shop journey.</div>
    <label class="muted" for="catName">Category name</label>
    <input id="catName" class="input" placeholder="e.g. Deli" />
  `;
  showModal({
    title:"Add category",
    body,
    footerButtons:[
      {label:"Cancel", className:"btn ghost"},
      {label:"Add", className:"btn primary", onClick: async ()=>{
        const name = ($("#catName")?.value || "").trim();
        if(!name){ toast("Enter a category name"); return false; }
        const maxOrder = Math.max(-1, ...(state.categories||[]).filter(c=>c.name!=="Uncategorised").map(c=>Number(c.order||0)));
        setSync("Sync • Adding category…", "warn");
        await setDoc(doc(db, "households", state.selectedHouseholdId, "categories", crypto.randomUUID()), {
          name,
          order: maxOrder + 1,
          archived:false,
          createdAt: serverTimestamp(),
          createdByUid: state.user.uid
        });
        toast("Category added");
      }}
    ]
  });
  setTimeout(()=> $("#catName")?.focus(), 50);
}

async function saveWeeklyTemplate(next){
  if(!guardHousehold()) return;
  setSync("Sync • Saving template…", "warn");
  await setDoc(doc(db, "households", state.selectedHouseholdId, "settings", "config"), {
    weeklyTemplate: next,
    updatedAt: serverTimestamp(),
    updatedByUid: state.user.uid
  }, { merge:true });
  toast("Template saved");
}

function openTemplateItemModal(item){
  const isEdit = !!item;
  const t = item || { id: crypto.randomUUID(), name:"", categoryId:null, qty:null, unit:"", notes:"" };
  const cats = (state.categories || []).slice();
  // Ensure Uncategorised option last
  cats.sort((a,b)=> (a.name==="Uncategorised") - (b.name==="Uncategorised") || (a.order||0)-(b.order||0));

  const options = cats.map(c=> `<option value="${escapeHtml(c.id)}" ${c.id===t.categoryId ? "selected":""}>${escapeHtml(c.name)}</option>`).join("");
  const body = document.createElement("div");
  body.innerHTML = `
    <label class="muted" for="tiName">Item</label>
    <input id="tiName" class="input" value="${escapeHtml(t.name)}" placeholder="e.g. Milk" />
    <div class="sep"></div>
    <label class="muted" for="tiCat">Category</label>
    <select id="tiCat" class="input">
      <option value="">Uncategorised</option>
      ${options}
    </select>
    <div class="sep"></div>
    <div class="row">
      <div class="grow">
        <label class="muted" for="tiQty">Qty</label>
        <input id="tiQty" class="input" inputmode="decimal" placeholder="e.g. 1" value="${t.qty ?? ""}" />
      </div>
      <div class="grow">
        <label class="muted" for="tiUnit">Unit</label>
        <input id="tiUnit" class="input" placeholder="pcs, L, kg…" value="${escapeHtml(t.unit || "")}" />
      </div>
    </div>
    <div class="sep"></div>
    <label class="muted" for="tiNotes">Notes</label>
    <input id="tiNotes" class="input" placeholder="Brand, size, alternatives…" value="${escapeHtml(t.notes || "")}" />
  `;

  showModal({
    title: isEdit ? "Edit template item" : "Add template item",
    body,
    footerButtons:[
      {label:"Cancel", className:"btn ghost"},
      {label: isEdit ? "Save" : "Add", className:"btn primary", onClick: async ()=>{
        const name = ($("#tiName")?.value || "").trim();
        if(!name){ toast("Enter an item name"); return false; }
        const catId = ($("#tiCat")?.value || "").trim() || null;
        const qtyRaw = ($("#tiQty")?.value || "").trim();
        const qty = qtyRaw ? Number(qtyRaw) : null;
        const unit = ($("#tiUnit")?.value || "").trim();
        const notes = ($("#tiNotes")?.value || "").trim();

        const current = Array.isArray(state.config?.weeklyTemplate) ? state.config.weeklyTemplate : [];
        const next = current.slice();
        const idx = next.findIndex(x=>x.id===t.id);
        const entry = { id: t.id, name, categoryId: catId, qty, unit, notes };
        if(idx >= 0) next[idx] = entry; else next.push(entry);
        await saveWeeklyTemplate(next);
      }}
    ]
  });
  setTimeout(()=> $("#tiName")?.focus(), 50);
}

async function deleteTemplateItem(id){
  const ok = await confirmModal({
    title:"Remove template item?",
    message:"This removes it from your Weekly template (it won’t be re-added on reset).",
    confirmLabel:"Remove",
    confirmClass:"danger"
  });
  if(!ok) return;
  const current = Array.isArray(state.config?.weeklyTemplate) ? state.config.weeklyTemplate : [];
  const next = current.filter(x=>x.id!==id);
  await saveWeeklyTemplate(next);
}


    async function ensureWeeklyList(hid){
      // Find existing weekly list
      const existing = state.lists.find(l=>l.type==="weekly" && !l.archived);
      if(existing) return existing.id;

      setSync("Sync • Creating Weekly shop…", "warn");
      const ref = await addDoc(collection(db, "households", hid, "lists"), {
        name: "Weekly shop",
        weekKey: isoWeekKey(new Date()),
        type: "weekly",
        pinned: true,
        archived: false,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        createdByUid: state.user?.uid || null,
        updatedByUid: state.user?.uid || null
      });
      toast("Weekly shop created");
      return ref.id;
    }

    $("#btnOpenWeekly").addEventListener("click", ()=>{
      if(!guardHousehold()) return;
      const weekly = (state.lists||[]).find(l=>l.type==="weekly" && !l.archived) || null;
      if(!weekly){ toast("No Weekly Shop list found"); return; }
      setCurrentListId(weekly.id);
      setTab("shop");
    });

$("#btnNewList").addEventListener("click", async ()=>{
      if(!guardHousehold()) return;

      const body = document.createElement("div");
      body.innerHTML = `
        <div class="muted" style="margin-bottom:10px">Create a new list (e.g., Amazon, Party).</div>
        <label class="muted" for="newListName">List name</label>
        <input id="newListName" class="input" placeholder="e.g., Party" />
      `;
      showModal({
        title: "New list",
        body,
        footerButtons: [
          { label:"Cancel", className:"btn ghost", onClick: ()=>true },
          { label:"Create", className:"btn primary", onClick: async ()=>{
              const name = ($("#newListName")?.value || "").trim() || "New list";
              setSync("Sync • Creating list…", "warn");
              const ref = await addDoc(collection(db, "households", state.selectedHouseholdId, "lists"), {
                name,
                type: "custom",
                pinned: false,
                archived: false,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                createdByUid: state.user.uid,
                updatedByUid: state.user.uid
              });
              setCurrentListId(ref.id);
              toast("List created");
            }
          }
        ]
      });
      setTimeout(()=> $("#newListName")?.focus(), 50);
    });

    // Build tab
    $("#btnAddItem")?.addEventListener("click", async ()=>{
      if(!guardHousehold()) return;
      await openAddItemModal();
    });

    $("#btnTogglePicked")?.addEventListener("click", ()=>{
      state.showPicked = !state.showPicked;
      renderBuild();
    });


    // Shop tab
    $("#btnStartShop")?.addEventListener("click", async ()=>{
      await loadActiveShopIfAny();
      await startShopSession();
    });
    $("#btnCompleteShop")?.addEventListener("click", async ()=>{
      await loadActiveShopIfAny();
      await completeShopSession();
    });
    $("#btnResetShop")?.addEventListener("click", async ()=>{
      await loadActiveShopIfAny();
      await resetShopSession();
      try{ renderShop(); }catch{}
      try{ renderBuild(); }catch{}
    });
    $("#btnQuickAddShop")?.addEventListener("click", async ()=>{
      await openQuickAddShopModal();
    });
    $("#btnShopTogglePicked")?.addEventListener("click", ()=>{
      state.shopShowPicked = !state.shopShowPicked;
      localStorage.setItem("bb.shopShowPicked", state.shopShowPicked ? "1" : "0");
      renderShop();
    });


    $("#btnShopHistory")?.addEventListener("click", async ()=>{
      await openShopHistory();
    });
    $("#btnShopHistoryBack")?.addEventListener("click", ()=>{
      setShopView("main");
    });
    $("#btnShopDetailBack")?.addEventListener("click", ()=>{
      setShopView("history");
    });
    $("#btnShopDetailToggleAll")?.addEventListener("click", ()=>{
      state.shopDetailShowAll = !state.shopDetailShowAll;
      renderShopDetail();
    });
    $("#btnDeleteShopRecord")?.addEventListener("click", async ()=>{
      const id = state.shopDetail?.id;
      if(!id) return;
      await deleteShopRecord(id);
    });


    // Meals tab

    $("#btnTogglePlanner")?.addEventListener("click", ()=>{
      const collapsed = localStorage.getItem("bb.mealsPlannerCollapsed") === "1";
      localStorage.setItem("bb.mealsPlannerCollapsed", collapsed ? "0" : "1");
      renderMeals();
    });
    $("#btnNewMeal")?.addEventListener("click", ()=>{ if(!guardHousehold()) return; openMealEditor(null); });
    $("#mealSearch")?.addEventListener("input", ()=> renderMeals());
    $("#btnClearWeek")?.addEventListener("click", async ()=>{
      if(!guardHousehold()) return;
      const ok = await confirmModal({
        title: "Clear this week?",
        message: "This will remove all planned meals for the current week.",
        confirmLabel: "Clear week",
        confirmClass: "danger",
        cancelLabel: "Cancel"
      });
      if(!ok) return;
      const wk = state.mealsWeekKey || weekKeyNow();
      await setDoc(doc(db, "households", state.selectedHouseholdId, "mealPlans", wk), {
        weekKey: wk,
        assignments: {},
        updatedAt: serverTimestamp(),
        updatedByUid: state.user.uid
      }, { merge:true });
      toast("Week cleared");
    });
    $("#btnAddWeekToShop")?.addEventListener("click", ()=>{ if(!guardHousehold()) return; openIngredientPickModal({source:"week"}); });



$("#btnToggleArchivedLists")?.addEventListener("click", ()=>{
  state.showArchivedLists = !state.showArchivedLists;
  localStorage.setItem("bb.showArchivedLists", state.showArchivedLists ? "1" : "0");
  renderLists();
});

function openListSettings(list){
  const isWeekly = list.type === "weekly";
  const body = document.createElement("div");
  body.innerHTML = `
    <div class="muted" style="margin-bottom:10px">Manage this list.</div>
    <label class="muted" for="lsName">List name</label>
    <input id="lsName" class="input" value="${escapeHtml(list.name || "List")}" />
    <div class="sep"></div>
    <div class="row wrap">
      ${!isWeekly ? `<button class="btn ${list.archived ? "secondary" : "warn"}" id="lsArchive" type="button">${list.archived ? "Unarchive" : "Archive"}</button>
      <button class="btn danger" id="lsDelete" type="button">Delete</button>` : ``}
      <button class="btn secondary" id="lsSetCurrent" type="button">Set as current</button>
    </div>
    <div class="sep"></div>
    <div class="muted">Weekly Shop can’t be archived or deleted. Archiving hides a list without deleting it.</div>
  `;
  showModal({
    title: "List options",
    body,
    footerButtons: [
      { label:"Close", className:"btn ghost" },
      { label:"Save", className:"btn primary", onClick: async ()=>{
          if(!guardHousehold()) return false;
          const name = ($("#lsName")?.value || "").trim() || (isWeekly ? "Weekly shop" : "List");
          setSync("Sync • Saving…", "warn");
          await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", list.id), {
            name,
            updatedAt: serverTimestamp(),
            updatedByUid: state.user.uid
          });
          toast("Saved");
        }
      }
    ]
  });

  $("#lsSetCurrent")?.addEventListener("click", ()=>{
    setCurrentListId(list.id);
    renderLists();
    toast("Current list set");
    hideModal();
  });

  $("#lsArchive")?.addEventListener("click", async ()=>{
    if(!guardHousehold()) return;
    const to = !list.archived;
    setSync("Sync • Updating…", "warn");
    await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", list.id), {
      archived: to,
      updatedAt: serverTimestamp(),
      updatedByUid: state.user.uid
    });
    toast(to ? "Archived" : "Unarchived");
    hideModal();
    renderLists();
  });


  $("#lsDelete")?.addEventListener("click", async ()=>{
    if(!guardHousehold()) return;
    const ok = await confirmModal({
      title: "Delete list?",
      message: "This permanently deletes the list. (Any sub-items stored under it may remain until we add cascading delete.)",
      confirmLabel: "Delete",
      confirmClass: "danger",
      cancelLabel: "Cancel"
    });
    if(!ok) return;

    setSync("Sync • Deleting…", "warn");
    await deleteDoc(doc(db, "households", state.selectedHouseholdId, "lists", list.id));

    // If it was current, fall back to Weekly (if available)
    if(getCurrentListId() === list.id){
      const weekly = (state.lists || []).find(l=>l.type==="weekly" && !l.archived) || null;
      setCurrentListId(weekly?.id || null);
    }
    toast("List deleted");
    hideModal();
    renderLists();
  });

}


    // === Meals (MVP) ===
    function cleanupMealsSubs(){
      if(state.unsubMeals){ try{state.unsubMeals()}catch{} state.unsubMeals=null; }
      if(state.unsubMealPlan){ try{state.unsubMealPlan()}catch{} state.unsubMealPlan=null; }
      state.meals = [];
      state.mealPlan = { assignments: {} };
      state.mealsWeekKey = null;
    }

    function weekKeyNow(){
      // We plan for the week ahead (next ISO week)
      const now = new Date();
      const d = new Date(now);
      d.setDate(d.getDate() + 7);
      return isoWeekKey(d);
    }

    function mealNorm(s){
      return String(s||"").trim().toLowerCase().replace(/\s+/g," ");
    }


    // Build prompts (room checks) — MVP seed library (global)
    const ROOM_PROMPTS = [
      { id:"kitchen", icon:"🍽️", title:"Kitchen", subtitle:"Wraps, baking, basics", items:[
        { name:"Cling film", categoryKey:"Household", qty:null, unit:"", notes:"" },
        { name:"Tin foil", categoryKey:"Household", qty:null, unit:"", notes:"" },
        { name:"Baking paper", categoryKey:"Household", qty:null, unit:"", notes:"" },
        { name:"Dishwasher tablets", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Dishwasher cleaner", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Washing-up liquid", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Sponges / scourers", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" }
      ]},
      { id:"bathroom", icon:"🧼", title:"Bathroom", subtitle:"Toiletries + personal care", items:[
        { name:"Toothpaste", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Shower gel", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Shampoo", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Conditioner", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Cotton buds", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Toilet roll", categoryKey:"Household", qty:null, unit:"", notes:"" }
      ]},
      
      { id:"bedroom", icon:"🛏️", title:"Bedroom", subtitle:"Hair + personal bits", items:[
        { name:"Deodorant", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Moisturiser", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Condoms", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Dry shampoo", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Hair mousse", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Hair spray", categoryKey:"Toiletries", qty:null, unit:"", notes:"" }
      ]},
{ id:"health", icon:"💊", title:"Health", subtitle:"Medicine cabinet essentials", items:[
        { name:"Painkillers", categoryKey:"Toiletries", qty:null, unit:"", notes:"" },
        { name:"Vitamins", categoryKey:"Toiletries", qty:null, unit:"", notes:"" }
      ]},
      { id:"cleaning", icon:"🧽", title:"Cleaning", subtitle:"The ‘we forgot it’ essentials", items:[
        { name:"Bin bags", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Washing pods / powder", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Fabric softener", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Anti-bac spray", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Bleach", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Washing machine cleaner", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Carpet cleaner", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Polish", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Air freshener", categoryKey:"Cleaning Products", qty:null, unit:"", notes:"" },
        { name:"Kitchen roll", categoryKey:"Household", qty:null, unit:"", notes:"" }
      ]},
      { id:"kids", icon:"🧸", title:"Kids / Baby", subtitle:"Wipes, bedtime, extras", items:[
        { name:"Baby wipes", categoryKey:"Household", qty:null, unit:"", notes:"" },
        { name:"Dry mats (child bed)", categoryKey:"Household", qty:null, unit:"", notes:"" },
        { name:"Nappies", categoryKey:"Household", qty:null, unit:"", notes:"(if needed)" }
      ]},
      { id:"pets", icon:"🐾", title:"Pets", subtitle:"Food + litter", items:[
        { name:"Cat food", categoryKey:"Pets", qty:null, unit:"", notes:"" },
        { name:"Cat litter", categoryKey:"Pets", qty:null, unit:"", notes:"" },
        { name:"Pet treats", categoryKey:"Pets", qty:null, unit:"", notes:"" }
      ]},
      { id:"household", icon:"🏠", title:"Household cupboard", subtitle:"Low-frequency stuff", items:[
        { name:"Light bulbs", categoryKey:"Household", qty:null, unit:"", notes:"" },
        { name:"Batteries", categoryKey:"Household", qty:null, unit:"", notes:"" },
        { name:"Tissues", categoryKey:"Household", qty:null, unit:"", notes:"" },
        { name:"First-aid bits", categoryKey:"Household", qty:null, unit:"", notes:"(if needed)" }
      ]}
    ];


    function categoryIdFromKey(key){
      const k = String(key||"").trim().toLowerCase();
      // Try exact name match first
      const hit = (state.categories||[]).find(c=> String(c.name||"").trim().toLowerCase() === k);
      if(hit) return hit.id;
      // Try contains match (e.g. "Cleaning Products")
      const hit2 = (state.categories||[]).find(c=> String(c.name||"").trim().toLowerCase().includes(k) || k.includes(String(c.name||"").trim().toLowerCase()));
      return hit2 ? hit2.id : null;
    }

    function renderBuildPrompts(){
      const grid = document.getElementById("promptGrid");
      const card = document.getElementById("buildPromptsCard");
      if(!grid || !card) return;
      const cur = getCurrentList();
      if(!state.user || !state.selectedHouseholdId || !cur){
        card.style.display = "none";
        return;
      }
      if(!isWeeklyShopList(cur)){
        card.style.display = "none";
        return;
      }
      card.style.display = "block";
      grid.innerHTML = "";
      for(const r of ROOM_PROMPTS){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "promptCard";
        btn.innerHTML = `
          <div class="promptIcon">${r.icon || "✨"}</div>
          <div class="promptMeta grow">
            <div class="ptitle">${escapeHtml(r.title)}</div>
            <div class="psub">${escapeHtml(r.subtitle || (r.items?.length ? r.items.length + " suggestions" : ""))}</div>
          </div>
          <div class="muted" style="font-weight:900">+</div>
        `;
        btn.addEventListener("click", ()=> openRoomPromptModal(r));
        grid.appendChild(btn);
      }
    }

    async function mergePromptItemsIntoCurrent(items, meta={}){
      const cur = getCurrentList();
      if(!cur){ toast("Select a list first"); setTab("lists"); return; }
      if(!guardHousehold()) return;

      const listId = cur.id;
      const hid = state.selectedHouseholdId;

      setSync("Sync • Adding…", "warn");

      // Build lookup of existing items (from local state if possible, else fetch)
      let existing = (state.items||[]).slice();
      try{
        if(!existing.length){
          const itemsCol = collection(db, "households", hid, "lists", listId, "items");
          const snap = await getDocs(query(itemsCol));
          existing = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        }
      }catch{}

      const map = new Map();
      existing.forEach(it=>{
        const key = mealNorm(it.name);
        if(key) map.set(key, it);
      });

      const batch = writeBatch(db);
      const itemsCol = collection(db, "households", hid, "lists", listId, "items");
      let adds = 0, updates = 0;

      for(const pi of (items||[])){
        const name = String(pi.name||"").trim();
        if(!name) continue;
        const key = mealNorm(name);
        const ex = key ? map.get(key) : null;

        const catId = pi.categoryId || categoryIdFromKey(pi.categoryKey) || null;
        const piQty = (pi.qty===null || pi.qty===undefined || pi.qty==="") ? null : Number(pi.qty);
        const sayUnit = String(pi.unit||"").trim();
        const piUnit = sayUnit || "";

        if(ex){
          const ref = doc(db, "households", hid, "lists", listId, "items", ex.id);
          const exQty = (ex.qty===null || ex.qty===undefined) ? null : Number(ex.qty);
          const exUnit = String(ex.unit||"").trim();

          const patch = { updatedAt: serverTimestamp(), updatedByUid: state.user.uid };
          // Category: only fill if missing
          if(!ex.categoryId && catId) patch.categoryId = catId;

          // Quantity: add if units match, else leave quantity alone (safe MVP)
          if(exQty!==null && piQty!==null){
            if((exUnit||"").toLowerCase() === (piUnit||"").toLowerCase()){
              patch.qty = exQty + piQty;
              if(piUnit && !exUnit) patch.unit = piUnit;
            }
          } else if(exQty===null && piQty!==null){
            patch.qty = piQty;
            if(piUnit && !exUnit) patch.unit = piUnit;
          }

          // Notes: append if provided and not already present
          const piNotes = String(pi.notes||"").trim();
          if(piNotes){
            const exNotes = String(ex.notes||"").trim();
            if(!exNotes) patch.notes = piNotes;
            else if(!exNotes.toLowerCase().includes(piNotes.toLowerCase())) patch.notes = exNotes + " • " + piNotes;
          }

          batch.update(ref, patch);
          updates++;
        }else{
          const ref = doc(itemsCol);
          batch.set(ref, {
            name,
            categoryId: catId || null,
            qty: Number.isFinite(piQty) ? piQty : null,
            unit: piUnit || "",
            notes: String(pi.notes||"").trim(),
            picked: false,
            createdAt: serverTimestamp(),
            createdByUid: state.user.uid,
            updatedAt: serverTimestamp(),
            updatedByUid: state.user.uid
          });
          adds++;
        }
      }

      if(adds || updates){
        await batch.commit();
        setSync("Sync • Up to date", "good");
        toast(`Added ${adds} • Updated ${updates}`);
      }else{
        setSync("Sync • Up to date", "good");
        toast("Nothing to add");
      }
    }

    function openRoomPromptModal(room){
      const cur = getCurrentList();
      if(!cur) return;
      if(!isWeeklyShopList(cur)){
        toast("Quick checks are only available for Weekly Shop.", {ms:2600});
        return;
      }

      const rawItems = (room.items||[]).map((x,i)=>({ ...x, _i:i }));
      const items = rawItems.map(x=>({
        ...x,
        categoryId: x.categoryId || categoryIdFromKey(x.categoryKey) || null
      }));

      const listHtml = items.map((it, idx)=>{
        const cat = categoryLabel(it.categoryId);
        const notes = it.notes ? ` • <span class="muted">${escapeHtml(it.notes)}</span>` : "";
        return `
          <div class="item" data-pr-row data-idx="${idx}">
            <label class="row" style="gap:10px; align-items:flex-start">
              <input type="checkbox" class="pickCheck" data-pr-check checked />
              <div class="grow">
                <div class="title">${escapeHtml(it.name)}</div>
                <div class="sub">${escapeHtml(cat)}${notes}</div>
              </div>
            </label>
          </div>`;
      }).join("");

      showModal({
        title: `${room.title} check`,
        body: `
          <div class="muted">Tick what you need. Duplicates will merge into Weekly Shop.</div>
          <div class="sep"></div>
          <div class="row" style="gap:10px; justify-content:flex-end">
            <button class="btn secondary small" id="prPickAll" type="button">Select all</button>
            <button class="btn ghost small" id="prClearAll" type="button">Clear all</button>
          </div>
          <div class="sep"></div>
          <div style="max-height:52vh; overflow:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--divider); border-radius:16px; padding:8px; background: rgba(255,255,255,.7)">
            <div id="prList" class="list" style="gap:8px">
              ${listHtml || `<div class="muted">No suggestions yet.</div>`}
            </div>
          </div>
        `,
        footerButtons: [
          { label:"Cancel", className:"btn ghost" },
          { label:"Add selected", className:"btn primary", onClick: async ()=>{
              const rows = Array.from($("#prList").querySelectorAll("[data-pr-row]"));
              const picked = [];
              rows.forEach((row)=>{
                const idx = Number(row.getAttribute("data-idx"));
                const chk = row.querySelector("[data-pr-check]");
                if(chk && chk.checked) picked.push(items[idx]);
              });
              if(!picked.length){ toast("Nothing selected.", {ms:1800}); return false; }
              await mergePromptItemsIntoCurrent(picked, { roomId: room.id });
              toast(`Added ${picked.length} item${picked.length===1?"":"s"}.`, {ms:2200});
              return true;
            }
          }
        ]
      });

      // Inline controls
      $("#prPickAll")?.addEventListener("click", ()=>{
        const checks = Array.from(document.querySelectorAll("#prList [data-pr-check]"));
        checks.forEach(c=>{ c.checked = true; });
      });
      $("#prClearAll")?.addEventListener("click", ()=>{
        const checks = Array.from(document.querySelectorAll("#prList [data-pr-check]"));
        checks.forEach(c=>c.checked=false);
      });
    }



    function parseQty(v){
      if(v===null || v===undefined) return null;
      const s = String(v).trim();
      if(!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function mealIngredientLine(it){
      const q = (it.qty===null || it.qty===undefined) ? null : Number(it.qty);
      const u = (it.unit||"").trim();
      if(q===null || Number.isNaN(q)) return u ? u : "";
      return u ? `${q} ${u}` : String(q);
    }

    function attachMealsListeners(){
      if(!state.selectedHouseholdId){ renderMeals(); return; }
      cleanupMealsSubs();

      const mealsCol = collection(db, "households", state.selectedHouseholdId, "meals");
      const mealsQ = query(mealsCol, orderBy("nameLower", "asc"));
      state.unsubMeals = onSnapshot(mealsQ, (snap)=>{
        state.meals = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderMeals();
      }, (err)=>{
        console.error(err);
        toast("Couldn’t load meals (permissions)");
        state.meals = [];
        renderMeals();
      });

      const wk = weekKeyNow();
      state.mealsWeekKey = wk;
      const planRef = doc(db, "households", state.selectedHouseholdId, "mealPlans", wk);
      state.unsubMealPlan = onSnapshot(planRef, (ds)=>{
        const data = ds.exists() ? ds.data() : {};
        state.mealPlan = { assignments: data.assignments || {}, weekKey: wk };
        renderMeals();
      }, (err)=>{
        console.error(err);
        toast("Couldn’t load meal plan (permissions)");
        state.mealPlan = { assignments: {} };
        renderMeals();
      });
    }

    function fmtDayLabel(i){
      const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      return days[i] || "";
    }

    function renderMeals(){
      $("#mealsWeekKey").textContent = state.mealsWeekKey ? fmtWcDate(isoWeekMonday(state.mealsWeekKey)) : "—";

      const emptyPlanner = $("#mealsPlannerEmpty");
      const wrapPlanner = $("#mealsPlannerWrap");
      const daysWrap = $("#plannerDays");

      if(!state.user || !state.selectedHouseholdId){
        emptyPlanner.style.display = "block";
        wrapPlanner.style.display = "none";
        $("#mealsEmpty").style.display = "block";
        $("#mealsWrap").style.display = "none";
        return;
      }

      emptyPlanner.style.display = "none";
      wrapPlanner.style.display = "block";

      // Planner collapse (stored locally per device)
      const collapsed = localStorage.getItem("bb.mealsPlannerCollapsed") === "1";
      const plannerBody = $("#plannerBody");
      const btnToggle = $("#btnTogglePlanner");
      if(plannerBody) plannerBody.style.display = collapsed ? "none" : "block";
      if(btnToggle) btnToggle.textContent = collapsed ? "+" : "–";

      const meals = state.meals || [];
      const opts = [`<option value="">—</option>`, `<option value="__none__">Meal not needed</option>`].concat(meals.map(m=>`<option value="${escapeHtml(m.id)}">${escapeHtml(m.name||"Meal")}</option>`)).join("");

      const assign = state.mealPlan?.assignments || {};
      daysWrap.innerHTML = "";
      for(let i=0;i<7;i++){
        const key = String(i);
        const sel = assign[key] || "";
        const row = document.createElement("div");
        row.className = "dayRow";
        row.innerHTML = `
          <div class="dayLabel">
            <div>${fmtDayLabel(i)}</div>
            <div class="sub">Evening</div>
          </div>
          <div class="grow">
            <select class="select" data-day="${key}">${opts}</select>
          </div>
          <button class="btn danger small" type="button" data-clear data-day="${key}" aria-label="Clear day">×</button>
        `;
        const clearBtn = row.querySelector("button[data-clear]");
        if(clearBtn){ clearBtn.dataset.day = key; clearBtn.addEventListener("click", async (e)=>{ e.preventDefault(); e.stopPropagation(); await setMealForDay(key, ""); }); }
        const select = row.querySelector("select");
        select.value = sel;
        select.addEventListener("change", async (e)=>{
          const mealId = e.target.value || "";
          await setMealForDay(key, mealId);
        });
        daysWrap.appendChild(row);

      }


      const q = ($("#mealSearch").value || "").trim().toLowerCase();
      const list = q ? meals.filter(m=>(m.nameLower||"").includes(q)) : meals;

      const wrap = $("#mealsWrap");
      const empty = $("#mealsEmpty");
      wrap.innerHTML = "";

      if(!list.length){
        empty.style.display = "block";
        wrap.style.display = "none";
      } else {
        empty.style.display = "none";
        wrap.style.display = "flex";

        for(const meal of list){
          const ing = Array.isArray(meal.ingredients) ? meal.ingredients : [];
          const el = document.createElement("div");
          el.className = "item mealItem";
          el.innerHTML = `
            <div class="grow">
              <div class="title">${escapeHtml(meal.name || "Meal")}</div>
              <div class="sub">${ing.length} ingredient${ing.length===1?"":"s"}</div>
            </div>
            <div class="row mealActions">
              <button class="btn secondary small" type="button" data-add-week aria-label="Add to week"><svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path fill="currentColor" d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a3 3 0 0 1 3 3v12a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1V3a1 1 0 0 1 1-1Zm12 8H5v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-9ZM6 6a1 1 0 0 0-1 1v1h14V7a1 1 0 0 0-1-1H6Z"/></svg></button>
              <button class="btn primary small" type="button" data-add-shop>Add to list</button>
              <button class="iconBtn" type="button" data-edit aria-label="Edit">✎</button>
              <button class="btn danger small" type="button" data-del aria-label="Delete">×</button>
            </div>
          `;

          el.querySelector("[data-add-week]")?.addEventListener("click", (e)=>{ e.stopPropagation(); openPickDayModal(meal.id); });
          el.querySelector("[data-add-shop]")?.addEventListener("click", (e)=>{ e.stopPropagation(); openIngredientPickModal({ source:"meal", mealIds:[meal.id] }); });
          el.querySelector("[data-edit]")?.addEventListener("click", (e)=>{ e.stopPropagation(); openMealEditor(meal); });
          el.querySelector("[data-del]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            const ok = await confirmModal({
              title: "Delete meal?",
              message: "This deletes the meal from your library.",
              confirmLabel: "Delete",
              confirmClass: "danger",
              cancelLabel: "Cancel"
            });
            if(!ok) return;
            await deleteDoc(doc(db, "households", state.selectedHouseholdId, "meals", meal.id));
            toast("Meal deleted");
          });

          wrap.appendChild(el);
        }
      }
    }

    async function setMealForDay(dayKey, mealId){
      if(!guardHousehold()) return;
      const wk = state.mealsWeekKey || weekKeyNow();
      const ref = doc(db, "households", state.selectedHouseholdId, "mealPlans", wk);
      const current = (state.mealPlan?.assignments || {});
      const next = { ...current };

      if(mealId){
        // Allow explicit "Meal not needed" marker without duplicate checks
        if(mealId !== "__none__"){
          // Prevent duplicate use of the same meal in the same week planner
          const dupDay = Object.entries(next).find(([k,v])=>k!==String(dayKey) && v===mealId);
          if(dupDay){
            toast("That meal is already planned for another day.");
            renderMeals(); // revert select back to saved state
            return;
          }
        }
        next[String(dayKey)] = mealId;
      } else {
        delete next[String(dayKey)];
      }

      // Optimistic UI update
      state.mealPlan = { ...(state.mealPlan||{}), assignments: next, weekKey: wk };
      renderMeals();

      setSync("Sync • Saving…", "warn");
      try{
        if(mealId){
          await updateDoc(ref, {
            weekKey: wk,
            [`assignments.${String(dayKey)}`]: mealId,
            updatedAt: serverTimestamp(),
            updatedByUid: state.user.uid
          });
        } else {
          await updateDoc(ref, {
            weekKey: wk,
            [`assignments.${String(dayKey)}`]: deleteField(),
            updatedAt: serverTimestamp(),
            updatedByUid: state.user.uid
          });
        }
      } catch(err){
        const msg = String(err||"");
        const code = err?.code || "";
        if(code === "not-found" || msg.includes("No document to update")){
          // First write for this week plan (create doc)
          await setDoc(ref, {
            weekKey: wk,
            assignments: next,
            updatedAt: serverTimestamp(),
            updatedByUid: state.user.uid
          });
        } else {
          throw err;
        }
      }
      setSync("Sync • Up to date", "good");
}

function openPickDayModal(mealId){
      const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      showModal({
        title: "Add to week",
        body: `<div class="muted">Pick a day to assign this meal (evening).</div>
               <div class="sep"></div>
               <div class="list">
                 ${days.map((d,i)=>`<button class="btn secondary" type="button" data-daypick="${i}" style="justify-content:flex-start">${d}</button>`).join("")}
               </div>`,
        footerButtons: [{label:"Close", className:"btn ghost"}]
      });
      const root = $("#modalBody");
      root.querySelectorAll("[data-daypick]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          await setMealForDay(btn.getAttribute("data-daypick"), mealId);
          toast("Added to week");
          hideModal();
        });
      });
    }

    function openMealEditor(meal=null){
      const isEdit = !!meal;
      const name = (meal?.name || "").trim();
      const ingredients = Array.isArray(meal?.ingredients) ? meal.ingredients : [];
      const cats = (state.categories || []).filter(c=>c.id!=="uncategorised");
      const catOptions = cats.map(c=>`<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)}</option>`).join("");

      const rowsHtml = (ingredients.length ? ingredients : [{name:"", qty:null, unit:"", categoryId:"", notes:""}]).map((it, idx)=>{
        const q = (it.qty===null || it.qty===undefined) ? "" : String(it.qty);
        const u = (it.unit||"");
        const n = (it.name||"");
        const notes = (it.notes||"");
        const catId = it.categoryId || "";
        return `
          <div class="card" style="padding:12px; margin:10px 0" data-ing-row="${idx}">
            <div class="row" style="gap:8px; align-items:flex-end">
              <div class="grow field" style="margin:0">
                <label>Ingredient</label>
                <input data-ing-name value="${escapeHtml(n)}" placeholder="e.g. Tomatoes" />
              </div>
              <button class="btn danger small" type="button" data-ing-del>×</button>
            </div>
            <div class="grid2">
              <div class="field">
                <label>Qty</label>
                <input data-ing-qty value="${escapeHtml(q)}" type="number" inputmode="decimal" placeholder="e.g. 2" />
              </div>
              <div class="field">
                <label>Unit</label>
                <input data-ing-unit value="${escapeHtml(u)}" placeholder="e.g. cans" />
              </div>
              <div class="field">
                <label>Category</label>
                <select class="select" data-ing-cat>
                  <option value="">Uncategorised</option>
                  ${catOptions}
                </select>
              </div>
              <div class="field">
                <label>Notes</label>
                <input data-ing-notes value="${escapeHtml(notes)}" placeholder="optional" />
              </div>
            </div>
          </div>`;
      }).join("");

      showModal({
        title: isEdit ? "Edit meal" : "New meal",
        body: `
          <div class="field" style="margin-top:0">
            <label>Meal name</label>
            <input id="mealName" value="${escapeHtml(name)}" placeholder="e.g. Spaghetti Bolognese" />
          </div>
          <div class="sep"></div>
          <div class="h1" style="font-size:14px; margin:0">Ingredients</div>
          <div id="ingWrap">${rowsHtml}</div>
          <button class="btn secondary" id="btnAddIngRow" type="button" style="width:100%; margin-top:10px">+ Add ingredient</button>
        `,
        footerButtons: [
          { label:"Cancel", className:"btn ghost" },
          { label: isEdit ? "Save" : "Create", className:"btn primary", onClick: async ()=>{
              const mealName = ($("#mealName").value || "").trim();
              if(!mealName){ toast("Please enter a meal name"); return false; }

              const ingRows = Array.from($("#ingWrap").querySelectorAll("[data-ing-row]"));
              const out = [];
              for(const row of ingRows){
                const nm = (row.querySelector("[data-ing-name]")?.value || "").trim();
                if(!nm) continue;
                const qty = parseQty(row.querySelector("[data-ing-qty]")?.value);
                const unit = (row.querySelector("[data-ing-unit]")?.value || "").trim();
                const categoryId = (row.querySelector("[data-ing-cat]")?.value || "").trim() || null;
                const notes = (row.querySelector("[data-ing-notes]")?.value || "").trim();
                out.push({ name: nm, nameLower: mealNorm(nm), qty, unit, categoryId, notes });
              }
              if(!out.length){ toast("Add at least one ingredient"); return false; }

              setSync("Sync • Saving…", "warn");
              const payload = {
                name: mealName,
                nameLower: mealNorm(mealName),
                ingredients: out,
                updatedAt: serverTimestamp(),
                updatedByUid: state.user.uid
              };
              if(!isEdit){
                payload.createdAt = serverTimestamp();
                payload.createdByUid = state.user.uid;
                await addDoc(collection(db, "households", state.selectedHouseholdId, "meals"), payload);
                toast("Meal created");
              } else {
                await setDoc(doc(db, "households", state.selectedHouseholdId, "meals", meal.id), payload, { merge:true });
                toast("Meal saved");
              }
              setSync("Sync • Up to date", "good");
            }}
        ]
      });

      const wrap = $("#ingWrap");
      Array.from(wrap.querySelectorAll("[data-ing-row]")).forEach((row, i)=>{
        const it = ingredients[i] || {};
        const sel = row.querySelector("[data-ing-cat]");
        if(sel) sel.value = (it.categoryId || "");
        row.querySelector("[data-ing-del]")?.addEventListener("click", ()=>{ row.remove(); });
      });

      $("#btnAddIngRow")?.addEventListener("click", ()=>{
        const div = document.createElement("div");
        div.className = "card";
        div.style.padding = "12px";
        div.style.margin = "10px 0";
        div.setAttribute("data-ing-row", String(wrap.querySelectorAll("[data-ing-row]").length));
        div.innerHTML = `
          <div class="row" style="gap:8px; align-items:flex-end">
            <div class="grow field" style="margin:0">
              <label>Ingredient</label>
              <input data-ing-name placeholder="e.g. Tomatoes" />
            </div>
            <button class="btn danger small" type="button" data-ing-del>×</button>
          </div>
          <div class="grid2">
            <div class="field">
              <label>Qty</label>
              <input data-ing-qty type="number" inputmode="decimal" placeholder="e.g. 2" />
            </div>
            <div class="field">
              <label>Unit</label>
              <input data-ing-unit placeholder="e.g. cans" />
            </div>
            <div class="field">
              <label>Category</label>
              <select class="select" data-ing-cat>
                <option value="">Uncategorised</option>
                ${catOptions}
              </select>
            </div>
            <div class="field">
              <label>Notes</label>
              <input data-ing-notes placeholder="optional" />
            </div>
          </div>
        `;
        div.querySelector("[data-ing-del]")?.addEventListener("click", ()=> div.remove());
        wrap.appendChild(div);
        div.querySelector("[data-ing-name]")?.focus?.();
      });
    }

    function collectIngredientsForMeals(mealIds){
      const byMeal = new Map((state.meals||[]).map(m=>[m.id, m]));
      const ingredients = [];
      for(const id of mealIds){
        const meal = byMeal.get(id);
        if(!meal) continue;
        const ing = Array.isArray(meal.ingredients) ? meal.ingredients : [];
        for(const it of ing){
          const nm = (it.name || "").trim();
          if(!nm) continue;
          ingredients.push({
            name: nm,
            nameLower: mealNorm(nm),
            qty: (it.qty===null || it.qty===undefined) ? null : Number(it.qty),
            unit: (it.unit||"").trim(),
            categoryId: it.categoryId || null,
            notes: (it.notes||"").trim(),
            sourceMealId: id
          });
        }
      }
      return ingredients;
    }

    function aggregateForPicker(raw){
      const map = new Map();
      for(const it of raw){
        const key = `${it.nameLower}__${(it.unit||"").toLowerCase()}`;
        if(!map.has(key)){
          map.set(key, { ...it, qty: it.qty, notes: it.notes, sources: new Set([it.sourceMealId]) });
        } else {
          const cur = map.get(key);
          if(cur.qty!==null && it.qty!==null && (cur.unit||"").toLowerCase() === (it.unit||"").toLowerCase()){
            cur.qty = (Number(cur.qty)||0) + (Number(it.qty)||0);
          }
          if(it.notes){
            cur.notes = cur.notes ? (cur.notes + "; " + it.notes) : it.notes;
          }
          cur.sources.add(it.sourceMealId);
        }
      }
      return Array.from(map.values()).map(x=>({ ...x, sources: Array.from(x.sources) }));
    }

    async function ensureWeeklyListId(){
      const weekly = (state.lists || []).find(l=>l.type==="weekly" && !l.archived) || null;
      if(weekly) return weekly.id;
      const ref = await addDoc(collection(db, "households", state.selectedHouseholdId, "lists"), {
        name: "Weekly Shop",
        type: "weekly",
        pinned: true,
        archived: false,
        createdAt: serverTimestamp(),
        createdByUid: state.user.uid,
        updatedAt: serverTimestamp(),
        updatedByUid: state.user.uid,
        weekKey: isoWeekKey(new Date())
      });
      return ref.id;
    }

    async function openIngredientPickModal({source="meal", mealIds=[]}={}){
      if(!guardHousehold()) return;

      let ids = mealIds;
      if(source==="week"){
        const a = state.mealPlan?.assignments || {};
        ids = Object.values(a).filter(v=>v && v!=="__none__");
      }
      ids = Array.from(new Set(ids));
      if(!ids.length){ toast("No meals selected"); return; }

      const raw = collectIngredientsForMeals(ids);
      if(!raw.length){ toast("No ingredients found"); return; }

      const items = aggregateForPicker(raw);
      const catsMap = new Map((state.categories||[]).map(c=>[c.id, c.name]));
      const mealMap = new Map((state.meals||[]).map(m=>[m.id, m.name||"Meal"]));

      const listHtml = items.map((it)=>{
        const qtyLine = mealIngredientLine(it);
        const cat = it.categoryId ? (catsMap.get(it.categoryId) || "Uncategorised") : "Uncategorised";
        const notes = it.notes ? ` • ${escapeHtml(it.notes)}` : "";
        const sources = it.sources?.length ? ` • ${escapeHtml(it.sources.map(id=>mealMap.get(id)||"Meal").join(", "))}` : "";
        return `
          <div class="item" style="padding:12px" data-pick-row>
            <label style="display:flex; gap:10px; align-items:flex-start; width:100%">
              <input type="checkbox" data-pick-check class="pickCheck" checked />
              <div class="grow">
                <div class="title">${escapeHtml(it.name)}</div>
                <div class="sub">${qtyLine ? escapeHtml(qtyLine) + " • " : ""}${escapeHtml(cat)}${notes}${sources}</div>
              </div>
            </label>
          </div>`;
      }).join("");

      showModal({
        title: "Add to Weekly Shop",
        body: `
          <div class="muted">Tick what you need. Duplicates will merge.</div>
          <div class="sep"></div>
          <div class="row" style="gap:10px; justify-content:flex-end">
            <button class="btn secondary small" id="pickAll" type="button">Add all</button>
            <button class="btn ghost small" id="clearAll" type="button">Clear all</button>
          </div>
          <div class="sep"></div>
          <div id="pickListWrap" style="max-height:52vh; overflow:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--divider); border-radius:16px; padding:8px; background: rgba(255,255,255,.7)">
            <div id="pickList" class="list" style="gap:8px">${listHtml}</div>
          </div>
        `,
        footerButtons: [
          { label:"Cancel", className:"btn ghost" },
          { label:"Add selected", className:"btn primary", onClick: async ()=>{
              const rows = Array.from($("#pickList").querySelectorAll("[data-pick-row]"));
              const selected = [];
              rows.forEach((row, i)=>{
                const chk = row.querySelector("[data-pick-check]");
                if(chk && chk.checked) selected.push(items[i]);
              });
              if(!selected.length){ toast("Nothing selected"); return false; }
              await mergeIngredientsIntoWeekly(selected);
              toast("Added ingredients to Weekly Shop");
            }}
        ]
      });

      $("#pickAll")?.addEventListener("click", ()=>{
        $("#pickList").querySelectorAll("[data-pick-check]").forEach(c=>c.checked = true);
      });
      $("#clearAll")?.addEventListener("click", ()=>{
        $("#pickList").querySelectorAll("[data-pick-check]").forEach(c=>c.checked = false);
      });
    }

    async function mergeIngredientsIntoWeekly(ings){
      if(!guardHousehold()) return;
      setSync("Sync • Adding…", "warn");

      const listId = await ensureWeeklyListId();
      const itemsCol = collection(db, "households", state.selectedHouseholdId, "lists", listId, "items");

      const snap = await getDocs(query(itemsCol));
      const mealNameMap = new Map((state.meals||[]).map(m=>[m.id, m.name||"Meal"]));
      const existing = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const map = new Map();
      existing.forEach(it=>{
        const key = mealNorm(it.name);
        if(key) map.set(key, it);
      });

      for(const ing of ings){
        const key = mealNorm(ing.name);
        if(!key) continue;
        const ex = map.get(key) || null;

        const ingQty = (ing.qty===null || ing.qty===undefined) ? null : Number(ing.qty);
        const ingUnit = (ing.unit||"").trim();
        const ingCat = ing.categoryId || null;
        const ingNotes = (ing.notes||"").trim();

        if(ex){
          const exQty = (ex.qty===null || ex.qty===undefined) ? null : Number(ex.qty);
          const exUnit = (ex.unit||"").trim();

          const updates = { updatedAt: serverTimestamp(), updatedByUid: state.user.uid };

          // Meal tags (for reporting/clarity)
          const newTags = (ing.sources||[]).map(id=>mealNameMap.get(id)||"Meal");
          const prevTags = Array.isArray(ex.mealTags) ? ex.mealTags : [];
          const mergedTags = Array.from(new Set(prevTags.concat(newTags))).filter(Boolean);
          if(mergedTags.length) updates.mealTags = mergedTags;

          if(exQty!==null && ingQty!==null && exUnit && ingUnit && exUnit.toLowerCase()===ingUnit.toLowerCase()){
            updates.qty = exQty + ingQty;
          } else if(exQty===null && ingQty!==null && (!exUnit || exUnit.toLowerCase()===ingUnit.toLowerCase())){
            updates.qty = ingQty;
            if(ingUnit && !exUnit) updates.unit = ingUnit;
          } else if(ingQty!==null || ingNotes){
            const needed = ingQty!==null ? `${ingQty}${ingUnit ? " "+ingUnit : ""}` : "";
            const extra = needed ? `Needed: ${needed}` : "";
            const toAppend = [extra, ingNotes].filter(Boolean).join(extra && ingNotes ? " — " : "");
            if(toAppend){
              const prev = (ex.notes || "").trim();
              updates.notes = prev ? (prev + "; " + toAppend) : toAppend;
            }
          }

          if(ingCat && !ex.categoryId){
            updates.categoryId = ingCat;
          }

          await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", listId, "items", ex.id), updates);

        } else {
          const payload = {
            name: ing.name,
            categoryId: ingCat,
            qty: (ingQty!==null && Number.isFinite(ingQty)) ? ingQty : null,
            unit: ingUnit,
            notes: ingNotes,
            mealTags: Array.from(new Set((ing.sources||[]).map(id=>mealNameMap.get(id)||"Meal"))).filter(Boolean),
            picked: false,
            pickedAt: null,
            priceEach: null,
            costTotal: null,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            addedByUid: state.user.uid,
            updatedByUid: state.user.uid
          };
          const ref = await addDoc(itemsCol, payload);
          map.set(key, { id: ref.id, ...payload });
        }
      }

      setSync("Sync • Up to date", "good");
    }


// === ISO week helpers + Weekly reset flow ===
function isoWeekKey(d){
  // Returns YYYY-Www (ISO week date)
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  const yyyy = date.getUTCFullYear();
  const ww = String(weekNo).padStart(2, "0");
  return `${yyyy}-W${ww}`;
}
    
    function isoWeekMonday(weekKey){
      // weekKey like "2026-W05"
      const m = String(weekKey||"").match(/^(\d{4})-W(\d{2})$/);
      if(!m) return null;
      const year = Number(m[1]);
      const week = Number(m[2]);
      // ISO week 1 is the week with Jan 4th
      const jan4 = new Date(Date.UTC(year, 0, 4));
      const day = jan4.getUTCDay() || 7; // Mon=1..Sun=7
      const mon1 = new Date(jan4);
      mon1.setUTCDate(jan4.getUTCDate() - (day - 1));
      const mon = new Date(mon1);
      mon.setUTCDate(mon1.getUTCDate() + (week - 1) * 7);
      // Return local Date (date-only) to avoid DST drift in rendering
      return new Date(mon.getUTCFullYear(), mon.getUTCMonth(), mon.getUTCDate());
    }

    function fmtWcDate(d){
      if(!d) return "—";
      const dd = String(d.getDate()).padStart(2,"0");
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const mm = months[d.getMonth()] || "";
      const yy = d.getFullYear();
      return `W/C ${dd} ${mm} ${yy}`;
    }

function localDateKey(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function isMondayMorning(d){
  // “Monday morning” for MVP: Monday and between 05:00 and 12:00 local device time
  const dow = d.getDay(); // 1 = Monday
  const h = d.getHours();
  return dow === 1 && h >= 5 && h < 12;
}

async function scheduleWeeklyResetCheck(){
  // defer a little so listeners have populated state.lists/state.config
  setTimeout(()=> weeklyResetCheck().catch(()=>{}), 400);
}

async function weeklyResetCheck(opts={}){
  if(!state.user || !state.selectedHouseholdId) return;
  const now = new Date();
  const force = !!opts.force;
  if(!force && !isMondayMorning(now)) return;

  const today = localDateKey(now);
  if(!force && localStorage.getItem("bb.weeklyResetPromptDate") === today) return;

  const weekly = (state.lists || []).find(l=>l.type==="weekly" && !l.archived) || null;
  if(!weekly) return;

  const currentKey = isoWeekKey(now);
  const storedKey = weekly.weekKey || null;

  // First time we see it, just initialise weekKey (no prompt)
  if(!storedKey && !force){
    await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", weekly.id), {
      weekKey: currentKey,
      updatedAt: serverTimestamp(),
      updatedByUid: state.user.uid
    });
    return;
  }
  if(!force && storedKey === currentKey) return;

  if(!force) localStorage.setItem("bb.weeklyResetPromptDate", today);

  const okReset = await confirmModal({
    title: "New week, new shop?",
    message: "It’s a new week. Do you want to reset Weekly Shop back to your template, or carry the current list forward?",
    confirmLabel: "Reset to template",
    confirmClass: "warn",
    cancelLabel: "Carry forward"
  });

  if(okReset){
    await resetWeeklyShopToTemplate(state.selectedHouseholdId, weekly.id, currentKey);
    toast("Weekly Shop reset");
  }else{
    await updateDoc(doc(db, "households", state.selectedHouseholdId, "lists", weekly.id), {
      weekKey: currentKey,
      updatedAt: serverTimestamp(),
      updatedByUid: state.user.uid
    });
    toast("Carried forward");
  }
}

async function resetWeeklyShopToTemplate(hid, weeklyListId, weekKey){
  if(!state.user) return;
  setSync("Sync • Resetting Weekly Shop…", "warn");

  // Load latest template
  const cfgSnap = await getDoc(doc(db, "households", hid, "settings", "config"));
  const cfg = cfgSnap.exists() ? cfgSnap.data() : {};
  const tpl = Array.isArray(cfg.weeklyTemplate) ? cfg.weeklyTemplate : [];

  // Delete all current items (batch in chunks)
  const itemsCol = collection(db, "households", hid, "lists", weeklyListId, "items");
  let qy = query(itemsCol, limit(200));
  while(true){
    const snap = await getDocs(qy);
    if(snap.empty) break;
    const batch = writeBatch(db);
    snap.docs.forEach(d=> batch.delete(d.ref));
    await batch.commit();
    if(snap.size < 200) break;
  }

  // Recreate from template (unchecked)
  for(const t of tpl){
    const name = (t.name || "").trim();
    if(!name) continue;
    await addDoc(itemsCol, {
      name,
      categoryId: t.categoryId || null,
      qty: typeof t.qty === "number" ? t.qty : (t.qty ? Number(t.qty) : null),
      unit: t.unit || "",
      notes: t.notes || "",
      picked: false,
      pickedAt: null,
      priceEach: null,
      costTotal: null,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      addedByUid: state.user.uid,
      updatedByUid: state.user.uid
    });
  }

  await updateDoc(doc(db, "households", hid, "lists", weeklyListId), {
    weekKey,
    updatedAt: serverTimestamp(),
    updatedByUid: state.user.uid
  });

  setSync("Sync • Up to date", "good");
}

    function guardHousehold(){
      if(!state.user){
        toast("Please sign in first");
        setTab("account");
        return false;
      }
      if(!state.selectedHouseholdId){
        toast("Select a household first");
        setTab("account");
        return false;
      }
      return true;
    }

    // === Household create/join (baseline) ===
    const DEFAULT_CATEGORIES = [
      "Fruit & Veg",
      "Meat & Fish",
      "Dairy",
      "Bakery",
      "Cereals & Breakfast",
      "Cupboard",
      "Frozen",
      "Treats & Snacks",
      "Drinks",
      "Cleaning Products",
      "Toiletries",
      "Pets",
      "Household",
      "Baby",
      "Health & Pharmacy",
      "Uncategorised"
    ];

    // === Invites (owner-only) ===
    let unsubInvites = null;

    function makeInviteCode(len=6){
      // Avoid ambiguous characters
      const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      const bytes = new Uint8Array(len);
      crypto.getRandomValues(bytes);
      let out = "";
      for(let i=0;i<len;i++){
        out += alphabet[bytes[i] % alphabet.length];
      }
      return out;
    }

    function stopInvitesListener(){
      if(unsubInvites){ try{unsubInvites()}catch{} }
      unsubInvites = null;
    }

    function setInvitesUIState(){
      const guard = $("#invitesGuard");
      const ownerOnly = $("#invitesOwnerOnly");
      const block = $("#invitesBlock");

      if(!guard || !ownerOnly || !block) return;

      if(!state.user){
        guard.style.display = "block";
        guard.textContent = "Sign in to manage invites.";
        ownerOnly.style.display = "none";
        block.style.display = "none";
        stopInvitesListener();
        return;
      }
      if(!state.selectedHouseholdId){
        guard.style.display = "block";
        guard.textContent = "Select a household to manage invites.";
        ownerOnly.style.display = "none";
        block.style.display = "none";
        stopInvitesListener();
        return;
      }
      guard.style.display = "none";

      if(state.selectedRole !== "owner"){
        ownerOnly.style.display = "block";
        block.style.display = "none";
        stopInvitesListener();
        return;
      }
      ownerOnly.style.display = "none";
      block.style.display = "block";
    }

    function startInvitesListener(){
      
      if(!(state.user && state.selectedHouseholdId && state.selectedRole==="owner")) return;

      stopInvitesListener();
      const qy = query(
        collection(db, "invites"),
        where("householdId", "==", state.selectedHouseholdId),
        where("active", "==", true),
        limit(10)
      );

      unsubInvites = onSnapshot(qy, (snap)=>{
        const invites = snap.docs.map(d=>({ code: d.id, ...d.data() }));
        renderInvites(invites);
      }, (err)=>{
        console.error(err);
        toast("Couldn’t load invites (permissions)", {ms: 3200});
      });
    }

    function renderInvites(invites){
      const list = $("#invitesList");
      const empty = $("#invitesEmpty");
      if(!list || !empty) return;

      list.innerHTML = "";

      if(!invites.length){
        empty.style.display = "block";
        list.style.display = "none";
        return;
      }
      empty.style.display = "none";
      list.style.display = "flex";

      invites.forEach(inv=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="grow">
            <div class="title">Invite code: ${escapeHtml(inv.code)}</div>
            <div class="sub">Active • Share this code to join</div>
          </div>
          <button class="btn secondary small" type="button" data-copy>Copy</button>
          <button class="btn danger small" type="button" data-deactivate>Disable</button>
        `;
        el.querySelector("[data-copy]").addEventListener("click", async (e)=>{
          e.stopPropagation();
          try{
            await navigator.clipboard.writeText(inv.code);
            toast("Invite code copied");
          }catch{
            toast("Couldn’t copy — you can select and copy manually", {ms: 3200});
          }
        });
        el.querySelector("[data-deactivate]").addEventListener("click", async (e)=>{
          e.stopPropagation();
          showModal({
            title: "Disable invite?",
            body: `<div class="muted">This code will stop working immediately.</div>`,
            footerButtons: [
              { label:"Cancel", className:"btn ghost" },
              { label:"Disable", className:"btn danger", onClick: async ()=>{
                  setSync("Sync • Updating invite…", "warn");
                  await updateDoc(doc(db, "invites", inv.code), { active: false });
                  toast("Invite disabled");
                }
              }
            ]
          });
        });
        list.appendChild(el);
      });
    }

    $("#btnCreateInvite")?.addEventListener("click", async ()=>{
      if(!(state.user && state.selectedHouseholdId)) { toast("Select a household first"); return; }
      if(state.selectedRole !== "owner"){ toast("Only the owner can create invites"); return; }

      setSync("Sync • Creating invite…", "warn");
      let code = null;
      for(let i=0;i<3;i++){
        const c = makeInviteCode(6);
        const snap = await getDoc(doc(db, "invites", c));
        if(!snap.exists()){ code = c; break; }
      }
      if(!code){ toast("Couldn’t generate a code — try again"); setSync("Sync • Up to date", "good"); return; }

      await setDoc(doc(db, "invites", code), {
        householdId: state.selectedHouseholdId,
        active: true,
        createdAt: serverTimestamp(),
        createdByUid: state.user.uid
      });

      showModal({
        title: "Invite code created",
        body: `
          <div class="muted" style="margin-bottom:10px">Share this code so someone can join your household.</div>
          <div class="card flat" style="margin:0; padding:12px; border-radius:14px; border:1px solid var(--divider);">
            <div style="font-weight:900; font-size:22px; letter-spacing:2px; text-align:center">${code}</div>
          </div>
          <div class="muted" style="margin-top:10px">Tip: codes can be disabled at any time.</div>
        `,
        footerButtons: [
          { label:"Copy", className:"btn primary", onClick: async ()=>{
              try{ await navigator.clipboard.writeText(code); toast("Invite code copied"); }catch{}
            }
          },
          { label:"Done", className:"btn ghost" }
        ]
      });
    });


    // === Household settings (modal) listeners ===
    let unsubHSMembers = null;
    let unsubHSInvites = null;

    function stopHouseholdSettingsListeners(){
      if(unsubHSMembers){ try{unsubHSMembers()}catch{} }
      if(unsubHSInvites){ try{unsubHSInvites()}catch{} }
      unsubHSMembers = null;
      unsubHSInvites = null;
    }

    async function removeMember(hid, memberUid){
      if(state.selectedRole !== "owner") throw new Error("Only the owner can manage members");
      if(memberUid === state.user?.uid) throw new Error("You can’t remove yourself");
      await deleteDoc(doc(db, "households", hid, "members", memberUid));
      // Best effort: remove their per-user index entry too
      try{ await deleteDoc(doc(db, "users", memberUid, "households", hid)); }catch{}
    }

    async function leaveHousehold(hid){
      if(!state.user) throw new Error("Not signed in");
      if(state.selectedRole === "owner") throw new Error("Owners can’t leave (transfer ownership first)");
      const uid = state.user.uid;
      await deleteDoc(doc(db, "households", hid, "members", uid));
      await deleteDoc(doc(db, "users", uid, "households", hid));

      if(state.selectedHouseholdId === hid){
        state.selectedHouseholdId = null;
        state.selectedHouseholdName = null;
        state.selectedRole = null;
        localStorage.removeItem("bb.selectedHouseholdId");
        setCurrentListId(null);
        cleanupHouseholdSubs();
        state.lists = [];
        renderLists();
        setCtx();
      }
      renderHouseholds();
    }

    function startHouseholdSettingsListeners(hid, role){
      stopHouseholdSettingsListeners();

      // Members
      const membersEmpty = $("#hsMembersEmpty");
      const membersList = $("#hsMembersList");

      unsubHSMembers = onSnapshot(collection(db, "households", hid, "members"), (snap)=>{
        const members = snap.docs.map(d=>({ uid: d.id, ...d.data() }));
        if(!membersEmpty || !membersList) return;
        membersList.innerHTML = "";

        if(!members.length){
          membersEmpty.style.display = "block";
          membersEmpty.textContent = "No members found.";
          membersList.style.display = "none";
          return;
        }

        membersEmpty.style.display = "none";
        membersList.style.display = "flex";

        for(const m of members){
          const isSelf = m.uid === state.user?.uid;
          const mRole = m.role || "member";
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="grow">
              <div class="title">${isSelf ? "You" : "Member"} <span class="muted" style="font-weight:700">(${escapeHtml(mRole)})</span></div>
              <div class="sub">${escapeHtml(m.uid)}</div>
            </div>
            ${role==="owner" && !isSelf ? `<button class="btn danger small" type="button" data-remove>Remove</button>` : ``}
          `;
          row.querySelector("[data-remove]")?.addEventListener("click", (e)=>{
            e.stopPropagation();
            showModal({
              title: "Remove member?",
              body: `<div class="muted">They will lose access to this household.</div>`,
              footerButtons: [
                {label:"Cancel", className:"btn ghost"},
                {label:"Remove", className:"btn danger", onClick: async ()=>{
                  setSync("Sync • Removing member…", "warn");
                  await removeMember(hid, m.uid);
                  toast("Member removed");
                }}
              ]
            });
          });
          membersList.appendChild(row);
        }
      }, (err)=>{
        console.error(err);
        if(membersEmpty) {
          membersEmpty.style.display = "block";
          membersEmpty.textContent = "Couldn’t load members (permissions).";
        }
        if(membersList) membersList.style.display = "none";
      });

      // Invites (owner only)
      const guard = $("#hsInvitesGuard");
      const block = $("#hsInvitesBlock");
      const list = $("#hsInvitesList");
      const empty = $("#hsInvitesEmpty");
      const btn = $("#hsCreateInvite");

      if(role !== "owner"){
        if(guard) guard.style.display = "block";
        if(block) block.style.display = "none";
        return;
      }
      if(guard) guard.style.display = "none";
      if(block) block.style.display = "block";

      const qy = query(
        collection(db, "invites"),
        where("householdId", "==", hid),
        where("active", "==", true),
        limit(10)
      );

      unsubHSInvites = onSnapshot(qy, (snap)=>{
        const invites = snap.docs.map(d=>({ code: d.id, ...d.data() }));
        if(!list || !empty) return;

        list.innerHTML = "";
        if(!invites.length){
          empty.style.display = "block";
          list.style.display = "none";
          return;
        }
        empty.style.display = "none";
        list.style.display = "flex";

        for(const inv of invites){
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="grow">
              <div class="title">Invite code: ${escapeHtml(inv.code)}</div>
              <div class="sub">Active • Share to join</div>
            </div>
            <button class="btn secondary small" type="button" data-copy>Copy</button>
            <button class="btn danger small" type="button" data-disable>Disable</button>
          `;
          row.querySelector("[data-copy]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            try{
              await navigator.clipboard.writeText(inv.code);
              toast("Invite code copied");
            }catch{
              toast("Couldn’t copy — you can select and copy manually", {ms: 3200});
            }
          });
          row.querySelector("[data-disable]")?.addEventListener("click", (e)=>{
            e.stopPropagation();
            showModal({
              title: "Disable invite?",
              body: `<div class="muted">This code will stop working immediately.</div>`,
              footerButtons: [
                {label:"Cancel", className:"btn ghost"},
                {label:"Disable", className:"btn danger", onClick: async ()=>{
                  setSync("Sync • Updating invite…", "warn");
                  await updateDoc(doc(db, "invites", inv.code), { active:false });
                  toast("Invite disabled");
                }}
              ]
            });
          });
          list.appendChild(row);
        }
      }, (err)=>{
        console.error(err);
        toast("Couldn’t load invites (permissions)", {ms: 3200});
      });

      // Create invite button (bind once per modal open)
      btn?.addEventListener("click", async ()=>{
        if(state.selectedRole !== "owner"){ toast("Only the owner can create invites"); return; }

        setSync("Sync • Creating invite…", "warn");
        let code = null;
        for(let i=0;i<3;i++){
          const c = makeInviteCode(6);
          const snap = await getDoc(doc(db, "invites", c));
          if(!snap.exists()){ code = c; break; }
        }
        if(!code){ toast("Couldn’t generate a code — try again"); setSync("Sync • Up to date", "good"); return; }

        await setDoc(doc(db, "invites", code), {
          householdId: hid,
          active: true,
          createdAt: serverTimestamp(),
          createdByUid: state.user.uid
        });

        showModal({
          title: "Invite code created",
          body: `
            <div class="muted" style="margin-bottom:10px">Share this code so someone can join <b>${escapeHtml(state.selectedHouseholdName || "this household")}</b>.</div>
            <div class="card flat" style="margin:0; padding:12px; border-radius:14px; border:1px solid var(--divider);">
              <div style="font-weight:900; font-size:22px; letter-spacing:2px; text-align:center">${code}</div>
            </div>
          `,
          footerButtons: [
            {label:"Copy", className:"btn primary", onClick: async ()=>{ try{ await navigator.clipboard.writeText(code); toast("Invite code copied"); }catch{} }},
            {label:"Done", className:"btn ghost"}
          ]
        });
      }, { once:true });
    }





    
$("#btnAddCategory")?.addEventListener("click", ()=> addCategory());

$("#btnAddTplItem")?.addEventListener("click", ()=>{
  if(!guardHousehold()) return;
  openTemplateItemModal(null);
});

$("#btnResetWeeklyNow")?.addEventListener("click", async ()=>{
  if(!guardHousehold()) return;
  const weekly = (state.lists || []).find(l=>l.type==="weekly" && !l.archived) || null;
  if(!weekly){ toast("No Weekly Shop list found"); return; }
  const ok = await confirmModal({
    title:"Reset Weekly Shop now?",
    message:"This will clear the current Weekly Shop items and restore your template.",
    confirmLabel:"Reset",
    confirmClass:"warn"
  });
  if(!ok) return;
  await resetWeeklyShopToTemplate(state.selectedHouseholdId, weekly.id, isoWeekKey(new Date()));
  toast("Weekly Shop reset");
});

$("#btnTestWeeklyPrompt")?.addEventListener("click", async ()=>{
  if(!guardHousehold()) return;
  // Force-show the reset prompt regardless of day/week
  await weeklyResetCheck({force:true});
});


$("#btnCreateHousehold").addEventListener("click", async ()=>{
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="muted" style="margin-bottom:10px">Create a shared household space for your lists.</div>
        <label class="muted" for="hhName">Household name</label>
        <input id="hhName" class="input" placeholder="e.g., The Kerrs" />
      `;
      showModal({
        title: "Create household",
        body,
        footerButtons: [
          { label:"Cancel", className:"btn ghost", onClick: ()=>true },
          { label:"Create", className:"btn primary", onClick: async ()=>{
              if(!state.user) return false;
              const name = ($("#hhName")?.value || "").trim() || "My household";
              setSync("Sync • Creating household…", "warn");

              // Create household doc
              const hid = crypto.randomUUID();
              const batch = writeBatch(db);

              batch.set(doc(db, "households", hid), {
                name,
                createdAt: serverTimestamp(),
                createdByUid: state.user.uid
              });

              // Member doc (owner)
              batch.set(doc(db, "households", hid, "members", state.user.uid), {
                uid: state.user.uid,
                role: "owner",
                joinedAt: serverTimestamp()
              });

              // Per-user index
              batch.set(doc(db, "users", state.user.uid, "households", hid), {
                householdId: hid,
                householdName: name,
                role: "owner",
                joinedAt: serverTimestamp()
              });

              // Seed categories (ordered)
              DEFAULT_CATEGORIES.forEach((cat, idx)=>{
                const cid = crypto.randomUUID();
                batch.set(doc(db, "households", hid, "categories", cid), {
                  name: cat,
                  order: idx,
                  archived: false,
                  createdAt: serverTimestamp(),
                  createdByUid: state.user.uid
                });
              });

              // Weekly template + settings placeholder
              batch.set(doc(db, "households", hid, "settings", "config"), {
                schemaVersion: 1,
                weeklyTemplate: [],
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                updatedByUid: state.user.uid
              }, { merge: true });

              // Create default Weekly shop list (pinned)
              const weeklyListId = crypto.randomUUID();
              batch.set(doc(db, "households", hid, "lists", weeklyListId), {
                name: "Weekly shop",
                type: "weekly",
                pinned: true,
                archived: false,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                createdByUid: state.user.uid,
                updatedByUid: state.user.uid
              });

              await batch.commit();

              toast("Household created");
              // Select it
              await refreshUserHouseholdsAndSelect(hid);
            }
          }
        ]
      });
      setTimeout(()=> $("#hhName")?.focus(), 50);
    });

    async function refreshUserHouseholdsAndSelect(hid){
      // The snapshot listener will pick it up shortly; we can preselect now.
      state.selectedHouseholdId = hid;
      localStorage.setItem("bb.selectedHouseholdId", hid);
      // Try to find name from existing array (may not yet include it)
      const found = state.households.find(x=>x.householdId===hid);
      state.selectedHouseholdName = found?.householdName || state.selectedHouseholdName;
      setCtx();
      await loadSelectedHousehold();
      setTab("lists");

    }

    $("#btnJoinHousehold").addEventListener("click", async ()=>{
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="muted" style="margin-bottom:10px">Enter an invite code shared by the household owner.</div>
        <label class="muted" for="inviteCode">Invite code</label>
        <input id="inviteCode" class="input" placeholder="e.g., Q8K2J4" autocapitalize="characters" />
      `;
      showModal({
        title: "Join household",
        body,
        footerButtons: [
          { label:"Cancel", className:"btn ghost" },
          { label:"Join", className:"btn primary", onClick: async ()=>{
              if(!state.user) return false;
              const code = ($("#inviteCode")?.value || "").trim();
              if(!code){ toast("Enter a code"); return false; }

              setSync("Sync • Checking code…", "warn");
              const invRef = doc(db, "invites", code);
              const invSnap = await getDoc(invRef);
              if(!invSnap.exists()){ toast("Invalid code"); setSync("Sync • Up to date", "good"); return false; }
              const inv = invSnap.data();
              if(!inv.active){ toast("Invite is inactive"); setSync("Sync • Up to date", "good"); return false; }
              const hid = inv.householdId;

              // Create membership + index if missing
              const batch = writeBatch(db);

              // Member (member role by default; rules will prevent owner self-downgrade)
              batch.set(doc(db, "households", hid, "members", state.user.uid), {
                uid: state.user.uid,
                role: "member",
                joinedAt: serverTimestamp()
              }, { merge: true });

              // Fetch household name
              const hhSnap = await getDoc(doc(db, "households", hid));
              const hhName = hhSnap.exists() ? (hhSnap.data().name || "Household") : "Household";

              batch.set(doc(db, "users", state.user.uid, "households", hid), {
                householdId: hid,
                householdName: hhName,
                role: "member",
                joinedAt: serverTimestamp()
              }, { merge: true });

              await batch.commit();
              toast("Joined household");
              await refreshUserHouseholdsAndSelect(hid);
            }
          }
        ]
      });
      setTimeout(()=> $("#inviteCode")?.focus(), 50);
    });

    // === Auth state listener ===
    
    // --- Household index hygiene ---
    // If a household is deleted from /households/{householdId} but a user's index doc
    // /users/{uid}/households/{householdId} is not cleaned up, it can "ghost" in the UI.
    // We prune these stale index docs client-side (best-effort) to keep the Account UI accurate.
    async function pruneStaleHouseholdIndex(uid, households){
      try{
        const ids = Array.from(new Set((households||[]).map(h=>h.householdId || h.id).filter(Boolean)));
        if(!ids.length) return;

        // We cannot query/list households under secure rules (list is typically blocked).
        // Instead, attempt a per-household get(). If it fails or the doc is missing, treat the index entry as stale.
        const stale = [];
        for(const hid of ids){
          try{
            const hs = await getDoc(doc(db, "households", hid));
            if(!hs.exists()) stale.push(hid);
          }catch(e){
            // If we can't read the household doc (e.g., it was deleted and membership no longer exists),
            // prune the user index entry anyway to prevent "ghost" households.
            stale.push(hid);
          }
        }

        if(!stale.length) return;

        // Delete stale user index docs (best-effort).
        for(const hid of stale){
          await deleteDoc(doc(db, "users", uid, "households", hid)).catch(()=>{});
        }

        // If the currently selected household is stale, clear selection immediately.
        if(state.selectedHouseholdId && stale.includes(state.selectedHouseholdId)){
          state.selectedHouseholdId = null;
          state.selectedHouseholdName = null;
          state.selectedRole = null;
          localStorage.removeItem("bb.selectedHouseholdId");
          setCurrentListId(null);
        }
      }catch(e){
        console.warn("Household index prune failed", e);
      }
    }

function scheduleHouseholdIndexPrune(uid){
      clearTimeout(state._pruneHouseholdsT);
      state._pruneHouseholdsT = setTimeout(()=>{
        if(state._pruningHouseholds) return;
        state._pruningHouseholds = true;
        pruneStaleHouseholdIndex(uid, state.households || [])
          .finally(()=>{ state._pruningHouseholds = false; });
      }, 400);
    }

function startHouseholdsListener(uid){
      state.unsubHouseholds?.();
      const colRef = collection(db, "users", uid, "households");
      const qy = query(colRef, orderBy("householdName", "asc"));
      state.unsubHouseholds = onSnapshot(qy, (snap)=>{
        state.households = snap.docs.map(d=>{
          const data = d.data();
          return { id: d.id, ...data, householdId: data.householdId || d.id };
        });
        renderHouseholds();
        scheduleHouseholdIndexPrune(uid);

        // If selected household no longer exists, clear selection.
        if(state.selectedHouseholdId && !state.households.some(h=>h.householdId===state.selectedHouseholdId)){
          state.selectedHouseholdId = null;
          state.selectedHouseholdName = null;
          state.selectedRole = null;
          localStorage.removeItem("bb.selectedHouseholdId");
          setCurrentListId(null);
        }

        // Auto-select the first household if none selected.
        if(!state.selectedHouseholdId && state.households.length){
          state.selectedHouseholdId = state.households[0].householdId;
          localStorage.setItem("bb.selectedHouseholdId", state.selectedHouseholdId);
        }

        // Refresh selected household name and load lists
        if(state.selectedHouseholdId){
          const idx = state.households.find(x=>x.householdId===state.selectedHouseholdId);
          state.selectedHouseholdName = idx?.householdName || state.selectedHouseholdName;
          state.selectedRole = idx?.role || state.selectedRole;
          loadSelectedHousehold();
        }else{
          cleanupHouseholdSubs();
          state.lists = [];
          renderLists();
          attachItemsListener();
          setSync("Sync • Choose a household", "warn");
        }
      }, (err)=>{
        console.error(err);
        setSync("Sync • Permission blocked", "bad");
      });
    }

    onAuthStateChanged(auth, (user)=>{
      state.user = user || null;

      if(!user){
        signedOutBlock.style.display = "block";
        signedInBlock.style.display = "none";
        authState.textContent = "Sign in to sync across devices.";
        setSync("Sync • Signed out", "bad");
        ctxHousehold.textContent = "—";
        ctxList.textContent = "—";
        state.households = [];
        renderHouseholds();
        cleanupHouseholdSubs();
        $("#hhList").style.display = "none";
        $("#hhEmpty").style.display = "block";
        $("#hhEmpty").textContent = "Sign in to see your households.";
        $("#listsEmpty").textContent = "Select a household to get started.";
        $("#listsWrap").style.display = "none";
        $("#listsEmpty").style.display = "block";
        return;
      }

      signedOutBlock.style.display = "none";
      signedInBlock.style.display = "block";
      userLabel.textContent = user.email || user.displayName || "Signed in";
      authState.textContent = "Signed in. Your changes sync in real time.";

      setSync("Sync • Loading…", "warn");
      startHouseholdsListener(user.uid);
    });

    // Initial default tab
    setTab("lists");

  </script>
</body>
</html>