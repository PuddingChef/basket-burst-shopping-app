<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#FF3D7F" />
  <title>BasketBurst</title>
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

  <style>
    :root{
      --pink:#FF3D7F;          /* Burst Pink */
      --purple:#6C2BFF;        /* Electric Purple */
      --aqua:#00D4FF;          /* Aqua Pop */
      --mango:#FFC542;         /* Sunny Mango */
      --mint:#2EE59D;          /* Mint Lift */
      --ink:#0F172A;           /* Ink text */
      --slate:#475569;         /* Secondary text */
      --cloud:#F6F7FB;         /* Background */
      --card:#FFFFFF;          /* Surface */
      --divider:#E6E8F0;
      --shadow: 0 10px 24px rgba(15,23,42,.08);
      --radius: 18px;
      --radius-sm: 14px;
      --tabbar-h: 72px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
      --tap: 44px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(0,212,255,.18), transparent 55%),
                  radial-gradient(1200px 800px at 90% 0%, rgba(255,61,127,.18), transparent 60%),
                  var(--cloud);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{color:inherit}
    button, input, select, textarea{font:inherit}
    .app{
      min-height:100%;
      padding-bottom: calc(var(--tabbar-h) + var(--safe-b));
    }
    /* Header */
    .header{
      position: sticky;
      top:0;
      z-index: 20;
      padding: calc(14px + var(--safe-t)) 14px 12px;
      backdrop-filter: blur(10px);
      background: linear-gradient(135deg, rgba(255,61,127,.92), rgba(108,43,255,.86));
      color: #fff;
      box-shadow: 0 8px 24px rgba(15,23,42,.12);
    }
    .header-row{display:flex; align-items:center; gap:10px;}
    .brand{
      display:flex; flex-direction:column; line-height:1.1;
      min-width:0;
    }
    .brand .name{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
    }
    .brand .tag{
      font-size: 12.5px;
      opacity: .9;
    }
    .pill{
      margin-left:auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.22);
      font-size: 12px;
      white-space: nowrap;
    }
    .dot{width:8px;height:8px;border-radius:50%;background: rgba(255,255,255,.85)}
    .pill.good .dot{background: var(--mint)}
    .pill.warn .dot{background: var(--mango)}
    .pill.bad  .dot{background: #ff7a7a}
    .context{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .context-card{
      flex:1;
      min-width: 150px;
      padding: 10px 12px;
      border-radius: var(--radius);
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
    }
    .context-card .k{font-size:11.5px;opacity:.85}
    .context-card .v{font-size:14px;font-weight:700;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    /* Main */
    .main{padding: 14px; max-width: 560px; margin: 0 auto;}
    .card{
      background: var(--card);
      border: 1px solid var(--divider);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 12px 0;
    }
    .card.flat{box-shadow:none}
    .row{display:flex; gap:10px; align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grow{flex:1; min-width:0}
    .h1{font-size:16px; font-weight:800; margin:0 0 6px}
    .muted{color:var(--slate); font-size:13px}
    .sep{height:1px; background: var(--divider); margin: 12px 0}
    .btn{
      appearance:none;
      border:none;
      border-radius: 999px;
      padding: 12px 14px;
      min-height: var(--tap);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-weight: 800;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 22px rgba(15,23,42,.10);
      transform: translateZ(0);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{background: linear-gradient(135deg, var(--pink), var(--purple)); color:#fff}
    .btn.secondary{background: rgba(108,43,255,.12); color: var(--purple); border:1px solid rgba(108,43,255,.18); box-shadow:none}
    .btn.ghost{background: transparent; color: var(--ink); border: 1px solid var(--divider); box-shadow:none}
    .btn.danger{background: rgba(255,61,127,.12); color: var(--pink); border:1px solid rgba(255,61,127,.18); box-shadow:none}
    .btn.small{padding:9px 12px; font-size: 13px}
    .input, .select{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--divider);
      padding: 12px 12px;
      min-height: var(--tap);
      outline: none;
      background:#fff;
    }
    .input:focus, .select:focus{border-color: rgba(108,43,255,.45); box-shadow: 0 0 0 4px rgba(108,43,255,.12)}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding: 8px 10px;border-radius:999px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(0,212,255,.10);
      font-weight: 700;
      font-size: 12.5px;
      color: var(--ink);
    }
    .chip .sw{width:10px;height:10px;border-radius:50%; background: var(--aqua)}
    .list{
      display:flex; flex-direction: column; gap:10px;
    }
    .item{
      display:flex; align-items:center; gap:10px;
      padding: 12px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--divider);
      background: #fff;
    }
    .item .title{font-weight:800}
    .item .sub{font-size:12.5px; color: var(--slate)}
    .badge{
      margin-left:auto;
      font-size: 12px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(46,229,157,.14);
      color: #0B3D2B;
      border: 1px solid rgba(46,229,157,.18);
      white-space: nowrap;
    }
    .badge.owner{background: rgba(255,197,66,.18); border-color: rgba(255,197,66,.22); color:#5B3A00}
    /* Panels */
    .panel{display:none}
    .panel.active{display:block}
    /* Bottom tabs */
    .tabbar{
      position: fixed;
      left:0; right:0; bottom:0;
      height: calc(var(--tabbar-h) + var(--safe-b));
      padding: 10px 12px calc(10px + var(--safe-b));
      background: rgba(246,247,251,.86);
      backdrop-filter: blur(14px);
      border-top: 1px solid rgba(15,23,42,.08);
      z-index: 30;
    }
    .tabs{
      max-width: 560px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
    }
    .tab{
      border:none;
      background: transparent;
      padding: 8px 6px;
      border-radius: 16px;
      min-height: 52px;
      cursor:pointer;
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 4px;
      color: var(--slate);
      transition: transform .12s ease, background .12s ease, color .12s ease;
    }
    .tab:active{transform: scale(.98)}
    .tab svg{width:22px;height:22px}
    .tab.active{
      background: rgba(108,43,255,.10);
      color: var(--purple);
    }
    .tab.active svg{filter: drop-shadow(0 8px 18px rgba(108,43,255,.18))}
    .tab .lbl{font-size: 11px; font-weight: 800}
    /* Modal */
    .modal-backdrop{
      position: fixed; inset:0;
      background: rgba(15,23,42,.42);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px 14px calc(18px + var(--safe-b));
      z-index: 40;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width: min(560px, 100%);
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 24px 60px rgba(15,23,42,.22);
      overflow:hidden;
      transform: translateY(14px);
      animation: slideUp .18s ease-out forwards;
    }
    @keyframes slideUp{
      to{transform: translateY(0)}
    }
    .modal .mhead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; gap:10px;
      border-bottom: 1px solid var(--divider);
      background: radial-gradient(900px 500px at 20% -30%, rgba(0,212,255,.14), transparent 60%),
                  radial-gradient(900px 500px at 90% -20%, rgba(255,61,127,.14), transparent 60%),
                  #fff;
    }
    .modal .mhead .mtitle{font-weight: 900}
    .modal .mbody{padding: 14px}
    .modal .mfoot{
      padding: 12px 14px 14px;
      display:flex; gap:10px;
      border-top: 1px solid var(--divider);
      background:#fff;
    }
    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--tabbar-h) + 12px + var(--safe-b));
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      gap:10px;
      align-items:center;
      z-index: 50;
      max-width: min(560px, calc(100% - 24px));
    }
    .toast.show{display:flex; animation: pop .16s ease-out}
    @keyframes pop{
      from{transform: translateX(-50%) scale(.98); opacity:.0}
      to{transform: translateX(-50%) scale(1); opacity:1}
    }
    .toast button{
      border:none; background: rgba(255,255,255,.14);
      color:#fff; padding: 8px 10px; border-radius: 12px; font-weight: 800;
      cursor:pointer;
    }
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; animation:none !important}
    }
  
    /* Household selection + manage */
    .hhRow{gap:10px}
    .hhRow.selected{
      outline: 2px solid var(--pink);
      box-shadow: 0 0 0 6px rgba(255,61,127,.08), var(--shadow);
    }
    .iconBtn{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--divider);
      background: rgba(255,255,255,.7);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
      box-shadow:none;
      padding:0;
    }
    .iconBtn:active{transform: scale(.96)}
    .iconBtn svg{width:18px;height:18px}
</style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="header-row">
        <div class="brand">
          <div class="name">BasketBurst</div>
          <div class="tag">A brighter way to shop.</div>
        </div>
        <div id="syncPill" class="pill warn" title="Sync status">
          <span class="dot"></span>
          <span id="syncText">Sync • Signed out</span>
        </div>
      </div>
      <div class="context">
        <div class="context-card">
          <div class="k">Household</div>
          <div id="ctxHousehold" class="v">—</div>
        </div>
        <div class="context-card">
          <div class="k">Current list</div>
          <div id="ctxList" class="v">—</div>
        </div>
      </div>
    </header>

    <main class="main">
      <!-- LISTS -->
      <section id="panel-lists" class="panel active">
        <div class="card">
          <div class="h1">Lists</div>
          <div class="muted">Weekly shop and any one-off lists you create.</div>
          <div class="sep"></div>
          <div id="listsEmpty" class="muted">Select a household to get started.</div>
          <div id="listsWrap" class="list" style="display:none"></div>
          <div class="sep"></div>
          <div class="row wrap">
            <button class="btn primary" id="btnNewList" type="button">New list</button>
            <button class="btn ghost" id="btnOpenWeekly" type="button">Open Weekly shop</button>
          </div>
        </div>
      </section>

      <!-- BUILD -->
      <section id="panel-build" class="panel">
        <div class="card">
          <div class="h1">Build</div>
          <div class="muted">Quick-add items, and keep your weekly template tidy.</div>
          <div class="sep"></div>
          <div class="muted">Coming next: quick add + categories + template editor.</div>
        </div>
      </section>

      <!-- MEALS -->
      <section id="panel-meals" class="panel">
        <div class="card">
          <div class="h1">Meals</div>
          <div class="muted">Store regular meals and add ingredients to your weekly shop.</div>
          <div class="sep"></div>
          <div class="muted">Coming next: meals library + evening calendar + merge into Weekly shop.</div>
        </div>
      </section>

      <!-- SHOP -->
      <section id="panel-shop" class="panel">
        <div class="card">
          <div class="h1">Shop</div>
          <div class="muted">Tick items off as you go. Capture cost and quantity to build your basket total.</div>
          <div class="sep"></div>
          <div class="muted">Coming next: shopping mode grouped by category + running basket total.</div>
        </div>
      </section>

      <!-- ACCOUNT -->
      <section id="panel-account" class="panel">
        <div class="card">
          <div class="h1">Account</div>
          <div id="authState" class="muted">Sign in to sync across devices.</div>
          <div class="sep"></div>

          <div id="signedOutBlock">
            <button class="btn primary" id="btnGoogle" type="button">
              <span>Continue with Google</span>
            </button>
          </div>

          <div id="signedInBlock" style="display:none">
            <div class="row wrap">
              <div class="chip" title="Signed in user">
                <span class="sw" style="background:var(--mint)"></span>
                <span id="userLabel">Signed in</span>
              </div>
              <button class="btn ghost small" id="btnSignOut" type="button">Sign out</button>
            </div>

            <div class="sep"></div>

            <div class="h1" style="font-size:15px">Households</div>
            <div class="muted">These are linked to your account and available on any device.</div>
            <div class="sep"></div>

            <div id="hhEmpty" class="muted">No households yet. Create one or join with an invite code.</div>
            <div id="hhList" class="list" style="display:none"></div>

            <div class="sep"></div>
            <div class="row wrap">
              <button class="btn primary" id="btnCreateHousehold" type="button">Create household</button>
              <button class="btn secondary" id="btnJoinHousehold" type="button">Join with code</button>
            </div>


<div class="sep"></div>
            <div class="h1" style="font-size:15px">Setup</div>
            <div class="muted">Categories and weekly template will live here (next).</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Bottom tabs -->
  <nav class="tabbar" aria-label="Primary">
    <div class="tabs">
      <button class="tab active" data-tab="lists" type="button" aria-label="Lists">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 6h14M7 12h14M7 18h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M3.5 6h.01M3.5 12h.01M3.5 18h.01" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
        </svg>
        <div class="lbl">Lists</div>
      </button>
      <button class="tab" data-tab="build" type="button" aria-label="Build">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <div class="lbl">Build</div>
      </button>
      <button class="tab" data-tab="meals" type="button" aria-label="Meals">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 4v8M10 4v8M7 8h3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M14 4c2 2 2 5 0 7v9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M5 20h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <div class="lbl">Meals</div>
      </button>
      <button class="tab" data-tab="shop" type="button" aria-label="Shop">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 7h15l-2 10H8L6 7Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M6 7 5 4H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M9 21a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM18 21a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" stroke="currentColor" stroke-width="2"/>
        </svg>
        <div class="lbl">Shop</div>
      </button>
      <button class="tab" data-tab="account" type="button" aria-label="Account">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Z" stroke="currentColor" stroke-width="2"/>
          <path d="M4 20c1.6-3.2 5-5 8-5s6.4 1.8 8 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <div class="lbl">Account</div>
      </button>
    </div>
  </nav>

  <!-- Modal -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="mhead">
        <div class="mtitle" id="modalTitle">Modal</div>
        <div class="grow"></div>
        <button class="btn ghost small" id="modalClose" type="button">Close</button>
      </div>
      <div class="mbody" id="modalBody"></div>
      <div class="mfoot" id="modalFoot"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <div id="toastText" class="grow"></div>
    <button id="toastBtn" type="button" style="display:none">Undo</button>
  </div>

  <script type="module">
    // Firebase (modular SDK)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, collection, serverTimestamp,
      onSnapshot, query, orderBy, where, limit, writeBatch, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // === Firebase config (provided by Rich) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDYuFW5jUL8JkL_RUPAz5Nv4AZ-Uui5C64",
      authDomain: "basketburst-shopping-app.firebaseapp.com",
      projectId: "basketburst-shopping-app",
      storageBucket: "basketburst-shopping-app.firebasestorage.app",
      messagingSenderId: "785037059249",
      appId: "1:785037059249:web:0a6c8e8fdb35ff8704ee90",
      measurementId: "G-35GZJSNMWN"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // === UI helpers ===
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    const syncPill = $("#syncPill");
    const syncText = $("#syncText");
    const ctxHousehold = $("#ctxHousehold");
    const ctxList = $("#ctxList");

    function setSync(text, kind="warn"){
      syncText.textContent = text;
      syncPill.classList.remove("good","warn","bad");
      syncPill.classList.add(kind);
    }

    // Toast
    let toastTimer = null;
    function toast(msg, {actionText=null, onAction=null, ms=2600}={}){
      const el = $("#toast");
      $("#toastText").textContent = msg;
      const btn = $("#toastBtn");
      btn.style.display = actionText ? "inline-flex" : "none";
      btn.textContent = actionText || "";
      btn.onclick = null;
      if(onAction) btn.onclick = ()=>{ try{onAction()}finally{hideToast()} };
      el.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(hideToast, ms);
    }
    function hideToast(){
      $("#toast").classList.remove("show");
      $("#toastBtn").onclick = null;
    }

    // Modal
    function showModal({title, body, footerButtons=[]}){
      $("#modalTitle").textContent = title || " ";
      const bodyEl = $("#modalBody");
      bodyEl.innerHTML = "";
      if(typeof body === "string"){
        bodyEl.innerHTML = body;
      }else if(body instanceof Node){
        bodyEl.appendChild(body);
      }
      const foot = $("#modalFoot");
      foot.innerHTML = "";
      for(const b of footerButtons){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn " + (b.className || "ghost");
        btn.textContent = b.label;
        btn.onclick = async ()=>{
          try{
            const res = await (b.onClick?.());
            if(res !== false) hideModal();
          }catch(e){
            console.error(e);
            toast(e?.message || "Something went wrong", {ms: 3200});
          }
        };
        foot.appendChild(btn);
      }
      $("#modalBackdrop").classList.add("show");
      $("#modalBackdrop").setAttribute("aria-hidden","false");
    }
    function hideModal(){
      $("#modalBackdrop").classList.remove("show");
      $("#modalBackdrop").setAttribute("aria-hidden","true");
          stopHouseholdSettingsListeners();
    }

    $("#modalClose").addEventListener("click", hideModal);
    $("#modalBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="modalBackdrop") hideModal(); });

    // Tabs
    function setTab(name){
      $$(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
      $$(".panel").forEach(p=>p.classList.remove("active"));
      $("#panel-"+name).classList.add("active");
    }
    $$(".tab").forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));

    // === App state ===
    const state = {
      user: null,
      households: [], // from users/{uid}/households
      selectedHouseholdId: localStorage.getItem("bb.selectedHouseholdId") || null,
      selectedHouseholdName: null,
      selectedRole: null,
      unsubHouseholds: null,
      unsubHouseholdDoc: null,
      unsubLists: null,
      lists: []
    };

    function setCtx(){
      ctxHousehold.textContent = state.selectedHouseholdName || "—";
      const currentList = state.lists.find(l=> l.id === getCurrentListId()) || null;
      ctxList.textContent = currentList ? currentList.name : "—";
    }

    function getCurrentListId(){
      return localStorage.getItem("bb.currentListId") || null;
    }
    function setCurrentListId(id){
      if(id) localStorage.setItem("bb.currentListId", id);
      else localStorage.removeItem("bb.currentListId");
      setCtx();
    }

    // === Auth UI ===
    const signedOutBlock = $("#signedOutBlock");
    const signedInBlock = $("#signedInBlock");
    const authState = $("#authState");
    const userLabel = $("#userLabel");

    $("#btnGoogle").addEventListener("click", async ()=>{
      const provider = new GoogleAuthProvider();
      setSync("Sync • Signing in…", "warn");
      await signInWithPopup(auth, provider);
    });

    $("#btnSignOut").addEventListener("click", async ()=>{
      await signOut(auth);
      toast("Signed out");
    });

    // === Firestore: households index ===
    function renderHouseholds(){
      const list = $("#hhList");
      const empty = $("#hhEmpty");
      list.innerHTML = "";

      if(!state.households.length){
        empty.style.display = "block";
        list.style.display = "none";
        return;
      }
      empty.style.display = "none";
      list.style.display = "flex";

      for(const h of state.households){
        const isSelected = h.householdId === state.selectedHouseholdId;
const el = document.createElement("div");
        el.className = "item hhRow" + (isSelected ? " selected" : "");
                const role = h.role || "member";

        el.innerHTML = `
          <div class="grow">
            <div class="title">${escapeHtml(h.householdName || "Household")}</div>
            <div class="sub">${escapeHtml(h.householdId)} • ${escapeHtml(role)}</div>
          </div>
          
          <button class="iconBtn" type="button" data-manage aria-label="Household settings" title="Household settings">
            <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 15.6a3.6 3.6 0 1 0 0-7.2 3.6 3.6 0 0 0 0 7.2Z" stroke="currentColor" stroke-width="2"/>
              <path d="M19.4 13.2a7.9 7.9 0 0 0 0-2.4l2-1.5-2-3.4-2.4.8a8.3 8.3 0 0 0-2.1-1.2L14.4 2h-4.8l-.5 2.5c-.7.3-1.4.7-2.1 1.2l-2.4-.8-2 3.4 2 1.5a7.9 7.9 0 0 0 0 2.4l-2 1.5 2 3.4 2.4-.8c.7.5 1.4.9 2.1 1.2l.5 2.5h4.8l.5-2.5c.7-.3 1.4-.7 2.1-1.2l2.4.8 2-3.4-2-1.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="badge ${role==="owner" ? "owner":""}">${role==="owner" ? "Owner" : "Member"}</div>
        
        `;
        el.addEventListener("click", ()=> selectHousehold(h.householdId, {silent:true}));
        el.querySelector("[data-manage]")?.addEventListener("click", (e)=>{ e.stopPropagation(); openHouseholdSettings(h.householdId); });
        list.appendChild(el);
      }
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    async function selectHousehold(hid, opts={}){
      state.selectedHouseholdId = hid;
      localStorage.setItem("bb.selectedHouseholdId", hid);
      setSync("Sync • Loading household…", "warn");
      await loadSelectedHousehold();
      renderHouseholds();
      if(!opts.silent) toast("Household selected");
    }

    async function openHouseholdSettings(hid){
      if(!state.user){
        toast("Please sign in first");
        setTab("account");
        return;
      }
      // Ensure selection is set, but keep the user on Account
      if(state.selectedHouseholdId !== hid){
        await selectHousehold(hid, {silent:true});
      }

      const role = state.selectedRole || "member";
      const hhName = state.selectedHouseholdName || "Household";

      // Clean up any previous settings listeners (if modal was left open somehow)
      stopHouseholdSettingsListeners();

      showModal({
        title: "Household settings",
        body: `
          <div class="card flat" style="margin:0">
            <div class="h1" style="margin:0">${escapeHtml(hhName)}</div>
            <div class="muted" style="margin-top:6px">${escapeHtml(hid)} • ${escapeHtml(role==="owner" ? "Owner" : "Member")}</div>
          </div>

          <div class="sep"></div>

          <div class="h1" style="font-size:15px">Members</div>
          <div class="muted">Who has access to this household.</div>
          <div class="sep"></div>
          <div id="hsMembersEmpty" class="muted">Loading members…</div>
          <div id="hsMembersList" class="list" style="display:none"></div>

          <div class="sep"></div>

          <div class="h1" style="font-size:15px">Invites</div>
          <div class="muted">Share a code so someone can join this household.</div>
          <div class="sep"></div>
          <div id="hsInvitesGuard" class="muted">Only the household owner can create invites.</div>
          <div id="hsInvitesBlock" style="display:none">
            <div id="hsInvitesEmpty" class="muted">No active invite codes.</div>
            <div id="hsInvitesList" class="list" style="display:none"></div>
            <div class="sep"></div>
            <div class="row wrap">
              <button class="btn primary" id="hsCreateInvite" type="button">Create invite code</button>
            </div>
          </div>
        `,
        footerButtons: [
          role==="owner"
            ? { label:"Close", className:"btn ghost" }
            : { label:"Leave household", className:"btn danger", onClick: async ()=>{
                showModal({
                  title: "Leave household?",
                  body: `<div class="muted">You will lose access to its lists, meals and settings.</div>`,
                  footerButtons: [
                    {label:"Cancel", className:"btn ghost"},
                    {label:"Leave", className:"btn danger", onClick: async ()=>{
                      setSync("Sync • Leaving household…", "warn");
                      await leaveHousehold(hid);
                      toast("Left household");
                    }}
                  ]
                });
                return false;
              }}
        ]
      });

      startHouseholdSettingsListeners(hid, role);
    }

    async function loadSelectedHousehold(){
      cleanupHouseholdSubs();
      state.selectedHouseholdName = null;
      state.selectedRole = null;
      state.lists = [];
      $("#listsWrap").style.display = "none";
      $("#listsEmpty").style.display = "block";
      $("#listsEmpty").textContent = "Loading lists…";
      setCtx();

      const hid = state.selectedHouseholdId;
      if(!state.user || !hid){
        setSync(state.user ? "Sync • Choose a household" : "Sync • Signed out", state.user ? "warn" : "bad");
        $("#listsEmpty").textContent = "Select a household to get started.";
        return;
      }

      // Find role/name from the per-user index (already in state.households)
      const idx = state.households.find(x=>x.householdId===hid) || null;
      state.selectedHouseholdName = idx?.householdName || "Household";
      state.selectedRole = idx?.role || "member";
      setCtx();

      // Listen to lists
      const listsQ = query(collection(db, "households", hid, "lists"), orderBy("pinned", "desc"), orderBy("updatedAt", "desc"));
      state.unsubLists = onSnapshot(listsQ, (snap)=>{
        state.lists = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderLists();
        setSync("Sync • Up to date", "good");
      }, (err)=>{
        console.error(err);
        setSync("Sync • Permission blocked", "bad");
        $("#listsEmpty").textContent = "Couldn’t load lists (permissions).";
      });
    }

    function cleanupHouseholdSubs(){
      if(state.unsubLists){ try{state.unsubLists()}catch{} state.unsubLists=null; }
    }

    // === Lists UI (baseline) ===
    function renderLists(){
      const wrap = $("#listsWrap");
      const empty = $("#listsEmpty");
      wrap.innerHTML = "";

      if(!state.selectedHouseholdId){
        empty.style.display = "block";
        wrap.style.display = "none";
        empty.textContent = "Select a household to get started.";
        setCtx();
        return;
      }

      if(!state.lists.length){
        empty.style.display = "block";
        wrap.style.display = "none";
        empty.textContent = "No lists yet. Create one, or open Weekly shop.";
        setCtx();
        return;
      }

      empty.style.display = "none";
      wrap.style.display = "flex";

      const currentId = getCurrentListId();

      for(const l of state.lists){
        const el = document.createElement("div");
        el.className = "item";
        const isCurrent = l.id === currentId;
        el.innerHTML = `
          <div class="grow">
            <div class="title">${escapeHtml(l.name || "List")}${isCurrent ? " • Current" : ""}</div>
            <div class="sub">${l.type==="weekly" ? "Weekly" : "Custom"}${l.archived ? " • Archived" : ""}</div>
          </div>
          <div class="badge">${l.type==="weekly" ? "Weekly" : "List"}</div>
        `;
        el.addEventListener("click", ()=>{
          setCurrentListId(l.id);
          toast("Current list set");
        });
        wrap.appendChild(el);
      }

      setCtx();
    }

    async function ensureWeeklyList(hid){
      // Find existing weekly list
      const existing = state.lists.find(l=>l.type==="weekly" && !l.archived);
      if(existing) return existing.id;

      setSync("Sync • Creating Weekly shop…", "warn");
      const ref = await addDoc(collection(db, "households", hid, "lists"), {
        name: "Weekly shop",
        type: "weekly",
        pinned: true,
        archived: false,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        createdByUid: state.user?.uid || null,
        updatedByUid: state.user?.uid || null
      });
      toast("Weekly shop created");
      return ref.id;
    }

    $("#btnOpenWeekly").addEventListener("click", async ()=>{
      if(!guardHousehold()) return;
      const weeklyId = await ensureWeeklyList(state.selectedHouseholdId);
      setCurrentListId(weeklyId);
      setTab("lists");

    });

    $("#btnNewList").addEventListener("click", async ()=>{
      if(!guardHousehold()) return;

      const body = document.createElement("div");
      body.innerHTML = `
        <div class="muted" style="margin-bottom:10px">Create a new list (e.g., Amazon, Party).</div>
        <label class="muted" for="newListName">List name</label>
        <input id="newListName" class="input" placeholder="e.g., Party" />
      `;
      showModal({
        title: "New list",
        body,
        footerButtons: [
          { label:"Cancel", className:"btn ghost", onClick: ()=>true },
          { label:"Create", className:"btn primary", onClick: async ()=>{
              const name = ($("#newListName")?.value || "").trim() || "New list";
              setSync("Sync • Creating list…", "warn");
              const ref = await addDoc(collection(db, "households", state.selectedHouseholdId, "lists"), {
                name,
                type: "custom",
                pinned: false,
                archived: false,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                createdByUid: state.user.uid,
                updatedByUid: state.user.uid
              });
              setCurrentListId(ref.id);
              toast("List created");
            }
          }
        ]
      });
      setTimeout(()=> $("#newListName")?.focus(), 50);
    });

    function guardHousehold(){
      if(!state.user){
        toast("Please sign in first");
        setTab("account");
        return false;
      }
      if(!state.selectedHouseholdId){
        toast("Select a household first");
        setTab("account");
        return false;
      }
      return true;
    }

    // === Household create/join (baseline) ===
    const DEFAULT_CATEGORIES = [
      "Fruit & Veg",
      "Meat & Fish",
      "Dairy",
      "Frozen",
      "Bakery",
      "Cereals & Breakfast",
      "Cupboard",
      "Treats & Snacks",
      "Drinks",
      "Cleaning Products",
      "Toiletries",
      "Pets",
      "Household",
      "Uncategorised"
    ];

    // === Invites (owner-only) ===
    let unsubInvites = null;

    function makeInviteCode(len=6){
      // Avoid ambiguous characters
      const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      const bytes = new Uint8Array(len);
      crypto.getRandomValues(bytes);
      let out = "";
      for(let i=0;i<len;i++){
        out += alphabet[bytes[i] % alphabet.length];
      }
      return out;
    }

    function stopInvitesListener(){
      if(unsubInvites){ try{unsubInvites()}catch{} }
      unsubInvites = null;
    }

    function setInvitesUIState(){
      const guard = $("#invitesGuard");
      const ownerOnly = $("#invitesOwnerOnly");
      const block = $("#invitesBlock");

      if(!guard || !ownerOnly || !block) return;

      if(!state.user){
        guard.style.display = "block";
        guard.textContent = "Sign in to manage invites.";
        ownerOnly.style.display = "none";
        block.style.display = "none";
        stopInvitesListener();
        return;
      }
      if(!state.selectedHouseholdId){
        guard.style.display = "block";
        guard.textContent = "Select a household to manage invites.";
        ownerOnly.style.display = "none";
        block.style.display = "none";
        stopInvitesListener();
        return;
      }
      guard.style.display = "none";

      if(state.selectedRole !== "owner"){
        ownerOnly.style.display = "block";
        block.style.display = "none";
        stopInvitesListener();
        return;
      }
      ownerOnly.style.display = "none";
      block.style.display = "block";
    }

    function startInvitesListener(){
      
      if(!(state.user && state.selectedHouseholdId && state.selectedRole==="owner")) return;

      stopInvitesListener();
      const qy = query(
        collection(db, "invites"),
        where("householdId", "==", state.selectedHouseholdId),
        where("active", "==", true),
        limit(10)
      );

      unsubInvites = onSnapshot(qy, (snap)=>{
        const invites = snap.docs.map(d=>({ code: d.id, ...d.data() }));
        renderInvites(invites);
      }, (err)=>{
        console.error(err);
        toast("Couldn’t load invites (permissions)", {ms: 3200});
      });
    }

    function renderInvites(invites){
      const list = $("#invitesList");
      const empty = $("#invitesEmpty");
      if(!list || !empty) return;

      list.innerHTML = "";

      if(!invites.length){
        empty.style.display = "block";
        list.style.display = "none";
        return;
      }
      empty.style.display = "none";
      list.style.display = "flex";

      invites.forEach(inv=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="grow">
            <div class="title">Invite code: ${escapeHtml(inv.code)}</div>
            <div class="sub">Active • Share this code to join</div>
          </div>
          <button class="btn secondary small" type="button" data-copy>Copy</button>
          <button class="btn danger small" type="button" data-deactivate>Disable</button>
        `;
        el.querySelector("[data-copy]").addEventListener("click", async (e)=>{
          e.stopPropagation();
          try{
            await navigator.clipboard.writeText(inv.code);
            toast("Invite code copied");
          }catch{
            toast("Couldn’t copy — you can select and copy manually", {ms: 3200});
          }
        });
        el.querySelector("[data-deactivate]").addEventListener("click", async (e)=>{
          e.stopPropagation();
          showModal({
            title: "Disable invite?",
            body: `<div class="muted">This code will stop working immediately.</div>`,
            footerButtons: [
              { label:"Cancel", className:"btn ghost" },
              { label:"Disable", className:"btn danger", onClick: async ()=>{
                  setSync("Sync • Updating invite…", "warn");
                  await updateDoc(doc(db, "invites", inv.code), { active: false });
                  toast("Invite disabled");
                }
              }
            ]
          });
        });
        list.appendChild(el);
      });
    }

    $("#btnCreateInvite")?.addEventListener("click", async ()=>{
      if(!(state.user && state.selectedHouseholdId)) { toast("Select a household first"); return; }
      if(state.selectedRole !== "owner"){ toast("Only the owner can create invites"); return; }

      setSync("Sync • Creating invite…", "warn");
      let code = null;
      for(let i=0;i<3;i++){
        const c = makeInviteCode(6);
        const snap = await getDoc(doc(db, "invites", c));
        if(!snap.exists()){ code = c; break; }
      }
      if(!code){ toast("Couldn’t generate a code — try again"); setSync("Sync • Up to date", "good"); return; }

      await setDoc(doc(db, "invites", code), {
        householdId: state.selectedHouseholdId,
        active: true,
        createdAt: serverTimestamp(),
        createdByUid: state.user.uid
      });

      showModal({
        title: "Invite code created",
        body: `
          <div class="muted" style="margin-bottom:10px">Share this code so someone can join your household.</div>
          <div class="card flat" style="margin:0; padding:12px; border-radius:14px; border:1px solid var(--divider);">
            <div style="font-weight:900; font-size:22px; letter-spacing:2px; text-align:center">${code}</div>
          </div>
          <div class="muted" style="margin-top:10px">Tip: codes can be disabled at any time.</div>
        `,
        footerButtons: [
          { label:"Copy", className:"btn primary", onClick: async ()=>{
              try{ await navigator.clipboard.writeText(code); toast("Invite code copied"); }catch{}
            }
          },
          { label:"Done", className:"btn ghost" }
        ]
      });
    });


    // === Household settings (modal) listeners ===
    let unsubHSMembers = null;
    let unsubHSInvites = null;

    function stopHouseholdSettingsListeners(){
      if(unsubHSMembers){ try{unsubHSMembers()}catch{} }
      if(unsubHSInvites){ try{unsubHSInvites()}catch{} }
      unsubHSMembers = null;
      unsubHSInvites = null;
    }

    async function removeMember(hid, memberUid){
      if(state.selectedRole !== "owner") throw new Error("Only the owner can manage members");
      if(memberUid === state.user?.uid) throw new Error("You can’t remove yourself");
      await deleteDoc(doc(db, "households", hid, "members", memberUid));
      // Best effort: remove their per-user index entry too
      try{ await deleteDoc(doc(db, "users", memberUid, "households", hid)); }catch{}
    }

    async function leaveHousehold(hid){
      if(!state.user) throw new Error("Not signed in");
      if(state.selectedRole === "owner") throw new Error("Owners can’t leave (transfer ownership first)");
      const uid = state.user.uid;
      await deleteDoc(doc(db, "households", hid, "members", uid));
      await deleteDoc(doc(db, "users", uid, "households", hid));

      if(state.selectedHouseholdId === hid){
        state.selectedHouseholdId = null;
        state.selectedHouseholdName = null;
        state.selectedRole = null;
        localStorage.removeItem("bb.selectedHouseholdId");
        setCurrentListId(null);
        cleanupHouseholdSubs();
        state.lists = [];
        renderLists();
        setCtx();
      }
      renderHouseholds();
    }

    function startHouseholdSettingsListeners(hid, role){
      stopHouseholdSettingsListeners();

      // Members
      const membersEmpty = $("#hsMembersEmpty");
      const membersList = $("#hsMembersList");

      unsubHSMembers = onSnapshot(collection(db, "households", hid, "members"), (snap)=>{
        const members = snap.docs.map(d=>({ uid: d.id, ...d.data() }));
        if(!membersEmpty || !membersList) return;
        membersList.innerHTML = "";

        if(!members.length){
          membersEmpty.style.display = "block";
          membersEmpty.textContent = "No members found.";
          membersList.style.display = "none";
          return;
        }

        membersEmpty.style.display = "none";
        membersList.style.display = "flex";

        for(const m of members){
          const isSelf = m.uid === state.user?.uid;
          const mRole = m.role || "member";
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="grow">
              <div class="title">${isSelf ? "You" : "Member"} <span class="muted" style="font-weight:700">(${escapeHtml(mRole)})</span></div>
              <div class="sub">${escapeHtml(m.uid)}</div>
            </div>
            ${role==="owner" && !isSelf ? `<button class="btn danger small" type="button" data-remove>Remove</button>` : ``}
          `;
          row.querySelector("[data-remove]")?.addEventListener("click", (e)=>{
            e.stopPropagation();
            showModal({
              title: "Remove member?",
              body: `<div class="muted">They will lose access to this household.</div>`,
              footerButtons: [
                {label:"Cancel", className:"btn ghost"},
                {label:"Remove", className:"btn danger", onClick: async ()=>{
                  setSync("Sync • Removing member…", "warn");
                  await removeMember(hid, m.uid);
                  toast("Member removed");
                }}
              ]
            });
          });
          membersList.appendChild(row);
        }
      }, (err)=>{
        console.error(err);
        if(membersEmpty) {
          membersEmpty.style.display = "block";
          membersEmpty.textContent = "Couldn’t load members (permissions).";
        }
        if(membersList) membersList.style.display = "none";
      });

      // Invites (owner only)
      const guard = $("#hsInvitesGuard");
      const block = $("#hsInvitesBlock");
      const list = $("#hsInvitesList");
      const empty = $("#hsInvitesEmpty");
      const btn = $("#hsCreateInvite");

      if(role !== "owner"){
        if(guard) guard.style.display = "block";
        if(block) block.style.display = "none";
        return;
      }
      if(guard) guard.style.display = "none";
      if(block) block.style.display = "block";

      const qy = query(
        collection(db, "invites"),
        where("householdId", "==", hid),
        where("active", "==", true),
        limit(10)
      );

      unsubHSInvites = onSnapshot(qy, (snap)=>{
        const invites = snap.docs.map(d=>({ code: d.id, ...d.data() }));
        if(!list || !empty) return;

        list.innerHTML = "";
        if(!invites.length){
          empty.style.display = "block";
          list.style.display = "none";
          return;
        }
        empty.style.display = "none";
        list.style.display = "flex";

        for(const inv of invites){
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div class="grow">
              <div class="title">Invite code: ${escapeHtml(inv.code)}</div>
              <div class="sub">Active • Share to join</div>
            </div>
            <button class="btn secondary small" type="button" data-copy>Copy</button>
            <button class="btn danger small" type="button" data-disable>Disable</button>
          `;
          row.querySelector("[data-copy]")?.addEventListener("click", async (e)=>{
            e.stopPropagation();
            try{
              await navigator.clipboard.writeText(inv.code);
              toast("Invite code copied");
            }catch{
              toast("Couldn’t copy — you can select and copy manually", {ms: 3200});
            }
          });
          row.querySelector("[data-disable]")?.addEventListener("click", (e)=>{
            e.stopPropagation();
            showModal({
              title: "Disable invite?",
              body: `<div class="muted">This code will stop working immediately.</div>`,
              footerButtons: [
                {label:"Cancel", className:"btn ghost"},
                {label:"Disable", className:"btn danger", onClick: async ()=>{
                  setSync("Sync • Updating invite…", "warn");
                  await updateDoc(doc(db, "invites", inv.code), { active:false });
                  toast("Invite disabled");
                }}
              ]
            });
          });
          list.appendChild(row);
        }
      }, (err)=>{
        console.error(err);
        toast("Couldn’t load invites (permissions)", {ms: 3200});
      });

      // Create invite button (bind once per modal open)
      btn?.addEventListener("click", async ()=>{
        if(state.selectedRole !== "owner"){ toast("Only the owner can create invites"); return; }

        setSync("Sync • Creating invite…", "warn");
        let code = null;
        for(let i=0;i<3;i++){
          const c = makeInviteCode(6);
          const snap = await getDoc(doc(db, "invites", c));
          if(!snap.exists()){ code = c; break; }
        }
        if(!code){ toast("Couldn’t generate a code — try again"); setSync("Sync • Up to date", "good"); return; }

        await setDoc(doc(db, "invites", code), {
          householdId: hid,
          active: true,
          createdAt: serverTimestamp(),
          createdByUid: state.user.uid
        });

        showModal({
          title: "Invite code created",
          body: `
            <div class="muted" style="margin-bottom:10px">Share this code so someone can join <b>${escapeHtml(state.selectedHouseholdName || "this household")}</b>.</div>
            <div class="card flat" style="margin:0; padding:12px; border-radius:14px; border:1px solid var(--divider);">
              <div style="font-weight:900; font-size:22px; letter-spacing:2px; text-align:center">${code}</div>
            </div>
          `,
          footerButtons: [
            {label:"Copy", className:"btn primary", onClick: async ()=>{ try{ await navigator.clipboard.writeText(code); toast("Invite code copied"); }catch{} }},
            {label:"Done", className:"btn ghost"}
          ]
        });
      }, { once:true });
    }





    $("#btnCreateHousehold").addEventListener("click", async ()=>{
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="muted" style="margin-bottom:10px">Create a shared household space for your lists.</div>
        <label class="muted" for="hhName">Household name</label>
        <input id="hhName" class="input" placeholder="e.g., The Kerrs" />
      `;
      showModal({
        title: "Create household",
        body,
        footerButtons: [
          { label:"Cancel", className:"btn ghost", onClick: ()=>true },
          { label:"Create", className:"btn primary", onClick: async ()=>{
              if(!state.user) return false;
              const name = ($("#hhName")?.value || "").trim() || "My household";
              setSync("Sync • Creating household…", "warn");

              // Create household doc
              const hid = crypto.randomUUID();
              const batch = writeBatch(db);

              batch.set(doc(db, "households", hid), {
                name,
                createdAt: serverTimestamp(),
                createdByUid: state.user.uid
              });

              // Member doc (owner)
              batch.set(doc(db, "households", hid, "members", state.user.uid), {
                uid: state.user.uid,
                role: "owner",
                joinedAt: serverTimestamp()
              });

              // Per-user index
              batch.set(doc(db, "users", state.user.uid, "households", hid), {
                householdId: hid,
                householdName: name,
                role: "owner",
                joinedAt: serverTimestamp()
              });

              // Seed categories (ordered)
              DEFAULT_CATEGORIES.forEach((cat, idx)=>{
                const cid = crypto.randomUUID();
                batch.set(doc(db, "households", hid, "categories", cid), {
                  name: cat,
                  order: idx,
                  archived: false,
                  createdAt: serverTimestamp(),
                  createdByUid: state.user.uid
                });
              });

              // Weekly template + settings placeholder
              batch.set(doc(db, "households", hid, "settings", "config"), {
                schemaVersion: 1,
                weeklyTemplate: [],
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                updatedByUid: state.user.uid
              }, { merge: true });

              // Create default Weekly shop list (pinned)
              const weeklyListId = crypto.randomUUID();
              batch.set(doc(db, "households", hid, "lists", weeklyListId), {
                name: "Weekly shop",
                type: "weekly",
                pinned: true,
                archived: false,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                createdByUid: state.user.uid,
                updatedByUid: state.user.uid
              });

              await batch.commit();

              toast("Household created");
              // Select it
              await refreshUserHouseholdsAndSelect(hid);
            }
          }
        ]
      });
      setTimeout(()=> $("#hhName")?.focus(), 50);
    });

    async function refreshUserHouseholdsAndSelect(hid){
      // The snapshot listener will pick it up shortly; we can preselect now.
      state.selectedHouseholdId = hid;
      localStorage.setItem("bb.selectedHouseholdId", hid);
      // Try to find name from existing array (may not yet include it)
      const found = state.households.find(x=>x.householdId===hid);
      state.selectedHouseholdName = found?.householdName || state.selectedHouseholdName;
      setCtx();
      await loadSelectedHousehold();
      setTab("lists");

    }

    $("#btnJoinHousehold").addEventListener("click", async ()=>{
      const body = document.createElement("div");
      body.innerHTML = `
        <div class="muted" style="margin-bottom:10px">Enter an invite code shared by the household owner.</div>
        <label class="muted" for="inviteCode">Invite code</label>
        <input id="inviteCode" class="input" placeholder="e.g., Q8K2J4" autocapitalize="characters" />
      `;
      showModal({
        title: "Join household",
        body,
        footerButtons: [
          { label:"Cancel", className:"btn ghost" },
          { label:"Join", className:"btn primary", onClick: async ()=>{
              if(!state.user) return false;
              const code = ($("#inviteCode")?.value || "").trim();
              if(!code){ toast("Enter a code"); return false; }

              setSync("Sync • Checking code…", "warn");
              const invRef = doc(db, "invites", code);
              const invSnap = await getDoc(invRef);
              if(!invSnap.exists()){ toast("Invalid code"); setSync("Sync • Up to date", "good"); return false; }
              const inv = invSnap.data();
              if(!inv.active){ toast("Invite is inactive"); setSync("Sync • Up to date", "good"); return false; }
              const hid = inv.householdId;

              // Create membership + index if missing
              const batch = writeBatch(db);

              // Member (member role by default; rules will prevent owner self-downgrade)
              batch.set(doc(db, "households", hid, "members", state.user.uid), {
                uid: state.user.uid,
                role: "member",
                joinedAt: serverTimestamp()
              }, { merge: true });

              // Fetch household name
              const hhSnap = await getDoc(doc(db, "households", hid));
              const hhName = hhSnap.exists() ? (hhSnap.data().name || "Household") : "Household";

              batch.set(doc(db, "users", state.user.uid, "households", hid), {
                householdId: hid,
                householdName: hhName,
                role: "member",
                joinedAt: serverTimestamp()
              }, { merge: true });

              await batch.commit();
              toast("Joined household");
              await refreshUserHouseholdsAndSelect(hid);
            }
          }
        ]
      });
      setTimeout(()=> $("#inviteCode")?.focus(), 50);
    });

    // === Auth state listener ===
    function startHouseholdsListener(uid){
      state.unsubHouseholds?.();
      const colRef = collection(db, "users", uid, "households");
      const qy = query(colRef, orderBy("householdName", "asc"));
      state.unsubHouseholds = onSnapshot(qy, (snap)=>{
        state.households = snap.docs.map(d=>{
          const data = d.data();
          return { id: d.id, ...data, householdId: data.householdId || d.id };
        });
        renderHouseholds();

        // If selected household no longer exists, clear selection.
        if(state.selectedHouseholdId && !state.households.some(h=>h.householdId===state.selectedHouseholdId)){
          state.selectedHouseholdId = null;
          state.selectedHouseholdName = null;
          state.selectedRole = null;
          localStorage.removeItem("bb.selectedHouseholdId");
          setCurrentListId(null);
        }

        // Auto-select the first household if none selected.
        if(!state.selectedHouseholdId && state.households.length){
          state.selectedHouseholdId = state.households[0].householdId;
          localStorage.setItem("bb.selectedHouseholdId", state.selectedHouseholdId);
        }

        // Refresh selected household name and load lists
        if(state.selectedHouseholdId){
          const idx = state.households.find(x=>x.householdId===state.selectedHouseholdId);
          state.selectedHouseholdName = idx?.householdName || state.selectedHouseholdName;
          state.selectedRole = idx?.role || state.selectedRole;
          loadSelectedHousehold();
        }else{
          cleanupHouseholdSubs();
          state.lists = [];
          renderLists();
          setSync("Sync • Choose a household", "warn");
        }
      }, (err)=>{
        console.error(err);
        setSync("Sync • Permission blocked", "bad");
      });
    }

    onAuthStateChanged(auth, (user)=>{
      state.user = user || null;

      if(!user){
        signedOutBlock.style.display = "block";
        signedInBlock.style.display = "none";
        authState.textContent = "Sign in to sync across devices.";
        setSync("Sync • Signed out", "bad");
        ctxHousehold.textContent = "—";
        ctxList.textContent = "—";
        state.households = [];
        renderHouseholds();
        cleanupHouseholdSubs();
        $("#hhList").style.display = "none";
        $("#hhEmpty").style.display = "block";
        $("#hhEmpty").textContent = "Sign in to see your households.";
        $("#listsEmpty").textContent = "Select a household to get started.";
        $("#listsWrap").style.display = "none";
        $("#listsEmpty").style.display = "block";
        return;
      }

      signedOutBlock.style.display = "none";
      signedInBlock.style.display = "block";
      userLabel.textContent = user.email || user.displayName || "Signed in";
      authState.textContent = "Signed in. Your changes sync in real time.";

      setSync("Sync • Loading…", "warn");
      startHouseholdsListener(user.uid);
    });

    // Initial default tab
    setTab("lists");

  
    // PWA: service worker (app shell cache)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch((e) => console.warn("SW registration failed", e));
      });
    }

  </script>
</body>
</html>
